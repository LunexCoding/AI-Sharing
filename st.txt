<local:BaseCustomWindow x:Class="OrderApprovalSystem.Views.Main"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:ribbon="clr-namespace:System.Windows.Controls.Ribbon;assembly=System.Windows.Controls.Ribbon"
        xmlns:local="clr-namespace:OrderApprovalSystem.Views"
        xmlns:vm="clr-namespace:OrderApprovalSystem.ViewModels"
        xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
        xmlns:converters="clr-namespace:OrderApprovalSystem.Converters"
        Title="OrderApprovalSystem" 
        Height="700" Width="1500"
        Background="{DynamicResource PrimaryBackgroundBrush}"
        Foreground="{DynamicResource TextBrush}">

    <Window.Resources>
        <!-- Конвертер Boolean to Visibility -->
        <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />

        <DataTemplate DataType="{x:Type vm:vmDev}">
            <local:Dev />
        </DataTemplate>
        <DataTemplate DataType="{x:Type vm:vmSubTechnologist}">
            <local:SubTechnologist />
        </DataTemplate>
        <DataTemplate DataType="{x:Type vm:vmGuest}">
            <local:Guest />
        </DataTemplate>
        <DataTemplate DataType="{x:Type vm:vmOrderManager}">
            <local:OrderManager />
        </DataTemplate>
        <DataTemplate DataType="{x:Type vm:vmHeadOrderDepartment}">
            <local:HeadOrderDepartment />
        </DataTemplate>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Общий Ribbon для всех режимов -->
        <ribbon:Ribbon x:Name="MainRibbon" Style="{StaticResource ModernRibbonStyle}" Grid.Row="1">

            <i:Interaction.Behaviors>
                <local:RibbonTabBehavior CurrentViewModel="{Binding CurrentViewModel}"/>
            </i:Interaction.Behaviors>

            <!-- Скрываем/показываем ApplicationMenu в зависимости от роли -->
            <ribbon:Ribbon.ApplicationMenu>
                <ribbon:RibbonApplicationMenu 
                    SmallImageSource="https://cdn-icons-png.flaticon.com/512/2311/2311523.png"
                    Visibility="{Binding IsBurgerMenuVisible, Converter={StaticResource BooleanToVisibilityConverter}}">

                    <ribbon:RibbonApplicationMenuItem Header="Режим разработчика" 
                                           Command="{Binding pSwitchToDevCommand}"
                                           Visibility="{Binding IsDevMenuVisible, Converter={StaticResource BooleanToVisibilityConverter}}"/>

                    <ribbon:RibbonApplicationMenuItem Header="Режим технолога" 
                                           Command="{Binding pSwitchToSubTechnologistCommand}"
                                           Visibility="{Binding IsSubTechnologistMenuVisible, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                    <ribbon:RibbonApplicationMenuItem Header="Режим менеджера заказов" 
                       Command="{Binding pSwitchToOrderManagerCommand}"
                       Visibility="{Binding IsOrderManagerMenuVisible, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                </ribbon:RibbonApplicationMenu>
            </ribbon:Ribbon.ApplicationMenu>

            <!-- Статические вкладки -->
            <ribbon:RibbonTab Header="ВИД">
                <ribbon:RibbonGroup Header="Оформление">
                    <ribbon:RibbonToggleButton Label="Темная тема"
                                                IsChecked="{Binding IsDarkTheme}"/>
                </ribbon:RibbonGroup>
            </ribbon:RibbonTab>

        </ribbon:Ribbon>

        <!-- Основной контент -->
        <ContentControl Grid.Row="2" Content="{Binding CurrentViewModel, Mode=OneWay}"/>

    </Grid>
</local:BaseCustomWindow>

using System;
using System.ComponentModel;
using System.Windows;
using System.Windows.Input;
using Fox;
using OrderApprovalSystem.Core;
using OrderApprovalSystem.Core.Settings;
using OrderApprovalSystem.Models;
using OrderApprovalSystem.Services;
using OrderApprovalSystem.Views;

namespace OrderApprovalSystem.ViewModels
{
    internal class vmMain : VMBase
    {
        public Main View;
        public mMain Model;

        #region Инициализация

        public vmMain()
        {
            // Инициализация команд
            _switchToDevCommand = new RelayCommand(
                () => NavigateTo<vmDev>(),
                () => AccessManager.CanAccessView("Dev")
            );

            _switchToSubTechnologistCommand = new RelayCommand(
                () => NavigateTo<vmSubTechnologist>(),
                () => AccessManager.CanAccessView("SubTechnologist")
            );

            _switchToOrderManagerCommand = new RelayCommand(
               () => NavigateTo<vmOrderManager>(),
               () => AccessManager.CanAccessView("OrderManager")
           );

            _switchToHeadOrderDepartmentCommand = new RelayCommand(
               () => NavigateTo<vmHeadOrderDepartment>(),
               () => AccessManager.CanAccessView("HeadOrderDepartment")
           );

            // Подписываемся на изменение пользователя
            RoleManager.UserChanged += OnUserChanged;
        }

        public void viewLoaded(object _sender, RoutedEventArgs _routedEventArgs)
        {
            View = (Main)view;
            Model = (mMain)model;

            Model.PropertyChanged += modelPropertyChangedHandler;

            UpdateThemeProperties();
            ThemeManager.ThemeManagerService.Instance.ThemeChanged += OnThemeChanged;

            // Загружаем начальное представление на основе ролей пользователя
            LoadInitialView();
        }

        private void LoadInitialView()
        {
            // Проверяем, есть ли у пользователя реальные роли (кроме Guest)
            if (!AccessManager.HasAnyRealRole())
            {
                ShowGuestView();
                return;
            }

            // Определяем доступное начальное представление
            if (AccessManager.CanAccessView("Dev"))
            {
                NavigateTo<vmDev>();
            }
            else if (AccessManager.CanAccessView("SubTechnologist"))
            {
                NavigateTo<vmSubTechnologist>();
            }
            else if (AccessManager.CanAccessView("OrderManager"))
            {
                NavigateTo<vmOrderManager>();
            }
            else if (AccessManager.CanAccessView("HeadOrderDepartment"))
            {
                NavigateTo<vmHeadOrderDepartment>();
            }
            else
            {
                // Если нет доступа ни к одному представлению
                ShowGuestView();
            }
        }

        private void ShowGuestView()
        {
            // Показываем представление "Нет доступа"
            CurrentViewModel = new vmGuest { model = new mGuest() };
            Model.pCurrentViewName = "Гость";

            // Обновляем состояния команд
            UpdateCommandStates();
        }

        private void OnUserChanged(object sender, EventArgs e)
        {
            // При изменении пользователя обновляем UI
            LoadInitialView();
            UpdateCommandStates();

            // Уведомляем UI об изменении свойств
            OnPropertyChanged(nameof(IsDevMenuVisible));
            OnPropertyChanged(nameof(IsSubTechnologistMenuVisible));
            OnPropertyChanged(nameof(IsBurgerMenuVisible));
            OnPropertyChanged(nameof(IsGuest));
            OnPropertyChanged(nameof(CurrentUserName));
        }

        private void UpdateCommandStates()
        {
            _switchToDevCommand.RaiseCanExecuteChanged();
            _switchToSubTechnologistCommand.RaiseCanExecuteChanged();

            // Уведомляем UI об изменении свойств видимости меню
            OnPropertyChanged(nameof(IsDevMenuVisible));
            OnPropertyChanged(nameof(IsSubTechnologistMenuVisible));
        }

        #endregion Инициализация

        #region Свойства для меню навигации и информации о пользователе

        // Свойства, определяющие, доступны ли пункты меню
        public bool IsDevMenuVisible => AccessManager.CanAccessView("Dev");
        public bool IsSubTechnologistMenuVisible => AccessManager.CanAccessView("SubTechnologist");
        public bool IsOrderManagerMenuVisible => AccessManager.CanAccessView("OrderManager");
        public bool IsBurgerMenuVisible => RoleManager.CurrentUser.Roles.Contains(UserRole.Dev);

        // Проверка, является ли текущий пользователь гостем
        public bool IsGuest => RoleManager.IsGuest;

        // Имя текущего пользователя
        public string CurrentUserName => RoleManager.CurrentUser.Name;

        #endregion

        #region Команды навигации в ApplicationMenu

        private readonly RelayCommand _switchToDevCommand;
        private readonly RelayCommand _switchToSubTechnologistCommand;
        private readonly RelayCommand _switchToOrderManagerCommand;
        private readonly RelayCommand _switchToHeadOrderDepartmentCommand;

        public ICommand pSwitchToDevCommand => _switchToDevCommand;
        public ICommand pSwitchToSubTechnologistCommand => _switchToSubTechnologistCommand;
        public ICommand pSwitchToOrderManagerCommand => _switchToOrderManagerCommand;
        public ICommand pSwitchToHeadOrderDepartmentCommand => _switchToHeadOrderDepartmentCommand;

        #endregion Команды навигации в ApplicationMenu

        /// <summary>
        /// Переключает контент в основном окне с проверкой доступа
        /// </summary>
        public void NavigateTo<T>() where T : VMBase, new()
        {
            // Проверяем, есть ли у пользователя реальные роли
            if (!AccessManager.HasAnyRealRole())
            {
                DialogService.ShowError("У вас нет назначенных ролей. Обратитесь к администратору.");
                ShowGuestView();
                return;
            }

            // Проверяем доступ перед навигацией
            if (!AccessManager.CanAccessViewModel<T>())
            {
                DialogService.ShowError("У вас нет доступа к этому представлению.");
                return;
            }

            // Создаем и инициализируем ViewModel
            VMBase newViewModel = null;
            string viewName = string.Empty;

            if (typeof(T) == typeof(vmDev))
            {
                if (!AccessManager.CanAccessView("Dev"))
                {
                    DialogService.ShowError("Нет доступа к представлению Разработчик");
                    return;
                }

                newViewModel = new vmDev { model = new mDev() };
                viewName = "Разработчик";
            }
            else if (typeof(T) == typeof(vmSubTechnologist))
            {
                if (!AccessManager.CanAccessView("SubTechnologist"))
                {
                    DialogService.ShowError("Нет доступа к представлению Технолог");
                    return;
                }

                newViewModel = new vmSubTechnologist { model = new mSubTechnologist(), view = new SubTechnologist() };
                viewName = "Технолог";
            }

            else if (typeof(T) == typeof(vmOrderManager))
            {
                if (!AccessManager.CanAccessView("OrderManager"))
                {
                    DialogService.ShowError("Нет доступа к представлению Менеджер заказов");
                    return;
                }

                newViewModel = new vmOrderManager { model = new mOrderManager(), view = new OrderManager() };
                viewName = "Менеджер заказов";
            }

            else if (typeof(T) == typeof(vmHeadOrderDepartment))
            {
                if (!AccessManager.CanAccessView("HeadOrderDepartment"))
                {
                    DialogService.ShowError("Нет доступа к представлению HeadOrderDepartment");
                    return;
                }

                newViewModel = new vmHeadOrderDepartment { model = new mHeadOrderDepartment(), view = new HeadOrderDepartment() };
                viewName = "HeadOrderDepartment";
            }

            if (newViewModel != null)
            {
                CurrentViewModel = newViewModel;
                Model.pCurrentViewName = viewName;

                // Обновляем состояния команд после навигации
                UpdateCommandStates();
            }
        }

        #region Свойства

        public VMBase CurrentViewModel
        {
            get => _currentViewModel;
            set
            {
                _currentViewModel = value;
                OnPropertyChanged(nameof(CurrentViewModel));
            }
        }

        public bool IsDarkTheme
        {
            get { return isDarkTheme; }
            set
            {
                if (isDarkTheme != value)
                {
                    AppThemeManager.NextTheme();
                }
            }
        }

        #endregion Свойства

        private bool isDarkTheme;
        private VMBase _currentViewModel;

        private void OnThemeChanged(string themeName)
        {
            UpdateThemeProperties();
            AppSettingsManager.Current.Theme = themeName;
            AppSettingsManager.SaveSettings();
        }

        private void UpdateThemeProperties()
        {
            isDarkTheme = ThemeManager.ThemeManagerService.Instance.IsDarkTheme;
            OnPropertyChanged(nameof(IsDarkTheme));
        }

        // Обработчик изменений свойств модели
        public void modelPropertyChangedHandler(object _sender, PropertyChangedEventArgs _eventArgs)
        {
            switch (_eventArgs.PropertyName)
            {
                // Если нужно обрабатывать изменения конкретных свойств модели
                default:
                    // Общая обработка
                    break;
            }
        }

        /// <summary>
        /// Метод для обновления состояний всех команд при изменении ролей пользователя
        /// </summary>
        public void RefreshUserAccess()
        {
            UpdateCommandStates();

            // Если текущее представление стало недоступно, переключаемся на доступное
            if (CurrentViewModel != null)
            {
                var currentViewModelType = CurrentViewModel.GetType();

                if (currentViewModelType == typeof(vmDev) && !AccessManager.CanAccessView("Dev"))
                {
                    LoadInitialView();
                }
                else if (currentViewModelType == typeof(vmSubTechnologist) && !AccessManager.CanAccessView("SubTechnologist"))
                {
                    LoadInitialView();
                }
                else if (currentViewModelType == typeof(vmOrderManager) && !AccessManager.CanAccessView("OrderManager"))
                {
                    LoadInitialView();
                }
                else if (currentViewModelType == typeof(vmHeadOrderDepartment) && !AccessManager.CanAccessView("HeadOrderDepartment"))
                {
                    LoadInitialView();
                }
            }
        }
    }
}

using Fox;


namespace OrderApprovalSystem.Models
{

    public class mMain : MBase
    {
        /// <summary>
        /// Конструктор
        /// </summary>
        public mMain()
        {
            pCurrentViewName = "Dev"; // Начальное представление
        }

        #region Свойства

        /// <summary>
        /// Имя текущего представления
        /// </summary>
        public string pCurrentViewName
        {
            get { return _currentViewName; }
            set
            {
                _currentViewName = value;
                OnPropertyChanged("pCurrentViewName");
            }
        }

        #endregion Свойства

        #region Переменные

        /// <summary>
        /// Текущее активное представление
        /// </summary>
        private string _currentViewName;

        #endregion Переменные
    }

}

using System.Windows;
using System.Windows.Controls.Ribbon;
using System.Windows.Media;
using System.Windows.Data;
using System.Windows.Controls;

using Microsoft.Xaml.Behaviors;

using Fox;

using OrderApprovalSystem.ViewModels;


namespace OrderApprovalSystem.Views
{

    public class RibbonTabBehavior : Behavior<Ribbon>
    {
        public static readonly DependencyProperty CurrentViewModelProperty = DependencyProperty.Register(
            "CurrentViewModel",
            typeof(VMBase),
            typeof(RibbonTabBehavior),
            new PropertyMetadata(null, OnCurrentViewModelChanged)
        );

        public VMBase CurrentViewModel
        {
            get { return (VMBase)GetValue(CurrentViewModelProperty); }
            set { SetValue(CurrentViewModelProperty, value); }
        }

        protected override void OnAttached()
        {
            base.OnAttached();
            UpdateRibbonTab();
        }

        private RibbonTab _dynamicTab;

        private static void OnCurrentViewModelChanged(DependencyObject d, DependencyPropertyChangedEventArgs e)
        {
            var behavior = (RibbonTabBehavior)d;
            behavior.UpdateRibbonTab();
        }

        private void UpdateRibbonTab()
        {
            if (AssociatedObject == null)
                return;

            // Удаляем старую вкладку
            if (_dynamicTab != null)
            {
                AssociatedObject.Items.Remove(_dynamicTab);
                _dynamicTab = null;
            }

            if (CurrentViewModel == null)
            {
                return;
            }

            // Создаем новую вкладку
            _dynamicTab = CreateTabForViewModel(CurrentViewModel);
            if (_dynamicTab != null)
            {
                // Вставляем первой вкладкой (после ApplicationMenu)
                AssociatedObject.Items.Insert(0, _dynamicTab);
                _dynamicTab.IsSelected = true;
            }


        }

        private RibbonTab CreateTabForViewModel(VMBase viewModel)
        {
            if (viewModel is vmDev vmDev)
            {
                RibbonTab tab = new RibbonTab { Header = "РАЗРАБОТКА", DataContext = vmDev };
                RibbonGroup toolsGroup = new RibbonGroup { Header = "Инструменты" };
                tab.Items.Add(toolsGroup);

                return tab;
            }
            else if (viewModel is vmSubTechnologist vmSubTech)
            {

                //RibbonGroup OrderNavigationGroup = new RibbonGroup { Header = "Навигация по заказам" };
                //OrderNavigationGroup.Items.Add(
                //    new RibbonButton
                //    {
                //        Label = "Предыдущий",
                //        Command = vmSubTech.NavigatePreviousGroupCommand
                //    }
                //);
                //OrderNavigationGroup.Items.Add(
                //    new RibbonButton
                //    {
                //        Label = "Следующий",
                //        Command = vmSubTech.NavigateNextGroupCommand
                //    }
                //);
                //tab.Items.Add(OrderNavigationGroup);

                return CreateApprovalTab(vmSubTech);
            }
            else if (viewModel is vmHeadOrderDepartment vmHeadOrderDep)
            {
                return CreateApprovalTab(vmHeadOrderDep);
            }
            else if (viewModel is vmOrderManager vmOrderManager)
            {
                RibbonTab tab = CreateApprovalTab(vmOrderManager);
                RibbonGroup orderGroup = new RibbonGroup { Header = "Заказ" };
                orderGroup.Items.Add(
                    new RibbonButton
                    {
                        Label = "По СЗ",
                        Command = vmOrderManager.pOrderByMemoCommand,
                        LargeImageSource = CreateCheckIcon()
                    }
                );
                tab.Items.Add(orderGroup);
                return tab;
            }

            return null;
        }

        private RibbonTab CreateApprovalTab(dynamic viewModel)
        {
            RibbonTab tab = new RibbonTab { Header = "Согласование", DataContext = viewModel };

            RibbonGroup approveGroup = new RibbonGroup { Header = "Согласование" };
            approveGroup.Items.Add(
                new RibbonButton
                {
                    Label = "Согласовать",
                    Command = viewModel.pApprovalOrderCommand,
                    LargeImageSource = CreateCheckIcon()
                }
            );
            approveGroup.Items.Add(
                new RibbonButton
                {
                    Label = "Не согласовывать",
                    Command = viewModel.pRejectOrderCommand,
                    LargeImageSource = CreateCrossIcon()
                }
            );
            approveGroup.Items.Add(
                new RibbonButton
                {
                    Label = "История согласования",
                    Command = viewModel.pRejectOrderCommand,
                    LargeImageSource = CreateHistoryIcon()
                }
            );
            tab.Items.Add(approveGroup);

            RibbonGroup searchGroup = new RibbonGroup { Header = "Поиск" };
            RibbonTextBox searchBox = new RibbonTextBox
            {
                Label = "Заказ:",
                Width = 200,
                TextBoxWidth = 140
            };
            searchBox.Style = (Style)Application.Current.FindResource(typeof(TextBox));

            Binding textBinding = new Binding("SearchText");
            textBinding.Source = viewModel;
            textBinding.UpdateSourceTrigger = UpdateSourceTrigger.PropertyChanged;
            textBinding.Mode = BindingMode.TwoWay;
            BindingOperations.SetBinding(searchBox, RibbonTextBox.TextProperty, textBinding);

            searchGroup.Items.Add(searchBox);
            tab.Items.Add(searchGroup);

            return tab;
        }


        // Вспомогательный метод для создания ImageSource из Geometry
        private ImageSource CreateGeometryImageSource(string geometryData, Brush brush, double width, double height)
        {
            Geometry geometry = Geometry.Parse(geometryData);
            GeometryDrawing drawing = new GeometryDrawing(brush, null, geometry);
            DrawingImage drawingImage = new DrawingImage(drawing);
            drawingImage.Freeze();
            return drawingImage;
        }

        private ImageSource CreateCheckIcon()
        {
            return CreateGeometryImageSource(
                "M9 16.17L4.83 12L3.41 13.41L9 19L21 7L19.59 5.59L9 16.17Z",
                Brushes.Green,
                32, 32
            );
        }

        // Метод для создания иконки крестика
        private ImageSource CreateCrossIcon()
        {
            return CreateGeometryImageSource(
                "M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12L19 6.41Z",
                Brushes.Red,
                32, 32
            );
        }

        private ImageSource CreateHistoryIcon()
        {
            // Данные геометрии: круг часов и стрелки
            return CreateGeometryImageSource(
                "M13,3A9,9 0 0,0 4,12H1L4.89,15.89L4.96,16.03L9,12H6A7,7 0 0,1 13,5A7,7 0 0,1 20,12A7,7 0 0,1 13,19C11.07,19 9.32,18.21 8.06,16.94L6.64,18.36C8.27,20 10.5,21 13,21A9,9 0 0,0 22,12A9,9 0 0,0 13,3M12,8V13L16.28,15.54L17,14.33L13.5,12.25V8H12Z",
                (Brush)Application.Current.Resources["TextBrush"],
                32, 32
            );
        }

    }

}

<UserControl x:Class="OrderApprovalSystem.Views.SubTechnologist"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:ribbon="clr-namespace:System.Windows.Controls.Ribbon;assembly=System.Windows.Controls.Ribbon"
        xmlns:local="clr-namespace:OrderApprovalSystem.Views"
        xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
        xmlns:behaviors="clr-namespace:OrderApprovalSystem.Behaviors"
        Background="{DynamicResource PrimaryBackgroundBrush}"
        Foreground="{DynamicResource TextBrush}">

    <i:Interaction.Triggers>
        <i:EventTrigger EventName="Loaded">
            <i:CallMethodAction TargetObject="{Binding}" MethodName="viewLoaded"/>
        </i:EventTrigger>
    </i:Interaction.Triggers>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="0.35*"/>
            <ColumnDefinition Width="0.3*"/>
            <ColumnDefinition Width="0.35*"/>
        </Grid.ColumnDefinitions>

        <Border Grid.Column="0" 
                Margin="5" 
                BorderThickness="2" 
                BorderBrush="{DynamicResource AccentBrush}" 
                Background="{DynamicResource SecondaryBackgroundBrush}"
                CornerRadius="4">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Заголовок таблицы -->
                <Border Grid.Row="0"
                        Background="{DynamicResource AccentBrush}"
                        CornerRadius="2,2,0,0"
                        Padding="10">
                    <TextBlock Text="Технологические заказы"
                               Foreground="White"
                               FontSize="14"
                               FontWeight="Bold"
                               HorizontalAlignment="Center"/>
                </Border>

                <!-- DataGrid с группами заказов -->
                <DataGrid Grid.Row="1"
                          IsReadOnly="True"
                          AutoGenerateColumns="False"
                          SelectionMode="Single"
                          HeadersVisibility="Column"
                          HorizontalScrollBarVisibility="Disabled"
                          CanUserAddRows="False"
                          x:Name="dgReport" 
                          ItemsSource="{Binding model.GroupedData}" 
                          SelectedItem="{Binding model.CurrentGroup, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">

                    <i:Interaction.Behaviors>
                        <behaviors:ScrollIntoViewBehavior SelectedItem="{Binding model.CurrentGroup, Mode=OneWay}"/>
                    </i:Interaction.Behaviors>

                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Заказ" 
                                            Binding="{Binding Zak1}" 
                                            Width="80"/>
                        <DataGridTextColumn Header="Кол-во чертежей в заказе" 
                                            Binding="{Binding Items.Count}" 
                                            Width="100"/>
                        <DataGridTextColumn Header="Дата" 
                                            Binding="{Binding Items[0].OpenAtByTechnologist, StringFormat=\{0:dd.MM.yyyy\}}" 
                                            Width="Auto"/>
                        <DataGridTextColumn Header="Чертеж" 
                                            Binding="{Binding Items[0].Draft}" 
                                            Width="Auto"/>
                        <DataGridTextColumn Header="Наименование" 
                                            Binding="{Binding Items[0].DraftName}" 
                                            Width="*"
                                            CellStyle="{DynamicResource LeftAlignedDataGridCell}"/>
                    </DataGrid.Columns>
                </DataGrid>
            </Grid>
        </Border>

        <!-- Центральная область - поля информации об основном заказе -->
        <Border Grid.Column="1" 
                Margin="0,5,0,5" 
                BorderThickness="2" 
                BorderBrush="{DynamicResource GreenAccentBrush}" 
                Background="{DynamicResource SecondaryBackgroundBrush}"
                CornerRadius="4"
                Padding="5">

            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <Grid IsSharedSizeScope="True">
                    <StackPanel>
                        
                        <TextBlock Text="Данные заказа"
                                   FontSize="16"
                                    FontWeight="Bold"
                                    HorizontalAlignment="Center"
                                    Foreground="{DynamicResource TextBrush}"
                                    Margin="0"/>

                        <!-- Технолог -->
                        <Grid Style="{StaticResource AttributeRowStyle}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Технолог:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBlock Grid.Column="1" 
                                       Text="{Binding model.CurrentGroup.Items[0].Technologist}" 
                                       Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

                        <!-- Изделие -->
                        <Grid Style="{StaticResource AttributeRowStyle}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Изделие:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.CoreDraft}" Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

                        <!-- Наименование изделия -->
                        <Grid Style="{StaticResource AttributeRowStyle}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Наименование изделия:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.CoreDraftName}" Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

                        <!-- Деталь -->
                        <Grid Style="{StaticResource AttributeRowStyle}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Деталь:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.Draft}" Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

                        <!-- Наименование детали -->
                        <Grid Style="{StaticResource AttributeRowStyle}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Наименование детали:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.DraftName}" Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

                        <!-- Цех получатель -->
                        <Grid Style="{StaticResource AttributeRowStyle}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Цех получ.:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.Workshop}" Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

                        <!-- Кладовая -->
                        <Grid Style="{StaticResource AttributeRowStyle}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Кладовая:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.Warehouse}" Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

                        <!-- Рабочее место -->
                        <Grid Style="{StaticResource AttributeRowStyle}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Раб. место:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.Workplace}" Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

                        <!-- Операция -->
                        <Grid Style="{StaticResource AttributeRowStyle}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Операция:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.Operation}" Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

                        <!-- Наименование оснастки -->
                        <Grid Style="{StaticResource AttributeRowStyle}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" 
                                            Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Наименование оснастки:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.EquipmentName}" Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

                        <!-- Аналог -->
                        <Grid Style="{StaticResource AttributeRowStyle}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Аналог:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.Analog}" Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

                        <!-- Количество оснастки на операцию -->
                        <Grid Style="{StaticResource AttributeRowStyle}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Кол-во оснастки на операцию:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.EquipmentQuantityForOperation}" Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>
                        
                    </StackPanel>
                </Grid>
            </ScrollViewer>
        </Border>

        <!-- Правая область (30%) с DataGrid подзаказов и детальной информацией -->
        <Border Grid.Column="2" 
                Margin="5,5,5,5" 
                BorderThickness="2" 
                BorderBrush="{DynamicResource GreenAccentBrush}" 
                Background="{DynamicResource SecondaryBackgroundBrush}"
                CornerRadius="4"
                Padding="5">

            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <!-- Заголовок тех.заказа -->
                    <RowDefinition Height="Auto"/>
                    <!-- DataGrid подзаказов -->
                    <RowDefinition Height="*"/>
                    <!-- Детальная информация -->
                </Grid.RowDefinitions>

                <!-- Заголовок с номером текущего тех.заказа -->
                <TextBlock Grid.Row="0"
                           Text="{Binding model.CurrentGroup.Zak1, StringFormat='Тех. заказ: {0}'}"
                           FontSize="16"
                           FontWeight="Bold"
                           HorizontalAlignment="Center"
                           Foreground="{DynamicResource TextBrush}"
                           Margin="0,0,0,10"/>

                <!-- DataGrid подзаказов -->
                <DataGrid Grid.Row="1"
                          ItemsSource="{Binding model.CurrentGroup.Items}"
                          SelectedItem="{Binding model.CurrentItem, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                          AutoGenerateColumns="False"
                          IsReadOnly="True"
                          CanUserAddRows="False"
                          HeadersVisibility="Column"
                          SelectionMode="Single"
                          Margin="0,0,0,5">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Чертеж" Binding="{Binding EquipmentDraft}" Width="Auto"/>
                        <DataGridTextColumn Header="Наименование" Binding="{Binding EquipmentNameFromTechologist}" Width="Auto" CellStyle="{DynamicResource LeftAlignedDataGridCell}"/>
                        <DataGridTextColumn Header="Сколько изготовить" Binding="{Binding EquimentRequiredQuantity}" MaxWidth="100" Width="Auto"/>
                        <DataGridCheckBoxColumn Header="Кооп." Binding="{Binding Cooperation, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" MaxWidth="55" Width="Auto">
                            <DataGridCheckBoxColumn.ElementStyle>
                                <Style TargetType="CheckBox">
                                    <Setter Property="HorizontalAlignment" Value="Center"/>
                                    <Setter Property="VerticalAlignment" Value="Center"/>
                                </Style>
                            </DataGridCheckBoxColumn.ElementStyle>
                        </DataGridCheckBoxColumn>
                        <DataGridCheckBoxColumn Header="Удалить из заказа" Binding="{Binding IsDeletedFromOrder, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Width="*">
                            <DataGridCheckBoxColumn.ElementStyle>
                                <Style TargetType="CheckBox">
                                    <Setter Property="HorizontalAlignment" Value="Center"/>
                                    <Setter Property="VerticalAlignment" Value="Center"/>
                                </Style>
                            </DataGridCheckBoxColumn.ElementStyle>
                        </DataGridCheckBoxColumn>
                    </DataGrid.Columns>
                </DataGrid>

                <!-- Детальная информация -->
                <Border Grid.Row="2"
                        BorderThickness="2" 
                        BorderBrush="Red" 
                        Background="{DynamicResource SecondaryBackgroundBrush}"
                        CornerRadius="4"
                        Padding="5">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <!-- Главный контейнер с включенным SharedSizeScope -->
                        <Grid IsSharedSizeScope="True">
                            <StackPanel>
                                <TextBlock Grid.Row="0"
                           Text="Данные чертежа"
                           FontSize="16"
                           FontWeight="Bold"
                           HorizontalAlignment="Center"
                           Foreground="{DynamicResource TextBrush}"
                           Margin="0"/>

                                <!-- Дополнительные сведения для проектирования -->
                                <Grid Style="{StaticResource AttributeRowStyle}">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                        <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                                    </Grid.ColumnDefinitions>

                                    <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                        <TextBlock Text="Доп. сведения для проектирования:" Style="{StaticResource AttributeLabelTextStyle}"/>
                                    </Border>

                                    <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.DesignComment}" TextWrapping="Wrap" Style="{StaticResource AttributeValueStyle}"/>
                                </Grid>

                                <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

                                <!-- Дополнительные сведения для производства -->
                                <Grid Style="{StaticResource AttributeRowStyle}">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                        <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                                    </Grid.ColumnDefinitions>

                                    <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                        <TextBlock Text="Доп. сведения для производства:" Style="{StaticResource AttributeLabelTextStyle}"/>
                                    </Border>

                                    <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.ManufacturingComment}" TextWrapping="Wrap" Style="{StaticResource AttributeValueStyle}"/>
                                </Grid>
                            </StackPanel>
                        </Grid>
                    </ScrollViewer>
                </Border>
            </Grid>
        </Border>
    </Grid>
</UserControl>

using System;
using System.ComponentModel;
using System.Windows;
using System.Windows.Controls;

using Fox;
using Fox.Core;
using Fox.Core.ErrorHelper;
using Fox.Core.Logging;
using Fox.DatabaseService;
using Fox.DatabaseService.Entities;

using ModalWindows.Entities;

using OrderApprovalSystem.Models;
using OrderApprovalSystem.Services;
using OrderApprovalSystem.Validators;
using OrderApprovalSystem.Views;


namespace OrderApprovalSystem.ViewModels
{
    public class vmSubTechnologist : VMBase
    {
        public SubTechnologist View;
        public mSubTechnologist Model;

        #region Инициализация

        public vmSubTechnologist()
        {

        }

        public void viewLoaded(object _sender, RoutedEventArgs _routedEventArgs)
        {
            View = (SubTechnologist)view;
            Model = (mSubTechnologist)model;

            Model.PropertyChanged += modelPropertyChangedHandler;
        }

        public void modelPropertyChangedHandler(object _sender, PropertyChangedEventArgs _eventArgs)
        {
            if (_eventArgs.PropertyName == nameof(Model.CurrentGroup) && View?.dgReport != null)
            {
                ScrollToCurrentGroup();
            }
        }

        #endregion Инициализация

        #region Команды

        public CommandBase NavigatePreviousCommand
        {
            get { return _navigatePreviousCommand ?? (_navigatePreviousCommand = new CommandBase(NavigatePrevious)); }
        }

        public CommandBase NavigateNextCommand
        {
            get { return _navigateNextCommand ?? (_navigateNextCommand = new CommandBase(NavigateNext)); }
        }

        public CommandBase NavigatePreviousGroupCommand
        {
            get { return _navigatePreviousGroupCommand ?? (_navigatePreviousGroupCommand = new CommandBase(NavigatePreviousGroup)); }
        }

        public CommandBase NavigateNextGroupCommand
        {
            get { return _navigateNextGroupCommand ?? (_navigateNextGroupCommand = new CommandBase(NavigateNextGroup)); }
        }

        public CommandBase pNavigateToDevCommand => new CommandBase(() => NavigateToDev());

        public CommandBase pApprovalOrderCommand => new CommandBase(() => ApprovalOrder());

        public CommandBase pRejectOrderCommand => new CommandBase(() => RejectOrder());

        #endregion Команды

        #region Свойства

        public string SearchText
        {
            get { return _searchText; }
            set
            {
                if (_searchText != value)
                {
                    _searchText = value;
                    OnPropertyChanged(nameof(SearchText));
                    PerformSearch();
                }
            }
        }

        #endregion Свойства

        #region переменные

        private CommandBase _navigatePreviousCommand;
        private CommandBase _navigateNextCommand;
        private CommandBase _navigatePreviousGroupCommand;
        private CommandBase _navigateNextGroupCommand;
        private string _searchText;

        #endregion переменные

        private void PerformSearch()
        {
            if (Model == null)
            {
                return;
            }
            Model.FindAndNavigate(SearchText);
        }

        private void NavigatePrevious()
        {
            if (Model?.HasPrevious == true)
            {
                Model.CurrentIndex--;
                Model.CurrentItem = Model.CurrentGroup.Items[Model.CurrentIndex];
            }
        }

        private void NavigateNext()
        {
            if (Model?.HasNext == true)
            {
                Model.CurrentIndex++;
                Model.CurrentItem = Model.CurrentGroup.Items[Model.CurrentIndex];
            }
        }

        private void NavigatePreviousGroup()
        {
            if (Model?.HasPreviousGroup == true)
            {
                Model.NavigatePreviousGroup();
            }
        }

        private void NavigateNextGroup()
        {
            if (Model?.HasNextGroup == true)
            {
                Model.NavigateNextGroup();
            }
        }

        /// <summary>
        /// Переход к Dev
        /// </summary>
        private void NavigateToDev()
        {
            if (View?.Parent is ContentControl contentControl &&
                contentControl.DataContext is vmMain vmMain)
            {
                vmMain.NavigateTo<vmDev>();
            }
        }

        private void ScrollToCurrentGroup()
        {
            if (View?.dgReport != null && Model?.CurrentGroup != null)
            {
                // Используем Dispatcher для асинхронной прокрутки
                Application.Current.Dispatcher.BeginInvoke(new Action(() =>
                {
                    try
                    {
                        View.dgReport.ScrollIntoView(Model.CurrentGroup);
                        View.dgReport.Focus();
                    }
                    catch (Exception ex)
                    {
                        LoggerManager.MainLogger.Error($"Error scrolling to current group: {ex.Message}");
                    }
                }), System.Windows.Threading.DispatcherPriority.Background);
            }
        }

        private void ApprovalOrder()
        {
            string operationName = "Согласование заказа";
            Result result = null;
            ModalResult userAnswer = DialogService.ShowApproveTechnologist(
                "Заполните данные",
                $"{operationName}: {Model.CurrentItem.OrderNumber}",
                vm => ApproveTechnologistModalValidator.Validate(vm)
            );

            if (userAnswer.IsDismissed || userAnswer.IsCancelled)
            {
                result = Result.Success("Отменено пользователем").HideMessage();
            }
            if (userAnswer.IsValidationFailed )
            {
                result = Result.Failed("Не пройдена валидация");
            }
            if (userAnswer.IsValid)
            {
                TransactionHelper.ExecuteWithTransaction(
                    businessLogic: () =>
                    {
                        result = Model.ApproveOrder(userAnswer.Data);
                        if (!result.IsSuccess)
                        {
                            throw new OperationCanceledException(result.Message);
                        }
                    },
                    errorHandler: errorContext =>
                    {
                        errorContext.ErrorDetail["Order"] = Model.CurrentGroup.Zak1;
                        errorContext.ErrorDetail["Draft"] = Model.CurrentItem.EquipmentDraft;
                        errorContext.ErrorDetail["ApprovalData"] = userAnswer.Data.ToString();

                        if (errorContext.Exception is OperationCanceledException)
                        {
                            LoggerManager.MainLogger.Error($"Операция - <{operationName}> отменена: {errorContext.Exception.Message}");
                            LoggerManager.MainLogger.Debug(
                                ErrorHelper.FormatErrorMessage(
                                    errorContext.Exception,
                                    "vmSubTechnologist.ApprovalOrder",
                                    errorContext.ErrorDetail
                                )
                            );
                            DialogService.ShowError(errorContext.Exception.Message, operationName);
                        }
                        else
                        {
                            LoggerManager.MainLogger.Error($"Операция - <{operationName}> прервана ошибкой: {errorContext.Exception.Message}");
                            LoggerManager.MainLogger.Error(
                                ErrorHelper.FormatErrorMessage(
                                    errorContext.Exception,
                                    "vmSubTechnologist.ApprovalOrder",
                                    errorContext.ErrorDetail
                                )
                            );

                            if (errorContext.ShouldLogToErrorHelper)
                            {
                                ErrorHelper.SendError(
                                    errorContext.Exception,
                                    "vmSubTechnologist.ApprovalOrder",
                                    errorContext.ErrorDetail
                                );
                            }

                            DialogService.ShowError("Критическая ошибка сохранения", operationName);
                        }
                    },
                    operationName: operationName,
                    model: Model,
                    isTransactionOwner: !ServiceLocator.DatabaseService.HasActiveTransaction
                );
            }
            DialogService.HandleResult(result, $"Согласование заказа: {Model.CurrentItem.OrderNumber}");
        }

        private void RejectOrder()
        {
            string operationName = "НЕ согласование заказа";
            Result result = null;
            ModalResult userAnswer = DialogService.ShowReject(
                "Заполните данные",
                $"НЕ согласовывать заказ: {Model.CurrentItem.OrderNumber}",
                vm => RejectOrderModalValidator.Validate(vm)
            );

            if (userAnswer.IsDismissed || userAnswer.IsCancelled)
            {
                result = Result.Success("Отменено пользователем").HideMessage();
            }
            if (userAnswer.IsValidationFailed)
            {
                result = Result.Failed("Не пройдена валидация");
            }
            if (userAnswer.IsValid)
            {
                TransactionHelper.ExecuteWithTransaction(
                    businessLogic: () =>
                    {
                        result = Model.RejectOrder(userAnswer.Data);
                        if (!result.IsSuccess)
                        {
                            throw new OperationCanceledException(result.Message);
                        }
                    },
                    errorHandler: errorContext =>
                    {
                        errorContext.ErrorDetail["Order"] = Model.CurrentGroup.Zak1;
                        errorContext.ErrorDetail["Draft"] = Model.CurrentItem.EquipmentDraft;
                        errorContext.ErrorDetail["ApprovalData"] = userAnswer.Data.ToString();

                        if (errorContext.Exception is OperationCanceledException)
                        {
                            LoggerManager.MainLogger.Error($"Операция - <{operationName}> отменена: {errorContext.Exception.Message}");
                            LoggerManager.MainLogger.Debug(
                                ErrorHelper.FormatErrorMessage(
                                    errorContext.Exception,
                                    "vmSubTechnologist.ApprovalOrder",
                                    errorContext.ErrorDetail
                                )
                            );
                            DialogService.ShowError(errorContext.Exception.Message, operationName);
                        }
                        else
                        {
                            LoggerManager.MainLogger.Error($"Операция - <{operationName}> прервана ошибкой: {errorContext.Exception.Message}");
                            LoggerManager.MainLogger.Error(
                                ErrorHelper.FormatErrorMessage(
                                    errorContext.Exception,
                                    "vmSubTechnologist.ApprovalOrder",
                                    errorContext.ErrorDetail
                                )
                            );

                            if (errorContext.ShouldLogToErrorHelper)
                            {
                                ErrorHelper.SendError(
                                    errorContext.Exception,
                                    "vmSubTechnologist.ApprovalOrder",
                                    errorContext.ErrorDetail
                                );
                            }

                            DialogService.ShowError("Критическая ошибка сохранения", operationName);
                        }
                    },
                    operationName: operationName,
                    model: Model,
                    isTransactionOwner: !ServiceLocator.DatabaseService.HasActiveTransaction
                );
            }
            DialogService.HandleResult(result, $"Согласование заказа: {Model.CurrentItem.OrderNumber}");
        }
    }

}

using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Data;
using System.Linq;

using Fox;
using Fox.Core;
using Fox.Core.Logging;
using Fox.DatabaseService.Entities;
using OrderApprovalSystem.Data;
using OrderApprovalSystem.Data.Entities;


namespace OrderApprovalSystem.Models
{
    public class mSubTechnologist : MBase
    {
        private Fox.DatabaseService.IDatabaseService db = ServiceLocator.DatabaseService;

        /// <summary>
        /// Конструктор
        /// </summary>
        public mSubTechnologist()
        {
            LoadData();
        }

        public void NavigatePrevious()
        {
            if (HasPrevious)
            {
                CurrentIndex--;
                CurrentItem = CurrentGroup.Items[CurrentIndex];
            }
        }

        public void NavigateNext()
        {
            if (HasNext)
            {
                CurrentIndex++;
                CurrentItem = CurrentGroup.Items[CurrentIndex];
            }
        }

        public void NavigateNextGroup()
        {
            if (HasNextGroup)
            {
                CurrentGroup = GroupedData[CurrentGroupIndex + 1];
            }
        }

        public void NavigatePreviousGroup()
        {
            if (HasPreviousGroup)
            {
                CurrentGroup = GroupedData[CurrentGroupIndex - 1];
            }
        }

        public void FindAndNavigate(string searchText)
        {
            if (string.IsNullOrWhiteSpace(searchText) || GroupedData == null)
            {
                return;
            }

            string query = searchText.ToLower().Trim();

            var targetGroup = GroupedData.FirstOrDefault(
                g =>
                g.Zak1 != null && g.Zak1.ToLower().Contains(query)
            );
            if (targetGroup != null)
            {
                if (CurrentGroup != targetGroup)
                {
                    CurrentGroup = targetGroup;
                }
                return;
            }
        }

        #region Модальные окна

        public Result ApproveOrder(Dictionary<string, object> data)
        {
            LoggerManager.MainLogger.Debug($"ApproveOrder for {CurrentItem.OrderNumber}");

            try
            {
                // Извлечение данных из входного словаря
                DateTime manufacturingTerm = (DateTime)data["ManufacturingTerm"];
                string comment = (string)data["Comment"];

                // Получение количества рабочих дней для согласования
                int workingDaysCount = db.mGetQuery<OrderApproval>()
                    .Where(order => order.ID == CurrentItem.OrderApprovalID)
                    .Join(
                        db.mGetQuery<OrderApprovalTypes>(),
                        order => order.EquipmentTypeID,
                        approvalType => approvalType.ID,
                        (order, approvalType) => approvalType.Term
                    )
                    .FirstOrDefault();

                // Получение даты выполнения с учетом рабочих дней
                DateTime deadlineDate = db.mGetQuery<calend>()
                    .Where(calendarDay => calendarDay.mday > manufacturingTerm && calendarDay.v == true)
                    .OrderBy(calendarDay => calendarDay.mday)
                    .Skip(workingDaysCount - 1) // Пропускаем N-1 рабочих дней
                    .Take(1)
                    .Select(calendarDay => calendarDay.mday)
                    .FirstOrDefault();

                // Если не нашли дату в календаре, используем простое сложение дней
                if (deadlineDate == default(DateTime))
                {
                    deadlineDate = DateTime.Today.AddDays(workingDaysCount);
                }

                // Обновление текущей записи согласования
                OrderApprovalHistory thisStepRecord = db.mGetList<OrderApprovalHistory>(
                    record =>
                    record.OrderApprovalID == CurrentItem.OrderApprovalID
                    && record.RecipientRole == "Технолог"
                    && record.RecipientName == "Рагульский"
                )
                .Data
                .OrderByDescending(record => record.ID)
                .FirstOrDefault();

                if (thisStepRecord == null)
                {
                    return Result.Failed("Не найдена текущая запись согласования!");
                }

                thisStepRecord.Status = "Выполнено";
                thisStepRecord.Result = "Согласовано";

                Result status = db.mUpdate(thisStepRecord);
                if (status.IsFailed)
                {
                    return Result.Failed("Не удалось обновить запись текущего согласования в БД!");
                }

                // Создание новой записи для следующего этапа согласования
                OrderApprovalHistory nextStepRecord = new OrderApprovalHistory
                {
                    OrderApprovalID = CurrentItem.OrderApprovalID,
                    ReceiptDate = DateTime.Now,
                    CompletionDate = null,
                    Term = deadlineDate,
                    RecipientRole = "Начальник отдела заказов",
                    RecipientName = "Дингес",
                    SenderRole = "Технолог",
                    SenderName = "Рагульский",
                    Result = null,
                    Comment = comment
                };

                status = db.mAdd(nextStepRecord);
                if (status.IsFailed)
                {
                    return Result.Failed("Не удалось сохранить запись нового согласования в БД!");
                }

                return Result.Success();
            }
            catch (Exception ex)
            {
                LoggerManager.MainLogger.Error($"Ошибка в ApproveOrder: {ex.Message}");
                return Result.Failed($"Произошла ошибка при согласовании: {ex.Message}");
            }
        }

        public Result RejectOrder(Dictionary<string, object> data)
        {
            LoggerManager.MainLogger.Debug("Call RejectOrder");

            try
            {
                // Находим ID последней записи согласования для технолога Рагульского
                var maxId = db.mGetQuery<OrderApprovalHistory>()
                    .Where(oah => oah.OrderApprovalID == CurrentItem.OrderApprovalID
                               && oah.RecipientRole == "Технолог"
                               && oah.RecipientName == "Рагульский")
                    .Select(oah => oah.ID)
                    .Max();

                // Получаем последнюю запись согласования
                OrderApprovalHistory previousStepRecord = db.mGetSingle<OrderApprovalHistory>(
                    record => record.ID == maxId
                ).Data;

                if (previousStepRecord is null)
                {
                    LoggerManager.MainLogger.Error("Не найдена прошлая строка согласования");
                    return Result.Failed("Не найдена предыдущая запись согласования");
                }

                // Обновляем текущую запись согласования
                previousStepRecord.Status = "Выполнено";
                previousStepRecord.Result = "На доработку";
                previousStepRecord.CompletionDate = DateTime.Now;

                Result updateResult = db.mUpdate(previousStepRecord);
                if (updateResult.IsFailed)
                {
                    LoggerManager.MainLogger.Error($"Ошибка при обновлении записи: {updateResult.Message}");
                    return Result.Failed("Не удалось обновить запись согласования");                                                                                                                                                                  
                }

                // Получение количества рабочих дней для согласования из OrderApprovalTypes
                int workingDaysCount = db.mGetQuery<OrderApproval>()
                    .Where(order => order.ID == CurrentItem.OrderApprovalID)
                    .Join(
                        db.mGetQuery<OrderApprovalTypes>(),
                        order => order.EquipmentTypeID,
                        approvalType => approvalType.ID,
                        (order, approvalType) => approvalType.Term
                    )
                    .FirstOrDefault();

                if (workingDaysCount <= 0)
                {
                    LoggerManager.MainLogger.Error($"Not found term for approvalType:");
                    return Result.Failed("Не найден срок");
                }

                // Расчет даты выполнения с учетом рабочих дней
                DateTime today = DateTime.Today;
                DateTime deadlineDate;

                // Получаем ближайшую рабочую дату после сегодняшней
                var firstWorkingDay = db.mGetQuery<calend>()
                    .Where(calendarDay => calendarDay.mday > today && calendarDay.v == true)
                    .OrderBy(calendarDay => calendarDay.mday)
                    .FirstOrDefault();

                if (firstWorkingDay != null)
                {
                    // Ищем дату, отстоящую на workingDaysCount рабочих дней вперед
                    deadlineDate = db.mGetQuery<calend>()
                        .Where(calendarDay => calendarDay.mday > today && calendarDay.v == true)
                        .OrderBy(calendarDay => calendarDay.mday)
                        .Skip(workingDaysCount - 1) // Пропускаем N-1 рабочих дней
                        .Take(1)
                        .Select(calendarDay => calendarDay.mday)
                        .FirstOrDefault();
                }
                else
                {
                    deadlineDate = default(DateTime);
                }

                // Если не нашли дату в календаре, используем простое сложение дней
                if (deadlineDate == default(DateTime))
                {
                    // Добавляем рабочие дни + возможные выходные
                    deadlineDate = today.AddDays(workingDaysCount * 1.4); // коэффициент для учета выходных
                }

                // Извлечение данных из входного словаря
                string recipientRole = (string)data["Subdivision"];
                string recipientName = (string)data["SubdivisionRecipient"];
                string comment = (string)data["Comment"];

                // Создание новой записи для следующего этапа согласования
                OrderApprovalHistory nextStepRecord = new OrderApprovalHistory
                {
                    OrderApprovalID = CurrentItem.OrderApprovalID,
                    ReceiptDate = DateTime.Now,
                    CompletionDate = null, // Для новой записи CompletionDate должен быть null
                    Term = deadlineDate,
                    RecipientRole = recipientRole,
                    RecipientName = recipientName,
                    SenderRole = "Технолог",
                    SenderName = "Рагульский",
                    Status = "В работе", // Новая запись начинается со статуса "В работе"
                    Result = null, // Результат еще не определен
                    Comment = comment
                };

                Result addResult = db.mAdd(nextStepRecord);
                if (addResult.IsFailed)
                {
                    LoggerManager.MainLogger.Error($"Ошибка при добавлении записи: {addResult.Message}");
                    return Result.Failed("Не удалось создать новую запись согласования");
                }

                LoggerManager.MainLogger.Info($"Заказ отклонен и перенаправлен в {recipientRole} - {recipientName}");
                return Result.Success();
            }
            catch (Exception ex)
            {
                LoggerManager.MainLogger.Error($"Ошибка в RejectOrder: {ex.Message}", ex);
                return Result.Failed($"Произошла ошибка при отклонении заказа: {ex.Message}");
            }
        }

        #endregion Модальные окна

        #region Свойства

        public List<TechnologistGroup> GroupedData
        {
            get => _groupedData;
            set
            {
                _groupedData = value;
                OnPropertyChanged(nameof(TotalGroups));
                if (_groupedData != null && _groupedData.Any())
                {
                    CurrentGroup = _groupedData.First();
                }
            }
        }

        public TechnologistGroup CurrentGroup
        {
            get => _currentGroup;
            set
            {
                _currentGroup = value;
                OnPropertyChanged(nameof(CurrentGroup));

                if (_groupedData != null && _currentGroup != null)
                {
                    CurrentGroupIndex = _groupedData.IndexOf(_currentGroup);
                }

                OnPropertyChanged(nameof(CurrentGroupIndexDisplay));
                OnPropertyChanged(nameof(HasPreviousGroup));
                OnPropertyChanged(nameof(HasNextGroup));

                if (_currentGroup != null && _currentGroup.Items.Any())
                {
                    CurrentItem = _currentGroup.Items.First();
                    CurrentIndex = 0;
                }
                else
                {
                    CurrentItem = null;
                    CurrentIndex = 0;
                }
            }
        }

        public TechnologicalOrder CurrentItem
        {
            get => _currentItem;
            set
            {
                _currentItem = value;

                // Обновляем индекс строки при изменении CurrentItem
                if (_currentGroup != null && _currentItem != null && _currentGroup.Items.Contains(_currentItem))
                {
                    CurrentIndex = _currentGroup.Items.IndexOf(_currentItem);
                }

                OnPropertyChanged(nameof(CurrentItem));
                OnPropertyChanged(nameof(CurrentIndexDisplay));
                OnPropertyChanged(nameof(HasPrevious));
                OnPropertyChanged(nameof(HasNext));
            }
        }

        public int CurrentGroupIndex
        {
            get => _currentGroupIndex;
            set
            {
                _currentGroupIndex = value;
                OnPropertyChanged(nameof(CurrentGroupIndex));
                OnPropertyChanged(nameof(CurrentGroupIndexDisplay));
                OnPropertyChanged(nameof(HasPreviousGroup));
                OnPropertyChanged(nameof(HasNextGroup));
            }
        }

        public int CurrentIndex
        {
            get => _currentIndex;
            set
            {
                _currentIndex = value;
                OnPropertyChanged(nameof(CurrentIndex));
                OnPropertyChanged(nameof(CurrentIndexDisplay));
                OnPropertyChanged(nameof(HasPrevious));
                OnPropertyChanged(nameof(HasNext));
            }
        }

        public string CurrentGroupIndexDisplay =>
            GroupedData != null && GroupedData.Any()
                ? $"{CurrentGroupIndex + 1} из {GroupedData.Count}"
                : "0 из 0";

        public string CurrentIndexDisplay =>
            CurrentGroup != null && CurrentGroup.Items.Any()
                ? $"{CurrentIndex + 1} из {CurrentGroup.Items.Count}"
                : "0 из 0";

        public bool HasPrevious => CurrentGroup != null && CurrentIndex > 0;
        public bool HasNext => CurrentGroup != null && CurrentIndex < CurrentGroup.Items.Count - 1;
        public bool HasPreviousGroup => GroupedData != null && CurrentGroupIndex > 0;
        public bool HasNextGroup => GroupedData != null && CurrentGroupIndex < GroupedData.Count - 1;
        public int TotalGroups => GroupedData?.Count ?? 0;

        #endregion Свойства

        #region Переменные

        private List<TechnologistGroup> _groupedData;
        private TechnologistGroup _currentGroup;
        private TechnologicalOrder _currentItem;
        private int _currentIndex = 0;
        private int _currentGroupIndex = 0;

        #endregion Переменные

        private void LoadData()
        {
            try
            {
                Fox.DatabaseService.IDatabaseService db = ServiceLocator.DatabaseService;

                IQueryable<TechnologicalOrder> query =
                    from OrderApproval in db.mGetQuery<OrderApproval>()
                    join OrderApprovalDrafts in db.mGetQuery<OrderApprovalDrafts>() on OrderApproval.ID equals OrderApprovalDrafts.OrderApprovalID
                    join zayvka in db.mGetQuery<zayvka>() on OrderApproval.zayvkaID equals zayvka.id
                    join os_pro in db.mGetQuery<os_pro>() on zayvka.zak_1 equals os_pro.zak_1

                    // LEFT JOIN oborud
                    join oborud in db.mGetQuery<oborud>() on zayvka.rab_m equals oborud.rab_m into obGroup
                    from oborud in obGroup.DefaultIfEmpty()

                        // LEFT JOIN s_oper
                    join s_oper in db.mGetQuery<s_oper>() on zayvka.kodop equals s_oper.code into soGroup
                    from s_oper in soGroup.DefaultIfEmpty()

                        // LEFT JOIN prod
                    join p in db.mGetQuery<prod>()
                        on new { zayvka.zak_1, IsDrNull = (decimal?)null }
                        equals new { p.zak_1, IsDrNull = p.dr } into pGroup
                    from p in pGroup.DefaultIfEmpty()

                    where os_pro.d_vn_14 != null

                    orderby zayvka.zak_1

                    select new TechnologicalOrder
                    {
                        OrderNumber = zayvka.zak_1,
                        OrderApprovalID = OrderApproval.ID,
                        OrderApprovalDraftID = OrderApprovalDrafts.ID,
                        Technologist = OrderApproval.Technologist,
                        CoreDraft = (decimal)OrderApproval.CoreDraft,
                        Draft = OrderApproval.Draft,
                        CoreDraftName = OrderApproval.CoreDraftName.Trim(),
                        DraftName = OrderApproval.DraftName.Trim(),

                        Workshop = OrderApproval.Workshop,
                        Warehouse = OrderApproval.Warehouse,
                        Schedule = zayvka.graf,

                        Workplace = oborud != null ? (oborud.code + " " + oborud.oborud1).Trim() : null,
                        Operation = s_oper != null ? s_oper.oper.Trim() : null,

                        EquipmentDraft = OrderApprovalDrafts.EquipmentDraft,
                        EquipmentName = OrderApprovalDrafts.EquipmentName.Trim(),
                        EquipmentNameFromTechologist = OrderApproval.EquipmentNameFromTechnologist.Trim(),
                        EquipmentQuantityForOperation = OrderApproval.EquipmentQuantityForOperation,
                        EquimentRequiredQuantity = OrderApprovalDrafts.EquimentRequiredQuantity,
                        Cooperation = OrderApprovalDrafts.Cooperation,
                        IsDeletedFromOrder = OrderApprovalDrafts.IsDeletedFromOrder,

                        Note = zayvka.prim,
                        Analog = OrderApproval.Analog,
                        DesignComment = OrderApprovalDrafts.CommentForDesign,
                        ManufacturingComment = OrderApprovalDrafts.CommentForManufacturing,
                        OpenAtByTechnologist = OrderApproval.OpenAt,
                        Comment = null,
                    };

                List<TechnologicalOrder> data = query.Distinct().ToList();


                GroupedData = data
                    .OrderBy(x => x.EquipmentDraft)
                    .GroupBy(x => x.OrderNumber)
                    .Select(
                        g =>
                        new TechnologistGroup
                        {
                            Zak1 = g.Key,
                            Items = new ObservableCollection<TechnologicalOrder>(g.OrderBy(x => x.OpenAtByTechnologist).ToList())
                        }
                    )
                    .OrderBy(g => g.Zak1)
                    .ToList();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error: {ex.Message}");
            }
        }
    }

}

<UserControl 
        x:Class="OrderApprovalSystem.Views.OrderManager"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:ribbon="clr-namespace:System.Windows.Controls.Ribbon;assembly=System.Windows.Controls.Ribbon"
        xmlns:local="clr-namespace:OrderApprovalSystem.Views"
        xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
        xmlns:behaviors="clr-namespace:OrderApprovalSystem.Behaviors"
        xmlns:converters="clr-namespace:OrderApprovalSystem.Converters"
        Background="{DynamicResource PrimaryBackgroundBrush}"
        Foreground="{DynamicResource TextBrush}">

    <UserControl.Resources>
        <converters:IsByMemoToTextConverter x:Key="IsByMemoToTextConverter"/>
        <converters:MaskedDateConverter x:Key="MaskedDateConverter"/>
    </UserControl.Resources>

    <i:Interaction.Triggers>
        <i:EventTrigger EventName="Loaded">
            <i:CallMethodAction TargetObject="{Binding}" MethodName="viewLoaded"/>
        </i:EventTrigger>
    </i:Interaction.Triggers>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="0.40*"/>
            <ColumnDefinition Width="0.3*"/>
            <ColumnDefinition Width="0.30*"/>
        </Grid.ColumnDefinitions>

        <Border Grid.Column="0" 
                Margin="5" 
                BorderThickness="2" 
                BorderBrush="{DynamicResource AccentBrush}" 
                Background="{DynamicResource SecondaryBackgroundBrush}"
                CornerRadius="4">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Заголовок таблицы -->
                <Border Grid.Row="0"
                        Background="{DynamicResource AccentBrush}"
                        CornerRadius="2,2,0,0"
                        Padding="10">
                    <TextBlock Text="Технологические заказы"
                               Foreground="White"
                               FontSize="14"
                               FontWeight="Bold"
                               HorizontalAlignment="Center"/>
                </Border>

                <!-- DataGrid с группами заказов -->
                <DataGrid Grid.Row="1"
                          IsReadOnly="True"
                          AutoGenerateColumns="False"
                          SelectionMode="Single"
                          HeadersVisibility="Column"
                          HorizontalScrollBarVisibility="Disabled"
                          CanUserAddRows="False"
                          x:Name="dgReport" 
                          ItemsSource="{Binding model.GroupedData}" 
                          SelectedItem="{Binding model.CurrentGroup, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">

                    <i:Interaction.Behaviors>
                        <behaviors:ScrollIntoViewBehavior SelectedItem="{Binding model.CurrentGroup, Mode=OneWay}"/>
                    </i:Interaction.Behaviors>

                    <DataGrid.Columns>
                        <!-- Заказ - всегда показывается -->
                        <DataGridTextColumn Header="Тех. заказ" 
                        Binding="{Binding Zak1}" 
                        Width="80"/>

                        <!-- Кол-во чертежей - скрывается для СЗ -->
                        <DataGridTextColumn Header="Кол-во чертежей в заказе" 
                        Width="100">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Text" Value="{Binding Items.Count}"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsByMemo}" Value="True">
                                            <Setter Property="Text" Value=""/>
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>

                        <!-- Дата - скрывается для СЗ -->
                        <DataGridTextColumn Header="Дата" 
                        Width="Auto">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Text" Value="{Binding Items[0].OpenAtByTechnologist, StringFormat=\{0:dd.MM.yyyy\}}"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsByMemo}" Value="True">
                                            <Setter Property="Text" Value=""/>
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>

                        <!-- Чертеж ДСЕ - скрывается для СЗ -->
                        <DataGridTextColumn Header="Чертеж ДСЕ" 
                        Width="Auto">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Text" Value="{Binding Items[0].Draft}"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsByMemo}" Value="True">
                                            <Setter Property="Text" Value=""/>
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>

                        <!-- Наименование - скрывается для СЗ -->
                        <DataGridTextColumn Header="Наименование" 
                        Width="*"
                        CellStyle="{DynamicResource LeftAlignedDataGridCell}">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Text" Value="{Binding Items[0].DraftName}"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsByMemo}" Value="True">
                                            <Setter Property="Text" Value=""/>
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>

                        <!-- Тип - всегда показывается -->
                        <DataGridTextColumn Header="Тип" 
                        Width="Auto"
                        CellStyle="{DynamicResource LeftAlignedDataGridCell}">
                            <DataGridTextColumn.Binding>
                                <Binding Path="IsByMemo">
                                    <Binding.Converter>
                                        <converters:IsByMemoToTextConverter/>
                                    </Binding.Converter>
                                </Binding>
                            </DataGridTextColumn.Binding>
                        </DataGridTextColumn>
                    </DataGrid.Columns>
                </DataGrid>
            </Grid>
        </Border>

        <!-- Центральная область - поля информации об основном заказе -->
        <Border Grid.Column="1" 
        Margin="0,5,0,5" 
        BorderThickness="2" 
        BorderBrush="{DynamicResource GreenAccentBrush}" 
        Background="{DynamicResource SecondaryBackgroundBrush}"
        CornerRadius="4"
        Padding="5">

            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <Grid IsSharedSizeScope="True">
                    <StackPanel>

                        <TextBlock
                           FontSize="16"
                           FontWeight="Bold"
                           HorizontalAlignment="Center"
                           Foreground="{DynamicResource TextBrush}"
                           Margin="0">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Text" Value="Данные тех. заказа"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="True">
                                            <Setter Property="Text" Value="Данные заказа"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
						
                        <!-- Технолог -->
                        <Grid>
                            <Grid.Style>
                                <Style TargetType="Grid">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Grid.Style>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Технолог:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBlock Grid.Column="1" 
                               Text="{Binding model.CurrentItem.Technologist}" 
                               Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <Separator>
                            <Separator.Style>
                                <Style TargetType="Separator" BasedOn="{StaticResource AttributeSeparatorStyle}">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Separator.Style>
                        </Separator>

                        <!-- Изделие -->
                        <Grid>
                            <Grid.Style>
                                <Style TargetType="Grid">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Grid.Style>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Изделие:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.CoreDraft}" Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <Separator>
                            <Separator.Style>
                                <Style TargetType="Separator" BasedOn="{StaticResource AttributeSeparatorStyle}">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Separator.Style>
                        </Separator>

                        <!-- Наименование изделия -->
                        <Grid>
                            <Grid.Style>
                                <Style TargetType="Grid">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Grid.Style>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Наименование изделия:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.CoreDraftName}" Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <Separator>
                            <Separator.Style>
                                <Style TargetType="Separator" BasedOn="{StaticResource AttributeSeparatorStyle}">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Separator.Style>
                        </Separator>

                        <!-- Деталь -->
                        <Grid>
                            <Grid.Style>
                                <Style TargetType="Grid">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Grid.Style>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Деталь:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.Draft}" Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <Separator>
                            <Separator.Style>
                                <Style TargetType="Separator" BasedOn="{StaticResource AttributeSeparatorStyle}">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Separator.Style>
                        </Separator>

                        <!-- Наименование детали -->
                        <Grid>
                            <Grid.Style>
                                <Style TargetType="Grid">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Grid.Style>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Наименование детали:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.DraftName}" Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <Separator>
                            <Separator.Style>
                                <Style TargetType="Separator" BasedOn="{StaticResource AttributeSeparatorStyle}">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Separator.Style>
                        </Separator>

                        <!-- Цех получатель -->
                        <Grid>
                            <Grid.Style>
                                <Style TargetType="Grid">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Grid.Style>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Цех получ.:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.Workshop}" Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <Separator>
                            <Separator.Style>
                                <Style TargetType="Separator" BasedOn="{StaticResource AttributeSeparatorStyle}">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Separator.Style>
                        </Separator>

                        <!-- Кладовая -->
                        <Grid>
                            <Grid.Style>
                                <Style TargetType="Grid">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Grid.Style>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Кладовая:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.Warehouse}" Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <Separator>
                            <Separator.Style>
                                <Style TargetType="Separator" BasedOn="{StaticResource AttributeSeparatorStyle}">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Separator.Style>
                        </Separator>

                        <!-- Рабочее место -->
                        <Grid>
                            <Grid.Style>
                                <Style TargetType="Grid">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Grid.Style>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Раб. место:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.Workplace}" Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <Separator>
                            <Separator.Style>
                                <Style TargetType="Separator" BasedOn="{StaticResource AttributeSeparatorStyle}">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Separator.Style>
                        </Separator>

                        <!-- Операция -->
                        <Grid>
                            <Grid.Style>
                                <Style TargetType="Grid">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Grid.Style>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Операция:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.Operation}" Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <Separator>
                            <Separator.Style>
                                <Style TargetType="Separator" BasedOn="{StaticResource AttributeSeparatorStyle}">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Separator.Style>
                        </Separator>

                        <!-- Наименование оснастки -->
                        <Grid>
                            <Grid.Style>
                                <Style TargetType="Grid">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Grid.Style>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Наименование оснастки:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.EquipmentName}" Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <Separator>
                            <Separator.Style>
                                <Style TargetType="Separator" BasedOn="{StaticResource AttributeSeparatorStyle}">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Separator.Style>
                        </Separator>

                        <!-- Аналог -->
                        <Grid>
                            <Grid.Style>
                                <Style TargetType="Grid">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Grid.Style>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Аналог:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.Analog}" Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <Separator>
                            <Separator.Style>
                                <Style TargetType="Separator" BasedOn="{StaticResource AttributeSeparatorStyle}">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Separator.Style>
                        </Separator>

                        <!-- Количество оснастки на операцию -->
                        <Grid>
                            <Grid.Style>
                                <Style TargetType="Grid">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Grid.Style>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Кол-во оснастки на операцию:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.EquipmentQuantityForOperation}" Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <TextBlock Text="Данные заказа"
                           FontSize="16"
                           FontWeight="Bold"
                           HorizontalAlignment="Center"
                           Foreground="{DynamicResource TextBrush}"
                           Margin="0,10,0,0">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>

                        <!-- Номер служебной -->
                        <Grid>
                            <Grid.Style>
                                <Style TargetType="Grid">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="False">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Grid.Style>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Номер служебной записки:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBox Grid.Column="1" 
                             Text="{Binding model.CurrentItem.MemoNumber, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                             Style="{StaticResource AttributeTextBoxStyle}"/>
                        </Grid>

                        <Separator>
                            <Separator.Style>
                                <Style TargetType="Separator" BasedOn="{StaticResource AttributeSeparatorStyle}">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="False">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Separator.Style>
                        </Separator>

                        <!-- Автор служебной -->
                        <Grid>
                            <Grid.Style>
                                <Style TargetType="Grid">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="False">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Grid.Style>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Автор служебной записки:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBox Grid.Column="1" 
                             Text="{Binding model.CurrentItem.MemoAuthor, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                             Style="{StaticResource AttributeTextBoxStyle}"/>
                        </Grid>

                        <Separator>
                            <Separator.Style>
                                <Style TargetType="Separator" BasedOn="{StaticResource AttributeSeparatorStyle}">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="False">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Separator.Style>
                        </Separator>

                        <!-- Заказ по служебной -->
                        <Grid Style="{StaticResource AttributeRowStyle}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Заказ:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBox Grid.Column="1" 
                                 Text="{Binding model.CurrentItem.OrderByMemo, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                 Style="{StaticResource AttributeTextBoxStyle}"/>
                        </Grid>

                        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>
                        
                        <!-- Номер по служебной -->
                        <Grid Style="{StaticResource AttributeRowStyle}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Номер:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBox Grid.Column="1" 
                             Text="{Binding model.CurrentItem.NumberByMemo, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                             Style="{StaticResource AttributeTextBoxStyle}"/>
                        </Grid>

                        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>
                        
                        <!-- Основной заказ по служебной -->
                        <Grid Style="{StaticResource AttributeRowStyle}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Основной заказ:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBox Grid.Column="1" 
                             Text="{Binding model.CurrentItem.CoreOrderByMemo, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                             Style="{StaticResource AttributeTextBoxStyle}"/>
                        </Grid>

                        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>
                        
                        <!-- Номер основного заказа по служебной -->
                        <Grid Style="{StaticResource AttributeRowStyle}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Номер основного заказа:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBox Grid.Column="1" 
                             Text="{Binding model.CurrentItem.CoreNumberByMemo, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                             Style="{StaticResource AttributeTextBoxStyle}"/>
                        </Grid>

                        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

                        <!-- Наименование заказа по служебной -->
                        <Grid Style="{StaticResource AttributeRowStyle}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Наименование заказа:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBox Grid.Column="1" 
                             Text="{Binding model.CurrentItem.OrderName, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                             Style="{StaticResource AttributeTextBoxStyle}"/>
                        </Grid>

                        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

                        <!-- Дата открытия заказа -->
                        <Grid Style="{StaticResource AttributeRowStyle}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Дата открытия заказа:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBox Grid.Column="1" 
                             Text="{Binding model.CurrentItem.OpenAtByMemo, 
                                    Mode=TwoWay, 
                                    UpdateSourceTrigger=LostFocus,
                                    Converter={StaticResource MaskedDateConverter},
                                    StringFormat='{}{0:dd.MM.yyyy}'}"
                             Style="{StaticResource AttributeTextBoxStyle}"/>
                        </Grid>

                        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

                        <!-- Балансовый счет -->
                        <Grid Style="{StaticResource AttributeRowStyle}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Балансовый счет:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBox Grid.Column="1" 
                             Text="{Binding model.CurrentItem.Balance, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                             Style="{StaticResource AttributeTextBoxStyle}"/>
                        </Grid>

                        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

                        <!-- Номенклатурная группа -->
                        <Grid Style="{StaticResource AttributeRowStyle}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Номенклатурная группа:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <ComboBox Grid.Column="1" 
                              ItemsSource="{Binding NomenclatureGroups}"
                              SelectedItem="{Binding model.CurrentItem.NomenclatureGroup, UpdateSourceTrigger=PropertyChanged}"
                              Style="{StaticResource AttributeComboBoxStyle}"
                              ItemContainerStyle="{StaticResource AttributeComboBoxItemStyle}">
                            </ComboBox>
                        </Grid>

                        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>
                        
                        <!-- Тип оснастки -->
                        <Grid Style="{StaticResource AttributeRowStyle}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Тип оснастки:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <ComboBox Grid.Column="1"
                              ItemsSource="{Binding EquipmentTypes}"
                              SelectedItem="{Binding model.CurrentItem.EquipmentType, UpdateSourceTrigger=PropertyChanged}"
                              Style="{StaticResource AttributeComboBoxStyle}">
                                <ComboBox.ItemTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding TypeName}"/>
                                    </DataTemplate>
                                </ComboBox.ItemTemplate>
                            </ComboBox>
                        </Grid>

                        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>
                        
                        <!-- Чертеж по служебной -->
                        <Grid Style="{StaticResource AttributeRowStyle}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Чертеж:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBox Grid.Column="1" 
                             Text="{Binding model.CurrentItem.DraftByMemo, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                             Style="{StaticResource AttributeTextBoxStyle}"/>
                        </Grid>

                        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>
                        
                        <!-- Наименование чертежа по служебной -->
                        <Grid Style="{StaticResource AttributeRowStyle}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Чертежное обозн. спецификации:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBox Grid.Column="1" 
                             Text="{Binding model.CurrentItem.DraftNameByMemo, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                             Style="{StaticResource AttributeTextBoxStyle}"/>
                        </Grid>

                        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>
                        
                        <!-- Склад по служебной -->
                        <Grid Style="{StaticResource AttributeRowStyle}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Склад:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBox Grid.Column="1" 
                             Text="{Binding model.CurrentItem.WorkshopByMemo, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                             Style="{StaticResource AttributeTextBoxStyle}"/>
                        </Grid>

                        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>
                        
                        <!-- Количество по служебной -->
                        <Grid Style="{StaticResource AttributeRowStyle}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Количество:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBox Grid.Column="1" 
                             Text="{Binding model.CurrentItem.EquipmentRequiredQuantityByMemo, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                             Style="{StaticResource AttributeTextBoxStyle}"/>
                        </Grid>

                    </StackPanel>
                </Grid>
            </ScrollViewer>
        </Border>

        <!-- Правая область (30%) с DataGrid подзаказов и детальной информацией -->
        <Border Grid.Column="2" 
                Margin="5,5,5,5" 
                BorderThickness="2" 
                BorderBrush="{DynamicResource GreenAccentBrush}" 
                Background="{DynamicResource SecondaryBackgroundBrush}"
                CornerRadius="4"
                Padding="5">

            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <!-- Заголовок тех.заказа -->
                    <RowDefinition Height="Auto"/>
                    <!-- DataGrid подзаказов -->
                    <RowDefinition Height="*"/>
                    <!-- Детальная информация -->
                </Grid.RowDefinitions>

                <!-- Заголовок с номером текущего тех.заказа -->
                <TextBlock Grid.Row="0"
                           Text="{Binding model.CurrentGroup.Zak1, StringFormat='Тех. заказ: {0}'}"
                           FontSize="16"
                           FontWeight="Bold"
                           HorizontalAlignment="Center"
                           Foreground="{DynamicResource TextBrush}"
                           Margin="0,0,0,10"/>

                <!-- DataGrid подзаказов -->
                <DataGrid Grid.Row="1"
                          ItemsSource="{Binding model.CurrentGroup.Items}"
                          SelectedItem="{Binding model.CurrentItem, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                          AutoGenerateColumns="False"
                          IsReadOnly="True"
                          CanUserAddRows="False"
                          HeadersVisibility="Column"
                          SelectionMode="Single"
                          Margin="0,0,0,5">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Чертеж" Binding="{Binding EquipmentDraft}" Width="Auto"/>
                        <DataGridTextColumn Header="Наименование" Binding="{Binding EquipmentNameFromTechologist}" Width="Auto" CellStyle="{DynamicResource LeftAlignedDataGridCell}"/>
                        <DataGridTextColumn Header="Сколько изготовить" Binding="{Binding EquimentRequiredQuantity}" MaxWidth="100" Width="Auto"/>
                        <DataGridCheckBoxColumn Header="Кооп." 
                        Binding="{Binding Cooperation, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                        MaxWidth="55" 
                        Width="Auto"
                        ElementStyle="{StaticResource ConditionalCheckBoxColumnStyle}"
                        EditingElementStyle="{StaticResource ConditionalCheckBoxColumnStyle}"/>
                        <DataGridCheckBoxColumn Header="Удалить" Binding="{Binding IsDeletedFromOrder, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Width="*"
                                                ElementStyle="{StaticResource ConditionalCheckBoxColumnStyle}" 
                                                EditingElementStyle="{StaticResource ConditionalCheckBoxColumnStyle}"/>
                    </DataGrid.Columns>
                </DataGrid>

                <!-- Детальная информация -->
                <Border Grid.Row="2"
                        BorderThickness="2" 
                        BorderBrush="Red" 
                        Background="{DynamicResource SecondaryBackgroundBrush}"
                        CornerRadius="4"
                        Padding="5">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <!-- Главный контейнер с включенным SharedSizeScope -->
                        <Grid IsSharedSizeScope="True">
                            <StackPanel>
                                <TextBlock Grid.Row="0"
                           Text="Данные чертежа"
                           FontSize="16"
                           FontWeight="Bold"
                           HorizontalAlignment="Center"
                           Foreground="{DynamicResource TextBrush}"
                           Margin="0"/>

                                <!-- Дополнительные сведения для проектирования -->
                                <Grid Style="{StaticResource AttributeRowStyle}">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                        <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                                    </Grid.ColumnDefinitions>

                                    <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                        <TextBlock Text="Доп. сведения для проектирования:" Style="{StaticResource AttributeLabelTextStyle}"/>
                                    </Border>

                                    <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.DesignComment}" TextWrapping="Wrap" Style="{StaticResource AttributeValueStyle}"/>
                                </Grid>

                                <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

                                <!-- Дополнительные сведения для производства -->
                                <Grid Style="{StaticResource AttributeRowStyle}">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                        <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                                    </Grid.ColumnDefinitions>

                                    <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                        <TextBlock Text="Доп. сведения для производства:" Style="{StaticResource AttributeLabelTextStyle}"/>
                                    </Border>

                                    <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.ManufacturingComment}" TextWrapping="Wrap" Style="{StaticResource AttributeValueStyle}"/>
                                </Grid>
                            </StackPanel>
                        </Grid>
                    </ScrollViewer>
                </Border>
            </Grid>
        </Border>
    </Grid>
</UserControl>

using System;
using System.Collections.ObjectModel;
using System.ComponentModel;
using System.Linq;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Input;
using Fox;
using Fox.Core;
using Fox.Core.ErrorHelper;
using Fox.Core.Logging;
using Fox.DatabaseService;
using Fox.DatabaseService.Entities;

using ModalWindows.Entities;
using OrderApprovalSystem.Data;
using OrderApprovalSystem.Models;
using OrderApprovalSystem.Services;
using OrderApprovalSystem.Validators;
using OrderApprovalSystem.Views;


namespace OrderApprovalSystem.ViewModels
{
    public class vmOrderManager : VMBase
    {
        public OrderManager View;
        public mOrderManager Model;

        #region Инициализация

        public vmOrderManager()
        {

        }

        public void viewLoaded(object _sender, RoutedEventArgs _routedEventArgs)
        {
            View = (OrderManager)view;
            Model = (mOrderManager)model;

            NomenclatureGroups = new ObservableCollection<string>();
            NomenclatureGroups.Add("Первая");
            NomenclatureGroups.Add("Вторая");
            NomenclatureGroups.Add("Третья");
            OnPropertyChanged(nameof(NomenclatureGroups));

            EquipmentTypes = new ObservableCollection<OrderApprovalTypes>(ServiceLocator.DatabaseService.mGetQuery<OrderApprovalTypes>().ToList());

            Model.PropertyChanged += modelPropertyChangedHandler;
        }

        public void modelPropertyChangedHandler(object _sender, PropertyChangedEventArgs _eventArgs)
        {
            if (_eventArgs.PropertyName == nameof(Model.CurrentGroup) && View?.dgReport != null)
            {
                ScrollToCurrentGroup();
            }
        }

        #endregion Инициализация

        #region Команды

        public CommandBase NavigatePreviousCommand
        {
            get { return _navigatePreviousCommand ?? (_navigatePreviousCommand = new CommandBase(NavigatePrevious)); }
        }

        public CommandBase NavigateNextCommand
        {
            get { return _navigateNextCommand ?? (_navigateNextCommand = new CommandBase(NavigateNext)); }
        }

        public CommandBase NavigatePreviousGroupCommand
        {
            get { return _navigatePreviousGroupCommand ?? (_navigatePreviousGroupCommand = new CommandBase(NavigatePreviousGroup)); }
        }

        public CommandBase NavigateNextGroupCommand
        {
            get { return _navigateNextGroupCommand ?? (_navigateNextGroupCommand = new CommandBase(NavigateNextGroup)); }
        }

        public CommandBase pNavigateToDevCommand => new CommandBase(() => NavigateToDev());

        public CommandBase pApprovalOrderCommand => new CommandBase(() => ApprovalOrder());

        public CommandBase pRejectOrderCommand => new CommandBase(() => RejectOrder());
        public CommandBase pOrderByMemoCommand => new CommandBase(() => CreateOrderByMemo());

        #endregion Команды

        #region Свойства

        public string SearchText
        {
            get { return _searchText; }
            set
            {
                if (_searchText != value)
                {
                    _searchText = value;
                    OnPropertyChanged(nameof(SearchText));
                    PerformSearch();
                }
            }
        }

        #endregion Свойства

        #region переменные

        private CommandBase _navigatePreviousCommand;
        private CommandBase _navigateNextCommand;
        private CommandBase _navigatePreviousGroupCommand;
        private CommandBase _navigateNextGroupCommand;
        private string _searchText;

        #endregion переменные

        private void PerformSearch()
        {
            if (Model == null)
            {
                return;
            }
            Model.FindAndNavigate(SearchText);
        }

        private void NavigatePrevious()
        {
            if (Model?.HasPrevious == true)
            {
                Model.CurrentIndex--;
                Model.CurrentItem = Model.CurrentGroup.Items[Model.CurrentIndex];
            }
        }

        private void NavigateNext()
        {
            if (Model?.HasNext == true)
            {
                Model.CurrentIndex++;
                Model.CurrentItem = Model.CurrentGroup.Items[Model.CurrentIndex];
            }
        }

        private void NavigatePreviousGroup()
        {
            if (Model?.HasPreviousGroup == true)
            {
                Model.NavigatePreviousGroup();
            }
        }

        private void NavigateNextGroup()
        {
            if (Model?.HasNextGroup == true)
            {
                Model.NavigateNextGroup();
            }
        }

        /// <summary>
        /// Переход к Dev
        /// </summary>
        private void NavigateToDev()
        {
            if (View?.Parent is ContentControl contentControl &&
                contentControl.DataContext is vmMain vmMain)
            {
                vmMain.NavigateTo<vmDev>();
            }
        }

        private void ScrollToCurrentGroup()
        {
            if (View?.dgReport != null && Model?.CurrentGroup != null)
            {
                // Используем Dispatcher для асинхронной прокрутки
                Application.Current.Dispatcher.BeginInvoke(new Action(() =>
                {
                    try
                    {
                        View.dgReport.ScrollIntoView(Model.CurrentGroup);
                        View.dgReport.Focus();
                    }
                    catch (Exception ex)
                    {
                        LoggerManager.MainLogger.Error($"Error scrolling to current group: {ex.Message}");
                    }
                }), System.Windows.Threading.DispatcherPriority.Background);
            }
        }

        private void ApprovalOrder()
        {
            if (Model.CurrentGroup.IsByMemo)
            {
                ApproveOrderByMemo();
                return;
            }
            ApproveTechnologicalOrder();
        }
        
        private void ApproveOrderByMemo()
        {
            string operationName = "Согласование заказа по СЗ";
            Result result = null;

            TransactionHelper.ExecuteWithTransaction(
                    businessLogic: () =>
                    {
                        result = Model.ApproveOrder();
                    },
                    errorHandler: errorContext =>
                    {
                        if (errorContext.Exception is OperationCanceledException)
                        {
                            LoggerManager.MainLogger.Error($"Операция - <{operationName}> отменена: {errorContext.Exception.Message}");
                            LoggerManager.MainLogger.Debug(
                                ErrorHelper.FormatErrorMessage(
                                    errorContext.Exception,
                                    "vmSubTechnologist.ApprovalOrder",
                                    errorContext.ErrorDetail
                                )
                            );
                            DialogService.ShowError(errorContext.Exception.Message, operationName);
                        }
                        else
                        {
                            LoggerManager.MainLogger.Error($"Операция - <{operationName}> прервана ошибкой: {errorContext.Exception.Message}");
                            LoggerManager.MainLogger.Error(
                                ErrorHelper.FormatErrorMessage(
                                    errorContext.Exception,
                                    "vmSubTechnologist.ApprovalOrder",
                                    errorContext.ErrorDetail
                                )
                            );

                            if (errorContext.ShouldLogToErrorHelper)
                            {
                                ErrorHelper.SendError(
                                    errorContext.Exception,
                                    "vmSubTechnologist.ApprovalOrder",
                                    errorContext.ErrorDetail
                                );
                            }

                            DialogService.ShowError("Критическая ошибка сохранения", operationName);
                        }
                    },
                    operationName: operationName,
                    model: Model,
                    isTransactionOwner: !ServiceLocator.DatabaseService.HasActiveTransaction
                );
            DialogService.HandleResult(result, $"{operationName}: {Model.CurrentItem.MemoNumber}");
        }

        private void ApproveTechnologicalOrder()
        {
            string operationName = "Согласование заказа";
            Result result = null;
                TransactionHelper.ExecuteWithTransaction(
                    businessLogic: () =>
                    {
                        result = Model.ApproveOrder();
                        if (!result.IsSuccess)
                        {
                            throw new OperationCanceledException(result.Message);
                        }
                        DialogService.HandleResult(result, operationName);
                    },
                    errorHandler: errorContext =>
                    {
                        errorContext.ErrorDetail["Order"] = Model.CurrentGroup.Zak1;
                        errorContext.ErrorDetail["Draft"] = Model.CurrentItem.EquipmentDraft;

                        if (errorContext.Exception is OperationCanceledException)
                        {
                            LoggerManager.MainLogger.Error($"Операция - <{operationName}> отменена: {errorContext.Exception.Message}");
                            LoggerManager.MainLogger.Debug(
                                ErrorHelper.FormatErrorMessage(
                                    errorContext.Exception,
                                    "vmSubTechnologist.ApprovalOrder",
                                    errorContext.ErrorDetail
                                )
                            );
                            DialogService.ShowError(errorContext.Exception.Message, operationName);
                        }
                        else
                        {
                            LoggerManager.MainLogger.Error($"Операция - <{operationName}> прервана ошибкой: {errorContext.Exception.Message}");
                            LoggerManager.MainLogger.Error(
                                ErrorHelper.FormatErrorMessage(
                                    errorContext.Exception,
                                    "vmSubTechnologist.ApprovalOrder",
                                    errorContext.ErrorDetail
                                )
                            );

                            if (errorContext.ShouldLogToErrorHelper)
                            {
                                ErrorHelper.SendError(
                                    errorContext.Exception,
                                    "vmSubTechnologist.ApprovalOrder",
                                    errorContext.ErrorDetail
                                );
                            }

                            DialogService.ShowError("Критическая ошибка сохранения", operationName);
                        }
                    },
                    operationName: operationName,
                    model: Model,
                    isTransactionOwner: !ServiceLocator.DatabaseService.HasActiveTransaction
                );
        }
        
        private void RejectOrder()
        {
            string operationName = "НЕ согласование заказа";
            Result result = null;

            if (Model.CurrentItem.IsByMemo)
            {
                DialogService.HandleResult(
                    Result.Failed("Нельзя НЕ согласовывать заказ по СЗ!")
                );
                return;
            }

            ModalResult userAnswer = DialogService.ShowReject(
                "Заполните данные",
                $"НЕ согласовывать заказ: {Model.CurrentItem.OrderNumber} (СЗ: {Model.CurrentItem.MemoNumber})",
                vm => RejectOrderModalValidator.Validate(vm),
                Model.CurrentItem.OrderApprovalID
            );

            if (userAnswer.IsDismissed || userAnswer.IsCancelled)
            {
                result = Result.Success("Отменено пользователем").HideMessage();
            }
            if (userAnswer.IsValidationFailed)
            {
                result = Result.Failed("Не пройдена валидация");
            }
            if (userAnswer.IsValid)
            {
                TransactionHelper.ExecuteWithTransaction(
                    businessLogic: () =>
                    {
                        result = Model.RejectOrder(userAnswer.Data);                      
                        if (!result.IsSuccess)
                        {
                            throw new OperationCanceledException(result.Message);
                        }
                        DialogService.HandleResult(result, operationName);
                    },
                    errorHandler: errorContext =>
                    {
                        errorContext.ErrorDetail["Order"] = Model.CurrentGroup.Zak1;
                        errorContext.ErrorDetail["Draft"] = Model.CurrentItem.EquipmentDraft;
                        errorContext.ErrorDetail["ApprovalData"] = userAnswer.Data.ToString();

                        if (errorContext.Exception is OperationCanceledException)
                        {
                            LoggerManager.MainLogger.Error($"Операция - <{operationName}> отменена: {errorContext.Exception.Message}");
                            LoggerManager.MainLogger.Debug(
                                ErrorHelper.FormatErrorMessage(
                                    errorContext.Exception,
                                    "vmOrderManager.RejectOrder",
                                    errorContext.ErrorDetail
                                )
                            );
                            DialogService.ShowError(errorContext.Exception.Message, operationName);
                        }
                        else
                        {
                            LoggerManager.MainLogger.Error($"Операция - <{operationName}> прервана ошибкой: {errorContext.Exception.Message}");
                            LoggerManager.MainLogger.Error(
                                ErrorHelper.FormatErrorMessage(
                                    errorContext.Exception,
                                    "vmOrderManager.RejectOrder",
                                    errorContext.ErrorDetail
                                )
                            );

                            if (errorContext.ShouldLogToErrorHelper)
                            {
                                ErrorHelper.SendError(
                                    errorContext.Exception,
                                    "vmOrderManager.RejectOrder",
                                    errorContext.ErrorDetail
                                );
                            }

                            DialogService.ShowError("Критическая ошибка сохранения", operationName);
                        }
                    },
                    operationName: operationName,
                    model: Model,
                    isTransactionOwner: !ServiceLocator.DatabaseService.HasActiveTransaction
                );
            }
        }

        private void CreateOrderByMemo()
        {
            Model.CreateOrderByMemo();
        }


        private ObservableCollection<string> _nomenclatureGroups;
        private ObservableCollection<OrderApprovalTypes> _equipmentTypes;
        public ObservableCollection<OrderApprovalTypes> EquipmentTypes
        {
            get => _equipmentTypes;
            set
            {
                if (_equipmentTypes != value)
                {
                    _equipmentTypes = value;
                    OnPropertyChanged(nameof(EquipmentTypes));
                }
            }
        }

        public ObservableCollection<string> NomenclatureGroups
        {
            get => _nomenclatureGroups;
            set
            {
                if (_nomenclatureGroups != value)
                {
                    _nomenclatureGroups = value;
                    OnPropertyChanged(nameof(NomenclatureGroups));
                }
            }
        }
    }

}

using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Data;
using System.Globalization;
using System.Linq;
using System.Windows.Forms;
using Fox;
using Fox.Core;
using Fox.Core.Logging;
using Fox.DatabaseService.Entities;
using OrderApprovalSystem.Data;
using OrderApprovalSystem.Data.Entities;
using OrderApprovalSystem.Services;
using OrderApprovalSystem.Validators;


namespace OrderApprovalSystem.Models
{
    public class mOrderManager : MBase
    {
        private Fox.DatabaseService.IDatabaseService db = ServiceLocator.DatabaseService;
        private ObservableCollection<string> _nomenclatureGroups;
        public ObservableCollection<string> NomenclatureGroups
        {
            get => _nomenclatureGroups;
            set
            {
                _nomenclatureGroups = value;
                OnPropertyChanged(nameof(NomenclatureGroups));
            }
        }

        private ObservableCollection<OrderApprovalTypes> _equipmentTypes;
        public ObservableCollection<OrderApprovalTypes> EquipmentTypes
        {
            get => _equipmentTypes;
            set
            {
                _equipmentTypes = value;
                OnPropertyChanged(nameof(EquipmentTypes));
            }
        }


        /// <summary>
        /// Конструктор
        /// </summary>
        public mOrderManager()
        {
            NomenclatureGroups = new ObservableCollection<string>();
            NomenclatureGroups.Add("Первая");
            NomenclatureGroups.Add("Вторая");
            NomenclatureGroups.Add("Третья");
            EquipmentTypes = new ObservableCollection<OrderApprovalTypes>(
                db.mGetQuery<OrderApprovalTypes>().ToList()    
            );
            LoadData();
        }

        public void NavigatePrevious()
        {
            if (HasPrevious)
            {
                CurrentIndex--;
                CurrentItem = CurrentGroup.Items[CurrentIndex];
            }
        }

        public void NavigateNext()
        {
            if (HasNext)
            {
                CurrentIndex++;
                CurrentItem = CurrentGroup.Items[CurrentIndex];
            }
        }

        public void NavigateNextGroup()
        {
            if (HasNextGroup)
            {
                CurrentGroup = GroupedData[CurrentGroupIndex + 1];
            }
        }

        public void NavigatePreviousGroup()
        {
            if (HasPreviousGroup)
            {
                CurrentGroup = GroupedData[CurrentGroupIndex - 1];
            }
        }

        public void FindAndNavigate(string searchText)
        {
            if (string.IsNullOrWhiteSpace(searchText) || GroupedData == null)
            {
                return;
            }

            string query = searchText.ToLower().Trim();

            var targetGroup = GroupedData.FirstOrDefault(
                g =>
                g.Zak1 != null && g.Zak1.ToLower().Contains(query)
            );
            if (targetGroup != null)
            {
                if (CurrentGroup != targetGroup)
                {
                    CurrentGroup = targetGroup;
                }
                return;
            }
        }

        public Result ApproveOrder()
        {
            Result validationResult = CreateOrderByMemoValidator.Validate(CurrentItem);
            if (validationResult.IsFailed)
            {
                return validationResult;
            }

            if (CurrentGroup.IsByMemo)
            {
                return ApproveOrderByMemo();
            }

            return ApproveTechnologicalOrder();
        }

        private Result ApproveOrderByMemo()
        {
            if (!string.IsNullOrEmpty(CurrentItem.MemoNumber))
            {
                CurrentGroup.Zak1 = CurrentItem.MemoNumber;
            }

            Result validationResult = CreateOrderByMemoValidator.Validate(CurrentItem);
            if (validationResult.IsFailed)
            {
                return validationResult;
            }

            db.mAdd(
                new OrderApproval
                {
                    IsByMemo = CurrentGroup.IsByMemo,
                    MemoNumber = CurrentItem.MemoNumber,
                    MemoAuthor = CurrentItem.MemoAuthor,
                    Order = CurrentItem.OrderByMemo,
                    Number = CurrentItem.NumberByMemo,
                    OrderName = CurrentItem.OrderName,
                    CoreOrder = CurrentItem.CoreOrderByMemo,
                    CoreNumber = CurrentItem.CoreNumberByMemo,
                    OpenAtByMemo = CurrentItem.OpenAtByMemo,
                    NomenclatureGroup = CurrentItem.NomenclatureGroup,
                    EquipmentTypeID = CurrentItem.EquipmentType.ID,
                    DraftByMemo = CurrentItem.DraftByMemo,
                    DraftNameByMemo = CurrentItem.DraftNameByMemo,
                    Balance = CurrentItem.Balance,
                    WorkshopByMemo = CurrentItem.WorkshopByMemo,
                    EquipmentRequiredQuantityByMemo = CurrentItem.EquipmentRequiredQuantityByMemo
                }
           );
            db.mSaveChanges();

            OrderApproval addedRecord = db.mGetQuery<OrderApproval>().OrderByDescending(
                record =>
                record.ID
            ).FirstOrDefault();

            db.mAdd(
                new OrderApprovalHistory
                {
                    OrderApprovalID = addedRecord.ID,
                    ReceiptDate = DateTime.Now,
                    CompletionDate = DateTime.Now,
                    Term = DateTime.Now.Date.AddDays(1),
                    RecipientRole = "дальше",
                    RecipientName = "кто-то",
                    SenderRole = "Менеджер заказов",
                    SenderName = "Папаева",
                    Status = "Выполнено",
                    Result = "Согласовано"
                }
            );
            return Result.Success();
        }

        private Result ApproveTechnologicalOrder()
        {
            OrderApproval thisRecord = db.mGetSingle<OrderApproval>(
               record =>
               record.ID == CurrentItem.OrderApprovalID
            ).Data;
            thisRecord.Order = CurrentItem.OrderByMemo;
            thisRecord.Number = CurrentItem.NumberByMemo;
            thisRecord.OrderName = CurrentItem.OrderName;
            thisRecord.CoreOrder = CurrentItem.CoreOrderByMemo;
            thisRecord.CoreNumber = CurrentItem.CoreNumberByMemo;
            thisRecord.OpenAtByMemo = CurrentItem.OpenAtByMemo;
            thisRecord.NomenclatureGroup = CurrentItem.NomenclatureGroup;
            thisRecord.EquipmentTypeID = CurrentItem.EquipmentType.ID;
            thisRecord.DraftByMemo = CurrentItem.DraftByMemo;
            thisRecord.DraftNameByMemo = CurrentItem.DraftNameByMemo;
            thisRecord.Balance = CurrentItem.Balance;
            thisRecord.WorkshopByMemo = CurrentItem.WorkshopByMemo;
            thisRecord.EquipmentRequiredQuantityByMemo = CurrentItem.EquipmentRequiredQuantityByMemo;
            db.mUpdate(thisRecord);

            OrderApprovalHistory thisStep = db.mGetList<OrderApprovalHistory>(
                record =>
                record.OrderApprovalID == thisRecord.ID
            ).Data.OrderByDescending(record => record.ID).FirstOrDefault();
            thisStep.CompletionDate = DateTime.Now;
            thisStep.Status = "Выполнено";
            thisStep.Result = "Согласовано";
            db.mUpdate(thisStep);

            // Получение количества рабочих дней для согласования
            int workingDaysCount = db.mGetQuery<OrderApproval>()
                .Where(order => order.ID == CurrentItem.OrderApprovalID)
                .Join(
                    db.mGetQuery<OrderApprovalTypes>(),
                    order => order.EquipmentTypeID,
                    approvalType => approvalType.ID,
                    (order, approvalType) => approvalType.Term
                )
                .FirstOrDefault();

            // Получение даты выполнения с учетом рабочих дней
            DateTime deadlineDate = db.mGetQuery<calend>()
                .Where(calendarDay => calendarDay.mday > thisStep.ReceiptDate && calendarDay.v == true)
                .OrderBy(calendarDay => calendarDay.mday)
                .Skip(workingDaysCount - 1) // Пропускаем N-1 рабочих дней
                .Take(1)
                .Select(calendarDay => calendarDay.mday)
                .FirstOrDefault();

            // Если не нашли дату в календаре, используем простое сложение дней
            if (deadlineDate == default(DateTime))
            {
                deadlineDate = DateTime.Today.AddDays(workingDaysCount);
            }
            OrderApprovalHistory nextStep = new OrderApprovalHistory
            {
                OrderApprovalID = thisRecord.ID,
                ReceiptDate = DateTime.Now,
                CompletionDate = null,
                Term = deadlineDate,
                RecipientRole = "Кто - то после менеджера",
                RecipientName = "Кто-то после менеджера",
                SenderRole = "Менеджер заказов",
                SenderName = "Папаева",
                Status = "В работе",
                Result = null
            };
            db.mAdd(nextStep);

            return Result.Success();
        }

        public Result RejectOrder(Dictionary<string, object> data)
        {
            LoggerManager.MainLogger.Debug("Call RejectOrder");

            try
            {
                // Находим ID последней записи согласования для технолога Рагульского
                var maxId = db.mGetQuery<OrderApprovalHistory>()
                    .Where(oah => oah.OrderApprovalID == CurrentItem.OrderApprovalID
                               && oah.RecipientRole == "Менеджер заказов"
                               && oah.RecipientName == "Папаева")
                    .Select(oah => oah.ID)
                    .Max();

                // Получаем последнюю запись согласования
                OrderApprovalHistory previousStepRecord = db.mGetSingle<OrderApprovalHistory>(
                    record => record.ID == maxId
                ).Data;

                if (previousStepRecord is null)
                {
                    LoggerManager.MainLogger.Error("Не найдена прошлая строка согласования");
                    return Result.Failed("Не найдена предыдущая запись согласования");
                }

                // Обновляем текущую запись согласования
                previousStepRecord.Status = "Выполнено";
                previousStepRecord.Result = "На доработку";
                previousStepRecord.CompletionDate = DateTime.Now;

                Result updateResult = db.mUpdate(previousStepRecord);
                if (updateResult.IsFailed)
                {
                    LoggerManager.MainLogger.Error($"Ошибка при обновлении записи: {updateResult.Message}");
                    return Result.Failed("Не удалось обновить запись согласования");
                }

                // Получение количества рабочих дней для согласования из OrderApprovalTypes
                int workingDaysCount = db.mGetQuery<OrderApproval>()
                    .Where(order => order.ID == CurrentItem.OrderApprovalID)
                    .Join(
                        db.mGetQuery<OrderApprovalTypes>(),
                        order => order.EquipmentTypeID,
                        approvalType => approvalType.ID,
                        (order, approvalType) => approvalType.Term
                    )
                    .FirstOrDefault();

                if (workingDaysCount <= 0)
                {
                    LoggerManager.MainLogger.Error($"Not found term for approvalType:");
                    return Result.Failed("Не найден срок для назначения согласования!");
                }

                // Расчет даты выполнения с учетом рабочих дней
                DateTime today = DateTime.Today;
                DateTime deadlineDate;

                // Получаем ближайшую рабочую дату после сегодняшней
                var firstWorkingDay = db.mGetQuery<calend>()
                    .Where(calendarDay => calendarDay.mday > today && calendarDay.v == true)
                    .OrderBy(calendarDay => calendarDay.mday)
                    .FirstOrDefault();

                if (firstWorkingDay != null)
                {
                    // Ищем дату, отстоящую на workingDaysCount рабочих дней вперед
                    deadlineDate = db.mGetQuery<calend>()
                        .Where(calendarDay => calendarDay.mday > today && calendarDay.v == true)
                        .OrderBy(calendarDay => calendarDay.mday)
                        .Skip(workingDaysCount - 1) // Пропускаем N-1 рабочих дней
                        .Take(1)
                        .Select(calendarDay => calendarDay.mday)
                        .FirstOrDefault();
                }
                else
                {
                    return Result.Failed("Ошибка установки строка согласования");
                }

                // Если не нашли дату в календаре, используем простое сложение дней
                if (deadlineDate == default(DateTime))
                {
                    // Добавляем рабочие дни + возможные выходные
                    deadlineDate = today.AddDays(workingDaysCount * 1.4); // коэффициент для учета выходных
                }

                // Извлечение данных из входного словаря
                string recipientRole = (string)data["Subdivision"];
                string recipientName = (string)data["SubdivisionRecipient"];
                string comment = (string)data["Comment"];

                // Создание новой записи для следующего этапа согласования
                OrderApprovalHistory nextStepRecord = new OrderApprovalHistory
                {
                    OrderApprovalID = CurrentItem.OrderApprovalID,
                    ReceiptDate = DateTime.Now,
                    CompletionDate = null, // Для новой записи CompletionDate должен быть null
                    Term = deadlineDate,
                    RecipientRole = recipientRole,
                    RecipientName = recipientName,
                    SenderRole = "Менеджер заказов",
                    SenderName = "Папаева",
                    Status = "В работе", // Новая запись начинается со статуса "В работе"
                    Result = null, // Результат еще не определен
                    Comment = comment
                };

                Result addResult = db.mAdd(nextStepRecord);
                if (addResult.IsFailed)
                {
                    LoggerManager.MainLogger.Error($"Ошибка при добавлении записи: {addResult.Message}");
                    return Result.Failed("Не удалось создать новую запись согласования");
                }

                LoggerManager.MainLogger.Info($"Заказ отклонен и перенаправлен в {recipientRole} - {recipientName}");
                return Result.Success();
            }
            catch (Exception ex)
            {
                LoggerManager.MainLogger.Error($"Ошибка в RejectOrder: {ex.Message}", ex);
                return Result.Failed($"Произошла ошибка при отклонении заказа: {ex.Message}");
            }
        }

        #region Свойства

        public ObservableCollection<TechnologistGroup> GroupedData
        {
            get => _groupedData;
            set
            {
                _groupedData = value;
                OnPropertyChanged(nameof(TotalGroups));
                if (_groupedData != null && _groupedData.Any())
                {
                    CurrentGroup = _groupedData.First();
                }
            }
        }

        public TechnologistGroup CurrentGroup
        {
            get => _currentGroup;
            set
            {
                _currentGroup = value;
                OnPropertyChanged(nameof(CurrentGroup));

                if (_groupedData != null && _currentGroup != null)
                {
                    CurrentGroupIndex = _groupedData.IndexOf(_currentGroup);
                }

                OnPropertyChanged(nameof(CurrentGroupIndexDisplay));
                OnPropertyChanged(nameof(HasPreviousGroup));
                OnPropertyChanged(nameof(HasNextGroup));

                if (_currentGroup != null && _currentGroup.Items.Any())
                {
                    CurrentItem = _currentGroup.Items.First();
                    CurrentIndex = 0;
                }
                else
                {
                    CurrentItem = null;
                    CurrentIndex = 0;
                }
            }
        }

        public TechnologicalOrder CurrentItem
        {
            get => _currentItem;
            set
            {
                _currentItem = value;

                // Обновляем индекс строки при изменении CurrentItem
                if (_currentGroup != null && _currentItem != null && _currentGroup.Items.Contains(_currentItem))
                {
                    CurrentIndex = _currentGroup.Items.IndexOf(_currentItem);
                }

                OnPropertyChanged(nameof(CurrentItem));
                OnPropertyChanged(nameof(CurrentIndexDisplay));
                OnPropertyChanged(nameof(HasPrevious));
                OnPropertyChanged(nameof(HasNext));
            }
        }

        public int CurrentGroupIndex
        {
            get => _currentGroupIndex;
            set
            {
                _currentGroupIndex = value;
                OnPropertyChanged(nameof(CurrentGroupIndex));
                OnPropertyChanged(nameof(CurrentGroupIndexDisplay));
                OnPropertyChanged(nameof(HasPreviousGroup));
                OnPropertyChanged(nameof(HasNextGroup));
            }
        }

        public int CurrentIndex
        {
            get => _currentIndex;
            set
            {
                _currentIndex = value;
                OnPropertyChanged(nameof(CurrentIndex));
                OnPropertyChanged(nameof(CurrentIndexDisplay));
                OnPropertyChanged(nameof(HasPrevious));
                OnPropertyChanged(nameof(HasNext));
            }
        }

        public string CurrentGroupIndexDisplay =>
            GroupedData != null && GroupedData.Any()
                ? $"{CurrentGroupIndex + 1} из {GroupedData.Count}"
                : "0 из 0";

        public string CurrentIndexDisplay =>
            CurrentGroup != null && CurrentGroup.Items.Any()
                ? $"{CurrentIndex + 1} из {CurrentGroup.Items.Count}"
                : "0 из 0";

        public bool HasPrevious => CurrentGroup != null && CurrentIndex > 0;
        public bool HasNext => CurrentGroup != null && CurrentIndex < CurrentGroup.Items.Count - 1;
        public bool HasPreviousGroup => GroupedData != null && CurrentGroupIndex > 0;
        public bool HasNextGroup => GroupedData != null && CurrentGroupIndex < GroupedData.Count - 1;
        public int TotalGroups => GroupedData?.Count ?? 0;

        #endregion Свойства

        #region Переменные

        private ObservableCollection<TechnologistGroup> _groupedData;
        private TechnologistGroup _currentGroup;
        private TechnologicalOrder _currentItem;
        private int _currentIndex = 0;
        private int _currentGroupIndex = 0;

        #endregion Переменные

        public Result CreateOrderByMemo()
        {
            TechnologistGroup newGroup = new TechnologistGroup
            {
                Zak1 = "СЗ",
                IsByMemo = true,
                Items = new ObservableCollection<TechnologicalOrder>
                {
                    new TechnologicalOrder 
                    {
                        IsByMemo = true
                    }
                }
            };
            GroupedData.Add(newGroup);
            CurrentGroup = newGroup;
            return Result.Success();
        }

        private void LoadData()
        {
            try
            {
                Fox.DatabaseService.IDatabaseService db = ServiceLocator.DatabaseService;

                IQueryable<TechnologicalOrder> query =
                    from OrderApproval in db.mGetQuery<OrderApproval>()
                    join OrderApprovalDrafts in db.mGetQuery<OrderApprovalDrafts>() on OrderApproval.ID equals OrderApprovalDrafts.OrderApprovalID
                    join zayvka in db.mGetQuery<zayvka>() on OrderApproval.zayvkaID equals zayvka.id
                    join os_pro in db.mGetQuery<os_pro>() on zayvka.zak_1 equals os_pro.zak_1

                    // LEFT JOIN oborud
                    join oborud in db.mGetQuery<oborud>() on zayvka.rab_m equals oborud.rab_m into obGroup
                    from oborud in obGroup.DefaultIfEmpty()

                        // LEFT JOIN s_oper
                    join s_oper in db.mGetQuery<s_oper>() on zayvka.kodop equals s_oper.code into soGroup
                    from s_oper in soGroup.DefaultIfEmpty()

                        // LEFT JOIN prod
                    join p in db.mGetQuery<prod>()
                        on new { zayvka.zak_1, IsDrNull = (decimal?)null }
                        equals new { p.zak_1, IsDrNull = p.dr } into pGroup
                    from p in pGroup.DefaultIfEmpty()

                    where os_pro.d_vn_14 != null

                    orderby zayvka.zak_1

                    select new TechnologicalOrder
                    {
                        OrderNumber = zayvka.zak_1,
                        OrderApprovalID = OrderApproval.ID,
                        OrderApprovalDraftID = OrderApprovalDrafts.ID,
                        Technologist = OrderApproval.Technologist,
                        CoreDraft = (decimal)OrderApproval.CoreDraft,
                        Draft = OrderApproval.Draft,
                        CoreDraftName = OrderApproval.CoreDraftName.Trim(),
                        DraftName = OrderApproval.DraftName.Trim(),

                        Workshop = OrderApproval.Workshop,
                        Warehouse = OrderApproval.Warehouse,
                        Schedule = zayvka.graf,

                        Workplace = oborud != null ? (oborud.code + " " + oborud.oborud1).Trim() : null,
                        Operation = s_oper != null ? s_oper.oper.Trim() : null,

                        EquipmentDraft = OrderApprovalDrafts.EquipmentDraft,
                        EquipmentName = OrderApprovalDrafts.EquipmentName.Trim(),
                        EquipmentNameFromTechologist = OrderApproval.EquipmentNameFromTechnologist.Trim(),
                        EquipmentQuantityForOperation = OrderApproval.EquipmentQuantityForOperation,
                        EquimentRequiredQuantity = OrderApprovalDrafts.EquimentRequiredQuantity,
                        Cooperation = OrderApprovalDrafts.Cooperation,
                        IsDeletedFromOrder = OrderApprovalDrafts.IsDeletedFromOrder,

                        Note = zayvka.prim,
                        Analog = OrderApproval.Analog,
                        DesignComment = OrderApprovalDrafts.CommentForDesign,
                        ManufacturingComment = OrderApprovalDrafts.CommentForManufacturing,
                        OpenAtByTechnologist = OrderApproval.OpenAt,
                        Comment = null,

                        IsByMemo = OrderApproval.IsByMemo,
                        MemoNumber = OrderApproval.MemoNumber,
                        MemoAuthor = OrderApproval.MemoAuthor,
                        CoreOrderByMemo = OrderApproval.CoreOrder,
                        CoreNumberByMemo = OrderApproval.CoreNumber,
                        OrderByMemo = OrderApproval.Order,
                        NumberByMemo = OrderApproval.Number,
                        OrderName = OrderApproval.OrderName,
                        OpenAtByMemo = OrderApproval.OpenAtByMemo,
                        NomenclatureGroup = OrderApproval.NomenclatureGroup,
                        EquipmentTypeID = OrderApproval.EquipmentTypeID,
                        DraftByMemo = OrderApproval.DraftByMemo,
                        DraftNameByMemo = OrderApproval.DraftNameByMemo,
                        Balance = OrderApproval.Balance,
                        WorkshopByMemo = OrderApproval.WorkshopByMemo,
                        EquipmentRequiredQuantityByMemo = OrderApproval.EquipmentRequiredQuantityByMemo
                    };

                List<TechnologicalOrder> data = query.Distinct().ToList();
                foreach (TechnologicalOrder order in data)
                {
                    order.EquipmentType = ConvertToOrderApprovalType(order.EquipmentTypeID);
                }

                GroupedData = new ObservableCollection<TechnologistGroup>
                (
                    data
                    .OrderBy(x => x.EquipmentDraft)
                    .GroupBy(x => x.OrderNumber)
                    .Select(
                        g =>
                        new TechnologistGroup
                        {
                            Zak1 = g.Key,
                            Items = new ObservableCollection<TechnologicalOrder>(g.OrderBy(x => x.OpenAtByTechnologist).ToList()),
                            IsByMemo = false
                        }
                    )
                    .OrderBy(g => g.Zak1)
                    .ToList()
                );
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error: {ex.Message}");
            }
        }

        private OrderApprovalTypes ConvertToOrderApprovalType(int? typeId)
        {
            return ServiceLocator.DatabaseService.mGetSingle<OrderApprovalTypes>(
                record =>
                record.ID == typeId
            ).Data;
        }
    }

}

<UserControl 
        x:Class="OrderApprovalSystem.Views.HeadOrderDepartment"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:ribbon="clr-namespace:System.Windows.Controls.Ribbon;assembly=System.Windows.Controls.Ribbon"
        xmlns:local="clr-namespace:OrderApprovalSystem.Views"
        xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
        xmlns:behaviors="clr-namespace:OrderApprovalSystem.Behaviors"
        xmlns:converters="clr-namespace:OrderApprovalSystem.Converters"
        Background="{DynamicResource PrimaryBackgroundBrush}"
        Foreground="{DynamicResource TextBrush}">

    <UserControl.Resources>
        <converters:IsByMemoToTextConverter x:Key="IsByMemoToTextConverter"/>
        <converters:MaskedDateConverter x:Key="MaskedDateConverter"/>
    </UserControl.Resources>

    <i:Interaction.Triggers>
        <i:EventTrigger EventName="Loaded">
            <i:CallMethodAction TargetObject="{Binding}" MethodName="viewLoaded"/>
        </i:EventTrigger>
    </i:Interaction.Triggers>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="0.40*"/>
            <ColumnDefinition Width="0.3*"/>
            <ColumnDefinition Width="0.30*"/>
        </Grid.ColumnDefinitions>

        <Border Grid.Column="0" 
                Margin="5" 
                BorderThickness="2" 
                BorderBrush="{DynamicResource AccentBrush}" 
                Background="{DynamicResource SecondaryBackgroundBrush}"
                CornerRadius="4">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Заголовок таблицы -->
                <Border Grid.Row="0"
                        Background="{DynamicResource AccentBrush}"
                        CornerRadius="2,2,0,0"
                        Padding="10">
                    <TextBlock Text="Технологические заказы (HeadOrderDepartment)"
                               Foreground="White"
                               FontSize="14"
                               FontWeight="Bold"
                               HorizontalAlignment="Center"/>
                </Border>

                <!-- DataGrid с группами заказов -->
                <DataGrid Grid.Row="1"
                          IsReadOnly="True"
                          AutoGenerateColumns="False"
                          SelectionMode="Single"
                          HeadersVisibility="Column"
                          HorizontalScrollBarVisibility="Disabled"
                          CanUserAddRows="False"
                          x:Name="dgReport" 
                          ItemsSource="{Binding model.GroupedData}" 
                          SelectedItem="{Binding model.CurrentGroup, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">

                    <i:Interaction.Behaviors>
                        <behaviors:ScrollIntoViewBehavior SelectedItem="{Binding model.CurrentGroup, Mode=OneWay}"/>
                    </i:Interaction.Behaviors>

                    <DataGrid.Columns>
                        <!-- Заказ - всегда показывается -->
                        <DataGridTextColumn Header="Тех. заказ" 
                        Binding="{Binding Zak1}" 
                        Width="80"/>

                        <!-- Кол-во чертежей - скрывается для СЗ -->
                        <DataGridTextColumn Header="Кол-во чертежей в заказе" 
                        Width="100">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Text" Value="{Binding Items.Count}"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsByMemo}" Value="True">
                                            <Setter Property="Text" Value=""/>
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>

                        <!-- Дата - скрывается для СЗ -->
                        <DataGridTextColumn Header="Дата" 
                        Width="Auto">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Text" Value="{Binding Items[0].OpenAtByTechnologist, StringFormat=\{0:dd.MM.yyyy\}}"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsByMemo}" Value="True">
                                            <Setter Property="Text" Value=""/>
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>

                        <!-- Чертеж ДСЕ - скрывается для СЗ -->
                        <DataGridTextColumn Header="Чертеж ДСЕ" 
                        Width="Auto">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Text" Value="{Binding Items[0].Draft}"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsByMemo}" Value="True">
                                            <Setter Property="Text" Value=""/>
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>

                        <!-- Наименование - скрывается для СЗ -->
                        <DataGridTextColumn Header="Наименование" 
                        Width="*"
                        CellStyle="{DynamicResource LeftAlignedDataGridCell}">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Text" Value="{Binding Items[0].DraftName}"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsByMemo}" Value="True">
                                            <Setter Property="Text" Value=""/>
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>

                        <!-- Тип - всегда показывается -->
                        <DataGridTextColumn Header="Тип" 
                        Width="Auto"
                        CellStyle="{DynamicResource LeftAlignedDataGridCell}">
                            <DataGridTextColumn.Binding>
                                <Binding Path="IsByMemo">
                                    <Binding.Converter>
                                        <converters:IsByMemoToTextConverter/>
                                    </Binding.Converter>
                                </Binding>
                            </DataGridTextColumn.Binding>
                        </DataGridTextColumn>
                    </DataGrid.Columns>
                </DataGrid>
            </Grid>
        </Border>

        <!-- Центральная область - поля информации об основном заказе -->
        <Border Grid.Column="1" 
        Margin="0,5,0,5" 
        BorderThickness="2" 
        BorderBrush="{DynamicResource GreenAccentBrush}" 
        Background="{DynamicResource SecondaryBackgroundBrush}"
        CornerRadius="4"
        Padding="5">

            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <Grid IsSharedSizeScope="True">
                    <StackPanel>

                        <TextBlock
                           FontSize="16"
                           FontWeight="Bold"
                           HorizontalAlignment="Center"
                           Foreground="{DynamicResource TextBrush}"
                           Margin="0">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Text" Value="Данные тех. заказа"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="True">
                                            <Setter Property="Text" Value="Данные заказа"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>

                        <!-- Технолог -->
                        <Grid>
                            <Grid.Style>
                                <Style TargetType="Grid">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Grid.Style>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Технолог:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBlock Grid.Column="1" 
                               Text="{Binding model.CurrentItem.Technologist}" 
                               Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <Separator>
                            <Separator.Style>
                                <Style TargetType="Separator" BasedOn="{StaticResource AttributeSeparatorStyle}">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Separator.Style>
                        </Separator>

                        <!-- Изделие -->
                        <Grid>
                            <Grid.Style>
                                <Style TargetType="Grid">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Grid.Style>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Изделие:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.CoreDraft}" Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <Separator>
                            <Separator.Style>
                                <Style TargetType="Separator" BasedOn="{StaticResource AttributeSeparatorStyle}">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Separator.Style>
                        </Separator>

                        <!-- Наименование изделия -->
                        <Grid>
                            <Grid.Style>
                                <Style TargetType="Grid">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Grid.Style>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Наименование изделия:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.CoreDraftName}" Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <Separator>
                            <Separator.Style>
                                <Style TargetType="Separator" BasedOn="{StaticResource AttributeSeparatorStyle}">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Separator.Style>
                        </Separator>

                        <!-- Деталь -->
                        <Grid>
                            <Grid.Style>
                                <Style TargetType="Grid">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Grid.Style>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Деталь:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.Draft}" Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <Separator>
                            <Separator.Style>
                                <Style TargetType="Separator" BasedOn="{StaticResource AttributeSeparatorStyle}">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Separator.Style>
                        </Separator>

                        <!-- Наименование детали -->
                        <Grid>
                            <Grid.Style>
                                <Style TargetType="Grid">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Grid.Style>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Наименование детали:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.DraftName}" Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <Separator>
                            <Separator.Style>
                                <Style TargetType="Separator" BasedOn="{StaticResource AttributeSeparatorStyle}">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Separator.Style>
                        </Separator>

                        <!-- Цех получатель -->
                        <Grid>
                            <Grid.Style>
                                <Style TargetType="Grid">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Grid.Style>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Цех получ.:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.Workshop}" Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <Separator>
                            <Separator.Style>
                                <Style TargetType="Separator" BasedOn="{StaticResource AttributeSeparatorStyle}">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Separator.Style>
                        </Separator>

                        <!-- Кладовая -->
                        <Grid>
                            <Grid.Style>
                                <Style TargetType="Grid">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Grid.Style>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Кладовая:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.Warehouse}" Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <Separator>
                            <Separator.Style>
                                <Style TargetType="Separator" BasedOn="{StaticResource AttributeSeparatorStyle}">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Separator.Style>
                        </Separator>

                        <!-- Рабочее место -->
                        <Grid>
                            <Grid.Style>
                                <Style TargetType="Grid">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Grid.Style>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Раб. место:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.Workplace}" Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <Separator>
                            <Separator.Style>
                                <Style TargetType="Separator" BasedOn="{StaticResource AttributeSeparatorStyle}">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Separator.Style>
                        </Separator>

                        <!-- Операция -->
                        <Grid>
                            <Grid.Style>
                                <Style TargetType="Grid">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Grid.Style>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Операция:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.Operation}" Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <Separator>
                            <Separator.Style>
                                <Style TargetType="Separator" BasedOn="{StaticResource AttributeSeparatorStyle}">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Separator.Style>
                        </Separator>

                        <!-- Наименование оснастки -->
                        <Grid>
                            <Grid.Style>
                                <Style TargetType="Grid">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Grid.Style>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Наименование оснастки:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.EquipmentName}" Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <Separator>
                            <Separator.Style>
                                <Style TargetType="Separator" BasedOn="{StaticResource AttributeSeparatorStyle}">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Separator.Style>
                        </Separator>

                        <!-- Аналог -->
                        <Grid>
                            <Grid.Style>
                                <Style TargetType="Grid">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Grid.Style>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Аналог:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.Analog}" Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <Separator>
                            <Separator.Style>
                                <Style TargetType="Separator" BasedOn="{StaticResource AttributeSeparatorStyle}">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Separator.Style>
                        </Separator>

                        <!-- Количество оснастки на операцию -->
                        <Grid>
                            <Grid.Style>
                                <Style TargetType="Grid">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Grid.Style>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Кол-во оснастки на операцию:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.EquipmentQuantityForOperation}" Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <TextBlock Text="Данные заказа"
                           FontSize="16"
                           FontWeight="Bold"
                           HorizontalAlignment="Center"
                           Foreground="{DynamicResource TextBrush}"
                           Margin="0,10,0,0">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>

                        <!-- Номер служебной -->
                        <Grid>
                            <Grid.Style>
                                <Style TargetType="Grid">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="False">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Grid.Style>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Номер служебной записки:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.MemoNumber}" Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <Separator>
                            <Separator.Style>
                                <Style TargetType="Separator" BasedOn="{StaticResource AttributeSeparatorStyle}">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="False">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Separator.Style>
                        </Separator>

                        <!-- Автор служебной -->
                        <Grid>
                            <Grid.Style>
                                <Style TargetType="Grid">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="False">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Grid.Style>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Автор служебной записки:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.MemoAuthor}" Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <Separator>
                            <Separator.Style>
                                <Style TargetType="Separator" BasedOn="{StaticResource AttributeSeparatorStyle}">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding model.CurrentGroup.IsByMemo}" Value="False">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Separator.Style>
                        </Separator>

                        <!-- Заказ по служебной -->
                        <Grid Style="{StaticResource AttributeRowStyle}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Заказ:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.OrderByMemo}" Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

                        <!-- Номер по служебной -->
                        <Grid Style="{StaticResource AttributeRowStyle}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Номер:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.NumberByMemo}" Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

                        <!-- Основной заказ по служебной -->
                        <Grid Style="{StaticResource AttributeRowStyle}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Основной заказ:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.CoreOrderByMemo}" Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

                        <!-- Номер основного заказа по служебной -->
                        <Grid Style="{StaticResource AttributeRowStyle}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Номер основного заказа:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>
                            
                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.CoreNumberByMemo}" Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

                        <!-- Наименование заказа по служебной -->
                        <Grid Style="{StaticResource AttributeRowStyle}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Наименование заказа:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.OrderName}" Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

                        <!-- Дата открытия заказа -->
                        <Grid Style="{StaticResource AttributeRowStyle}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Дата открытия заказа:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.OpenAtByMemo}" Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

                        <!-- Балансовый счет -->
                        <Grid Style="{StaticResource AttributeRowStyle}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Балансовый счет:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.Balance}" Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

                        <!-- Номенклатурная группа -->
                        <Grid Style="{StaticResource AttributeRowStyle}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Номенклатурная группа:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.NomenclatureGroup}" Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

                        <!-- Тип оснастки -->
                        <Grid Style="{StaticResource AttributeRowStyle}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Тип оснастки:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.EquipmentType.TypeName}" Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

                        <!-- Чертеж по служебной -->
                        <Grid Style="{StaticResource AttributeRowStyle}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Чертеж:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.DraftByMemo}" Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

                        <!-- Наименование чертежа по служебной -->
                        <Grid Style="{StaticResource AttributeRowStyle}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Чертежное обозн. спецификации:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.DraftNameByMemo}" Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

                        <!-- Склад по служебной -->
                        <Grid Style="{StaticResource AttributeRowStyle}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Склад:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.WorkshopByMemo}" Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

                        <!-- Количество по служебной -->
                        <Grid Style="{StaticResource AttributeRowStyle}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Количество:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>

                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.EquipmentRequiredQuantityByMemo}" Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                    </StackPanel>
                </Grid>
            </ScrollViewer>
        </Border>

        <!-- Правая область (30%) с DataGrid подзаказов и детальной информацией -->
        <Border Grid.Column="2" 
                Margin="5,5,5,5" 
                BorderThickness="2" 
                BorderBrush="{DynamicResource GreenAccentBrush}" 
                Background="{DynamicResource SecondaryBackgroundBrush}"
                CornerRadius="4"
                Padding="5">

            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <!-- Заголовок тех.заказа -->
                    <RowDefinition Height="Auto"/>
                    <!-- DataGrid подзаказов -->
                    <RowDefinition Height="*"/>
                    <!-- Детальная информация -->
                </Grid.RowDefinitions>

                <!-- Заголовок с номером текущего тех.заказа -->
                <TextBlock Grid.Row="0"
                           Text="{Binding model.CurrentGroup.Zak1, StringFormat='Тех. заказ: {0}'}"
                           FontSize="16"
                           FontWeight="Bold"
                           HorizontalAlignment="Center"
                           Foreground="{DynamicResource TextBrush}"
                           Margin="0,0,0,10"/>

                <!-- DataGrid подзаказов -->
                <DataGrid Grid.Row="1"
                          ItemsSource="{Binding model.CurrentGroup.Items}"
                          SelectedItem="{Binding model.CurrentItem, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                          AutoGenerateColumns="False"
                          IsReadOnly="True"
                          CanUserAddRows="False"
                          HeadersVisibility="Column"
                          SelectionMode="Single"
                          Margin="0,0,0,5">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Чертеж" Binding="{Binding EquipmentDraft}" Width="Auto"/>
                        <DataGridTextColumn Header="Наименование" Binding="{Binding EquipmentNameFromTechologist}" Width="Auto" CellStyle="{DynamicResource LeftAlignedDataGridCell}"/>
                        <DataGridTextColumn Header="Сколько изготовить" Binding="{Binding EquimentRequiredQuantity}" MaxWidth="100" Width="Auto"/>
                        <DataGridCheckBoxColumn Header="Кооп." 
                        Binding="{Binding Cooperation, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                        MaxWidth="55" 
                        Width="Auto"
                        ElementStyle="{StaticResource ConditionalCheckBoxColumnStyle}"
                        EditingElementStyle="{StaticResource ConditionalCheckBoxColumnStyle}"/>
                        <DataGridCheckBoxColumn IsReadOnly="True" Header="Удалить" Binding="{Binding IsDeletedFromOrder, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Width="*"
                                                ElementStyle="{StaticResource ConditionalCheckBoxColumnStyle}" 
                                                EditingElementStyle="{StaticResource ConditionalCheckBoxColumnStyle}"/>
                    </DataGrid.Columns>
                </DataGrid>

                <!-- Детальная информация -->
                <Border Grid.Row="2"
                        BorderThickness="2" 
                        BorderBrush="Red" 
                        Background="{DynamicResource SecondaryBackgroundBrush}"
                        CornerRadius="4"
                        Padding="5">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <!-- Главный контейнер с включенным SharedSizeScope -->
                        <Grid IsSharedSizeScope="True">
                            <StackPanel>
                                <TextBlock Grid.Row="0"
                           Text="Данные чертежа"
                           FontSize="16"
                           FontWeight="Bold"
                           HorizontalAlignment="Center"
                           Foreground="{DynamicResource TextBrush}"
                           Margin="0"/>

                                <!-- Дополнительные сведения для проектирования -->
                                <Grid Style="{StaticResource AttributeRowStyle}">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                        <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                                    </Grid.ColumnDefinitions>

                                    <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                        <TextBlock Text="Доп. сведения для проектирования:" Style="{StaticResource AttributeLabelTextStyle}"/>
                                    </Border>

                                    <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.DesignComment}" TextWrapping="Wrap" Style="{StaticResource AttributeValueStyle}"/>
                                </Grid>

                                <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

                                <!-- Дополнительные сведения для производства -->
                                <Grid Style="{StaticResource AttributeRowStyle}">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                        <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                                    </Grid.ColumnDefinitions>

                                    <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                        <TextBlock Text="Доп. сведения для производства:" Style="{StaticResource AttributeLabelTextStyle}"/>
                                    </Border>

                                    <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.ManufacturingComment}" TextWrapping="Wrap" Style="{StaticResource AttributeValueStyle}"/>
                                </Grid>
                            </StackPanel>
                        </Grid>
                    </ScrollViewer>
                </Border>
            </Grid>
        </Border>
    </Grid>
</UserControl>

using System;
using System.ComponentModel;
using System.Windows;
using System.Windows.Controls;

using Fox;
using Fox.Core;
using Fox.Core.ErrorHelper;
using Fox.Core.Logging;
using Fox.DatabaseService;
using Fox.DatabaseService.Entities;

using ModalWindows.Entities;

using OrderApprovalSystem.Models;
using OrderApprovalSystem.Services;
using OrderApprovalSystem.Validators;
using OrderApprovalSystem.Views;


namespace OrderApprovalSystem.ViewModels
{
    public class vmHeadOrderDepartment : VMBase
    {
        public HeadOrderDepartment View;
        public mHeadOrderDepartment Model;

        #region Инициализация

        public vmHeadOrderDepartment()
        {

        }

        public void viewLoaded(object _sender, RoutedEventArgs _routedEventArgs)
        {
            View = (HeadOrderDepartment)view;
            Model = (mHeadOrderDepartment)model;

            Model.PropertyChanged += modelPropertyChangedHandler;
        }

        public void modelPropertyChangedHandler(object _sender, PropertyChangedEventArgs _eventArgs)
        {
            if (_eventArgs.PropertyName == nameof(Model.CurrentGroup) && View?.dgReport != null)
            {
                ScrollToCurrentGroup();
            }
        }

        #endregion Инициализация

        #region Команды

        public CommandBase NavigatePreviousCommand
        {
            get { return _navigatePreviousCommand ?? (_navigatePreviousCommand = new CommandBase(NavigatePrevious)); }
        }

        public CommandBase NavigateNextCommand
        {
            get { return _navigateNextCommand ?? (_navigateNextCommand = new CommandBase(NavigateNext)); }
        }

        public CommandBase NavigatePreviousGroupCommand
        {
            get { return _navigatePreviousGroupCommand ?? (_navigatePreviousGroupCommand = new CommandBase(NavigatePreviousGroup)); }
        }

        public CommandBase NavigateNextGroupCommand
        {
            get { return _navigateNextGroupCommand ?? (_navigateNextGroupCommand = new CommandBase(NavigateNextGroup)); }
        }

        public CommandBase pNavigateToDevCommand => new CommandBase(() => NavigateToDev());

        public CommandBase pApprovalOrderCommand => new CommandBase(() => ApprovalOrder());

        public CommandBase pRejectOrderCommand => new CommandBase(() => RejectOrder());

        #endregion Команды

        #region Свойства

        public string SearchText
        {
            get { return _searchText; }
            set
            {
                if (_searchText != value)
                {
                    _searchText = value;
                    OnPropertyChanged(nameof(SearchText));
                    PerformSearch();
                }
            }
        }

        #endregion Свойства

        #region переменные

        private CommandBase _navigatePreviousCommand;
        private CommandBase _navigateNextCommand;
        private CommandBase _navigatePreviousGroupCommand;
        private CommandBase _navigateNextGroupCommand;
        private string _searchText;

        #endregion переменные

        private void PerformSearch()
        {
            if (Model == null)
            {
                return;
            }
            Model.FindAndNavigate(SearchText);
        }

        private void NavigatePrevious()
        {
            if (Model?.HasPrevious == true)
            {
                Model.CurrentIndex--;
                Model.CurrentItem = Model.CurrentGroup.Items[Model.CurrentIndex];
            }
        }

        private void NavigateNext()
        {
            if (Model?.HasNext == true)
            {
                Model.CurrentIndex++;
                Model.CurrentItem = Model.CurrentGroup.Items[Model.CurrentIndex];
            }
        }

        private void NavigatePreviousGroup()
        {
            if (Model?.HasPreviousGroup == true)
            {
                Model.NavigatePreviousGroup();
            }
        }

        private void NavigateNextGroup()
        {
            if (Model?.HasNextGroup == true)
            {
                Model.NavigateNextGroup();
            }
        }

        /// <summary>
        /// Переход к Dev
        /// </summary>
        private void NavigateToDev()
        {
            if (View?.Parent is ContentControl contentControl &&
                contentControl.DataContext is vmMain vmMain)
            {
                vmMain.NavigateTo<vmDev>();
            }
        }

        private void ScrollToCurrentGroup()
        {
            if (View?.dgReport != null && Model?.CurrentGroup != null)
            {
                // Используем Dispatcher для асинхронной прокрутки
                Application.Current.Dispatcher.BeginInvoke(new Action(() =>
                {
                    try
                    {
                        View.dgReport.ScrollIntoView(Model.CurrentGroup);
                        View.dgReport.Focus();
                    }
                    catch (Exception ex)
                    {
                        LoggerManager.MainLogger.Error($"Error scrolling to current group: {ex.Message}");
                    }
                }), System.Windows.Threading.DispatcherPriority.Background);
            }
        }

        private void ApprovalOrder()
        {
            string operationName = "Согласование заказа";
            Result result = null;
            ModalResult userAnswer = DialogService.ShowApproveHeadOrder(
                "Заполните данные",
                $"{operationName}: {Model.CurrentItem.OrderNumber}"
            );

            if (userAnswer.IsDismissed || userAnswer.IsCancelled)
            {
                result = Result.Success("Отменено пользователем").HideMessage();
            }
            if (userAnswer.IsValidationFailed)
            {
                result = Result.Failed("Не пройдена валидация");
            }
            if (userAnswer.IsValid)
            {
                TransactionHelper.ExecuteWithTransaction(
                    businessLogic: () =>
                    {
                        result = Model.ApproveOrder(userAnswer.Data);
                        if (!result.IsSuccess)
                        {
                            throw new OperationCanceledException(result.Message);
                        }
                    },
                    errorHandler: errorContext =>
                    {
                        errorContext.ErrorDetail["Order"] = Model.CurrentGroup.Zak1;
                        errorContext.ErrorDetail["Draft"] = Model.CurrentItem.EquipmentDraft;
                        errorContext.ErrorDetail["ApprovalData"] = userAnswer.Data.ToString();

                        if (errorContext.Exception is OperationCanceledException)
                        {
                            LoggerManager.MainLogger.Error($"Операция - <{operationName}> отменена: {errorContext.Exception.Message}");
                            LoggerManager.MainLogger.Debug(
                                ErrorHelper.FormatErrorMessage(
                                    errorContext.Exception,
                                    "vmSubTechnologist.ApprovalOrder",
                                    errorContext.ErrorDetail
                                )
                            );
                            DialogService.ShowError(errorContext.Exception.Message, operationName);
                        }
                        else
                        {
                            LoggerManager.MainLogger.Error($"Операция - <{operationName}> прервана ошибкой: {errorContext.Exception.Message}");
                            LoggerManager.MainLogger.Error(
                                ErrorHelper.FormatErrorMessage(
                                    errorContext.Exception,
                                    "vmSubTechnologist.ApprovalOrder",
                                    errorContext.ErrorDetail
                                )
                            );

                            if (errorContext.ShouldLogToErrorHelper)
                            {
                                ErrorHelper.SendError(
                                    errorContext.Exception,
                                    "vmSubTechnologist.ApprovalOrder",
                                    errorContext.ErrorDetail
                                );
                            }

                            DialogService.ShowError("Критическая ошибка сохранения", operationName);
                        }
                    },
                    operationName: operationName,
                    model: Model,
                    isTransactionOwner: !ServiceLocator.DatabaseService.HasActiveTransaction
                );
            }
            DialogService.HandleResult(result, $"Согласование заказа: {Model.CurrentItem.OrderNumber}");
        }

        private void RejectOrder()
        {
            string operationName = "НЕ согласование заказа";
            Result result = null;
            ModalResult userAnswer = DialogService.ShowReject(
                "Заполните данные",
                $"НЕ согласовывать заказ: {Model.CurrentItem.OrderNumber}",
                vm => RejectOrderModalValidator.Validate(vm)
            );

            if (userAnswer.IsDismissed || userAnswer.IsCancelled)
            {
                result = Result.Success("Отменено пользователем").HideMessage();
            }
            if (userAnswer.IsValidationFailed)
            {
                result = Result.Failed("Не пройдена валидация");
            }
            if (userAnswer.IsValid)
            {
                TransactionHelper.ExecuteWithTransaction(
                    businessLogic: () =>
                    {
                        result = Model.RejectOrder(userAnswer.Data);
                        if (!result.IsSuccess)
                        {
                            throw new OperationCanceledException(result.Message);
                        }
                    },
                    errorHandler: errorContext =>
                    {
                        errorContext.ErrorDetail["Order"] = Model.CurrentGroup.Zak1;
                        errorContext.ErrorDetail["Draft"] = Model.CurrentItem.EquipmentDraft;
                        errorContext.ErrorDetail["ApprovalData"] = userAnswer.Data.ToString();

                        if (errorContext.Exception is OperationCanceledException)
                        {
                            LoggerManager.MainLogger.Error($"Операция - <{operationName}> отменена: {errorContext.Exception.Message}");
                            LoggerManager.MainLogger.Debug(
                                ErrorHelper.FormatErrorMessage(
                                    errorContext.Exception,
                                    "vmSubTechnologist.ApprovalOrder",
                                    errorContext.ErrorDetail
                                )
                            );
                            DialogService.ShowError(errorContext.Exception.Message, operationName);
                        }
                        else
                        {
                            LoggerManager.MainLogger.Error($"Операция - <{operationName}> прервана ошибкой: {errorContext.Exception.Message}");
                            LoggerManager.MainLogger.Error(
                                ErrorHelper.FormatErrorMessage(
                                    errorContext.Exception,
                                    "vmSubTechnologist.ApprovalOrder",
                                    errorContext.ErrorDetail
                                )
                            );

                            if (errorContext.ShouldLogToErrorHelper)
                            {
                                ErrorHelper.SendError(
                                    errorContext.Exception,
                                    "vmSubTechnologist.ApprovalOrder",
                                    errorContext.ErrorDetail
                                );
                            }

                            DialogService.ShowError("Критическая ошибка сохранения", operationName);
                        }
                    },
                    operationName: operationName,
                    model: Model,
                    isTransactionOwner: !ServiceLocator.DatabaseService.HasActiveTransaction
                );
            }
            DialogService.HandleResult(result, $"Согласование заказа: {Model.CurrentItem.OrderNumber}");
        }
    }

}

using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Data;
using System.Linq;

using Fox;
using Fox.Core;
using Fox.Core.Logging;
using Fox.DatabaseService.Entities;
using OrderApprovalSystem.Data;
using OrderApprovalSystem.Data.Entities;


namespace OrderApprovalSystem.Models
{
    public class mHeadOrderDepartment : MBase
    {
        private Fox.DatabaseService.IDatabaseService db = ServiceLocator.DatabaseService;

        /// <summary>
        /// Конструктор
        /// </summary>
        public mHeadOrderDepartment()
        {
            LoadData();
        }

        public void NavigatePrevious()
        {
            if (HasPrevious)
            {
                CurrentIndex--;
                CurrentItem = CurrentGroup.Items[CurrentIndex];
            }
        }

        public void NavigateNext()
        {
            if (HasNext)
            {
                CurrentIndex++;
                CurrentItem = CurrentGroup.Items[CurrentIndex];
            }
        }

        public void NavigateNextGroup()
        {
            if (HasNextGroup)
            {
                CurrentGroup = GroupedData[CurrentGroupIndex + 1];
            }
        }

        public void NavigatePreviousGroup()
        {
            if (HasPreviousGroup)
            {
                CurrentGroup = GroupedData[CurrentGroupIndex - 1];
            }
        }

        public void FindAndNavigate(string searchText)
        {
            if (string.IsNullOrWhiteSpace(searchText) || GroupedData == null)
            {
                return;
            }

            string query = searchText.ToLower().Trim();

            var targetGroup = GroupedData.FirstOrDefault(
                g =>
                g.Zak1 != null && g.Zak1.ToLower().Contains(query)
            );
            if (targetGroup != null)
            {
                if (CurrentGroup != targetGroup)
                {
                    CurrentGroup = targetGroup;
                }
                return;
            }
        }

        #region Модальные окна

        public Result ApproveOrder(Dictionary<string, object> data)
        {
            LoggerManager.MainLogger.Debug($"ApproveOrder for {CurrentItem.OrderNumber}");

            try
            {
                string comment = (string)data["Comment"];

                // Получение количества рабочих дней для согласования
                int workingDaysCount = db.mGetQuery<OrderApproval>()
                    .Where(order => order.ID == CurrentItem.OrderApprovalID)
                    .Join(
                        db.mGetQuery<OrderApprovalTypes>(),
                        order => order.EquipmentTypeID,
                        approvalType => approvalType.ID,
                        (order, approvalType) => approvalType.Term
                    )
                    .FirstOrDefault();

                // Получение даты выполнения с учетом рабочих дней
                DateTime deadlineDate = db.mGetQuery<calend>()
                    .Where(calendarDay => calendarDay.mday > DateTime.Today && calendarDay.v == true)
                    .OrderBy(calendarDay => calendarDay.mday)
                    .Skip(workingDaysCount - 1) // Пропускаем N-1 рабочих дней
                    .Take(1)
                    .Select(calendarDay => calendarDay.mday)
                    .FirstOrDefault();

                // Если не нашли дату в календаре, используем простое сложение дней
                if (deadlineDate == default(DateTime))
                {
                    deadlineDate = DateTime.Today.AddDays(workingDaysCount);
                }

                // Обновление текущей записи согласования
                OrderApprovalHistory thisStepRecord = db.mGetList<OrderApprovalHistory>(
                    record =>
                    record.OrderApprovalID == CurrentItem.OrderApprovalID
                    && record.RecipientRole == "Начальник отдела заказов"
                    && record.RecipientName == "Дингес"
                )
                .Data
                .OrderByDescending(record => record.ID)
                .FirstOrDefault();

                if (thisStepRecord == null)
                {
                    return Result.Failed("Не найдена текущая запись согласования!");
                }

                thisStepRecord.CompletionDate = DateTime.Now;
                thisStepRecord.Status = "Выполнено";
                thisStepRecord.Result = "Согласовано";

                Result status = db.mUpdate(thisStepRecord);
                if (status.IsFailed)
                {
                    return Result.Failed("Не удалось обновить запись текущего согласования в БД!");
                }

                // Создание новой записи для следующего этапа согласования
                OrderApprovalHistory nextStepRecord = new OrderApprovalHistory
                {
                    OrderApprovalID = CurrentItem.OrderApprovalID,
                    ReceiptDate = DateTime.Now,
                    CompletionDate = null,
                    Term = deadlineDate,
                    RecipientRole = "Менеджер заказов",
                    RecipientName = "Папаева",
                    SenderRole = "Начальник отдела заказов",
                    SenderName = "Дингес",
                    Result = null,
                    Comment = comment
                };

                status = db.mAdd(nextStepRecord);
                if (status.IsFailed)
                {
                    return Result.Failed("Не удалось сохранить запись нового согласования в БД!");
                }

                return Result.Success();
            }
            catch (Exception ex)
            {
                LoggerManager.MainLogger.Error($"Ошибка в ApproveOrder: {ex.Message}");
                return Result.Failed($"Произошла ошибка при согласовании: {ex.Message}");
            }
        }

        public Result RejectOrder(Dictionary<string, object> data)
        {
            LoggerManager.MainLogger.Debug("Call RejectOrder");

            try
            {
                // Находим ID последней записи согласования для технолога Рагульского
                var maxId = db.mGetQuery<OrderApprovalHistory>()
                    .Where(oah => oah.OrderApprovalID == CurrentItem.OrderApprovalID
                               && oah.RecipientRole == "Технолог"
                               && oah.RecipientName == "Рагульский")
                    .Select(oah => oah.ID)
                    .Max();

                // Получаем последнюю запись согласования
                OrderApprovalHistory previousStepRecord = db.mGetSingle<OrderApprovalHistory>(
                    record => record.ID == maxId
                ).Data;

                if (previousStepRecord is null)
                {
                    LoggerManager.MainLogger.Error("Не найдена прошлая строка согласования");
                    return Result.Failed("Не найдена предыдущая запись согласования");
                }

                // Обновляем текущую запись согласования
                previousStepRecord.Status = "Выполнено";
                previousStepRecord.Result = "На доработку";
                previousStepRecord.CompletionDate = DateTime.Now;

                Result updateResult = db.mUpdate(previousStepRecord);
                if (updateResult.IsFailed)
                {
                    LoggerManager.MainLogger.Error($"Ошибка при обновлении записи: {updateResult.Message}");
                    return Result.Failed("Не удалось обновить запись согласования");
                }

                // Получение количества рабочих дней для согласования из OrderApprovalTypes
                int workingDaysCount = db.mGetQuery<OrderApproval>()
                    .Where(order => order.ID == CurrentItem.OrderApprovalID)
                    .Join(
                        db.mGetQuery<OrderApprovalTypes>(),
                        order => order.EquipmentTypeID,
                        approvalType => approvalType.ID,
                        (order, approvalType) => approvalType.Term
                    )
                    .FirstOrDefault();

                if (workingDaysCount <= 0)
                {
                    LoggerManager.MainLogger.Error($"Not found term for approvalType:");
                    return Result.Failed("Не найден срок");
                }

                // Расчет даты выполнения с учетом рабочих дней
                DateTime today = DateTime.Today;
                DateTime deadlineDate;

                // Получаем ближайшую рабочую дату после сегодняшней
                var firstWorkingDay = db.mGetQuery<calend>()
                    .Where(calendarDay => calendarDay.mday > today && calendarDay.v == true)
                    .OrderBy(calendarDay => calendarDay.mday)
                    .FirstOrDefault();

                if (firstWorkingDay != null)
                {
                    // Ищем дату, отстоящую на workingDaysCount рабочих дней вперед
                    deadlineDate = db.mGetQuery<calend>()
                        .Where(calendarDay => calendarDay.mday > today && calendarDay.v == true)
                        .OrderBy(calendarDay => calendarDay.mday)
                        .Skip(workingDaysCount - 1) // Пропускаем N-1 рабочих дней
                        .Take(1)
                        .Select(calendarDay => calendarDay.mday)
                        .FirstOrDefault();
                }
                else
                {
                    deadlineDate = default(DateTime);
                }

                // Если не нашли дату в календаре, используем простое сложение дней
                if (deadlineDate == default(DateTime))
                {
                    // Добавляем рабочие дни + возможные выходные
                    deadlineDate = today.AddDays(workingDaysCount * 1.4); // коэффициент для учета выходных
                }

                // Извлечение данных из входного словаря
                string recipientRole = (string)data["Subdivision"];
                string recipientName = (string)data["SubdivisionRecipient"];
                string comment = (string)data["Comment"];

                // Создание новой записи для следующего этапа согласования
                OrderApprovalHistory nextStepRecord = new OrderApprovalHistory
                {
                    OrderApprovalID = CurrentItem.OrderApprovalID,
                    ReceiptDate = DateTime.Now,
                    CompletionDate = null, // Для новой записи CompletionDate должен быть null
                    Term = deadlineDate,
                    RecipientRole = recipientRole,
                    RecipientName = recipientName,
                    SenderRole = "Технолог",
                    SenderName = "Рагульский",
                    Status = "В работе", // Новая запись начинается со статуса "В работе"
                    Result = null, // Результат еще не определен
                    Comment = comment
                };

                Result addResult = db.mAdd(nextStepRecord);
                if (addResult.IsFailed)
                {
                    LoggerManager.MainLogger.Error($"Ошибка при добавлении записи: {addResult.Message}");
                    return Result.Failed("Не удалось создать новую запись согласования");
                }

                LoggerManager.MainLogger.Info($"Заказ отклонен и перенаправлен в {recipientRole} - {recipientName}");
                return Result.Success();
            }
            catch (Exception ex)
            {
                LoggerManager.MainLogger.Error($"Ошибка в RejectOrder: {ex.Message}", ex);
                return Result.Failed($"Произошла ошибка при отклонении заказа: {ex.Message}");
            }
        }

        #endregion Модальные окна

        #region Свойства

        public List<TechnologistGroup> GroupedData
        {
            get => _groupedData;
            set
            {
                _groupedData = value;
                OnPropertyChanged(nameof(TotalGroups));
                if (_groupedData != null && _groupedData.Any())
                {
                    CurrentGroup = _groupedData.First();
                }
            }
        }

        public TechnologistGroup CurrentGroup
        {
            get => _currentGroup;
            set
            {
                _currentGroup = value;
                OnPropertyChanged(nameof(CurrentGroup));

                if (_groupedData != null && _currentGroup != null)
                {
                    CurrentGroupIndex = _groupedData.IndexOf(_currentGroup);
                }

                OnPropertyChanged(nameof(CurrentGroupIndexDisplay));
                OnPropertyChanged(nameof(HasPreviousGroup));
                OnPropertyChanged(nameof(HasNextGroup));

                if (_currentGroup != null && _currentGroup.Items.Any())
                {
                    CurrentItem = _currentGroup.Items.First();
                    CurrentIndex = 0;
                }
                else
                {
                    CurrentItem = null;
                    CurrentIndex = 0;
                }
            }
        }

        public TechnologicalOrder CurrentItem
        {
            get => _currentItem;
            set
            {
                _currentItem = value;

                // Обновляем индекс строки при изменении CurrentItem
                if (_currentGroup != null && _currentItem != null && _currentGroup.Items.Contains(_currentItem))
                {
                    CurrentIndex = _currentGroup.Items.IndexOf(_currentItem);
                }

                OnPropertyChanged(nameof(CurrentItem));
                OnPropertyChanged(nameof(CurrentIndexDisplay));
                OnPropertyChanged(nameof(HasPrevious));
                OnPropertyChanged(nameof(HasNext));
            }
        }

        public int CurrentGroupIndex
        {
            get => _currentGroupIndex;
            set
            {
                _currentGroupIndex = value;
                OnPropertyChanged(nameof(CurrentGroupIndex));
                OnPropertyChanged(nameof(CurrentGroupIndexDisplay));
                OnPropertyChanged(nameof(HasPreviousGroup));
                OnPropertyChanged(nameof(HasNextGroup));
            }
        }

        public int CurrentIndex
        {
            get => _currentIndex;
            set
            {
                _currentIndex = value;
                OnPropertyChanged(nameof(CurrentIndex));
                OnPropertyChanged(nameof(CurrentIndexDisplay));
                OnPropertyChanged(nameof(HasPrevious));
                OnPropertyChanged(nameof(HasNext));
            }
        }

        public string CurrentGroupIndexDisplay =>
            GroupedData != null && GroupedData.Any()
                ? $"{CurrentGroupIndex + 1} из {GroupedData.Count}"
                : "0 из 0";

        public string CurrentIndexDisplay =>
            CurrentGroup != null && CurrentGroup.Items.Any()
                ? $"{CurrentIndex + 1} из {CurrentGroup.Items.Count}"
                : "0 из 0";

        public bool HasPrevious => CurrentGroup != null && CurrentIndex > 0;
        public bool HasNext => CurrentGroup != null && CurrentIndex < CurrentGroup.Items.Count - 1;
        public bool HasPreviousGroup => GroupedData != null && CurrentGroupIndex > 0;
        public bool HasNextGroup => GroupedData != null && CurrentGroupIndex < GroupedData.Count - 1;
        public int TotalGroups => GroupedData?.Count ?? 0;

        #endregion Свойства

        #region Переменные

        private List<TechnologistGroup> _groupedData;
        private TechnologistGroup _currentGroup;
        private TechnologicalOrder _currentItem;
        private int _currentIndex = 0;
        private int _currentGroupIndex = 0;

        #endregion Переменные

        private void LoadData()
        {
            try
            {
                Fox.DatabaseService.IDatabaseService db = ServiceLocator.DatabaseService;

                IQueryable<TechnologicalOrder> query =
                    from OrderApproval in db.mGetQuery<OrderApproval>()
                    join OrderApprovalDrafts in db.mGetQuery<OrderApprovalDrafts>() on OrderApproval.ID equals OrderApprovalDrafts.OrderApprovalID
                    join zayvka in db.mGetQuery<zayvka>() on OrderApproval.zayvkaID equals zayvka.id
                    join os_pro in db.mGetQuery<os_pro>() on zayvka.zak_1 equals os_pro.zak_1

                    // LEFT JOIN oborud
                    join oborud in db.mGetQuery<oborud>() on zayvka.rab_m equals oborud.rab_m into obGroup
                    from oborud in obGroup.DefaultIfEmpty()

                        // LEFT JOIN s_oper
                    join s_oper in db.mGetQuery<s_oper>() on zayvka.kodop equals s_oper.code into soGroup
                    from s_oper in soGroup.DefaultIfEmpty()

                        // LEFT JOIN prod
                    join p in db.mGetQuery<prod>()
                        on new { zayvka.zak_1, IsDrNull = (decimal?)null }
                        equals new { p.zak_1, IsDrNull = p.dr } into pGroup
                    from p in pGroup.DefaultIfEmpty()

                    where os_pro.d_vn_14 != null

                    orderby zayvka.zak_1

                    select new TechnologicalOrder
                    {
                        OrderNumber = zayvka.zak_1,
                        OrderApprovalID = OrderApproval.ID,
                        OrderApprovalDraftID = OrderApprovalDrafts.ID,
                        Technologist = OrderApproval.Technologist,
                        CoreDraft = (decimal)OrderApproval.CoreDraft,
                        Draft = OrderApproval.Draft,
                        CoreDraftName = OrderApproval.CoreDraftName.Trim(),
                        DraftName = OrderApproval.DraftName.Trim(),

                        Workshop = OrderApproval.Workshop,
                        Warehouse = OrderApproval.Warehouse,
                        Schedule = zayvka.graf,

                        Workplace = oborud != null ? (oborud.code + " " + oborud.oborud1).Trim() : null,
                        Operation = s_oper != null ? s_oper.oper.Trim() : null,

                        EquipmentDraft = OrderApprovalDrafts.EquipmentDraft,
                        EquipmentName = OrderApprovalDrafts.EquipmentName.Trim(),
                        EquipmentNameFromTechologist = OrderApproval.EquipmentNameFromTechnologist.Trim(),
                        EquipmentQuantityForOperation = OrderApproval.EquipmentQuantityForOperation,
                        EquimentRequiredQuantity = OrderApprovalDrafts.EquimentRequiredQuantity,
                        Cooperation = OrderApprovalDrafts.Cooperation,
                        IsDeletedFromOrder = OrderApprovalDrafts.IsDeletedFromOrder,

                        Note = zayvka.prim,
                        Analog = OrderApproval.Analog,
                        DesignComment = OrderApprovalDrafts.CommentForDesign,
                        ManufacturingComment = OrderApprovalDrafts.CommentForManufacturing,
                        OpenAtByTechnologist = OrderApproval.OpenAt,
                        Comment = null,
                    };

                List<TechnologicalOrder> data = query.Distinct().ToList();


                GroupedData = data
                    .OrderBy(x => x.EquipmentDraft)
                    .GroupBy(x => x.OrderNumber)
                    .Select(
                        g =>
                        new TechnologistGroup
                        {
                            Zak1 = g.Key,
                            Items = new ObservableCollection<TechnologicalOrder>(g.OrderBy(x => x.OpenAtByTechnologist).ToList())
                        }
                    )
                    .OrderBy(g => g.Zak1)
                    .ToList();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error: {ex.Message}");
            }
        }
    }

}

проблема: есть несколько очень похожих окон по ролям, у них +- один функционал и вид, но где-то есть какие-то отличия. Сейчас я просто копировал их плностью как разные UserControl и полным их кодом, можем ли мы правильно как-то организовать все это дело? Одно общее окно, с пеоепределением/переотрисовкой элементов/функционала