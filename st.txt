using System.Windows;
using System.Windows.Controls.Ribbon;
using System.Windows.Media;
using System.Windows.Data;
using System.Windows.Controls;

using Microsoft.Xaml.Behaviors;

using Fox;

using OrderApprovalSystem.ViewModels;


namespace OrderApprovalSystem.Views
{

    public class RibbonTabBehavior : Behavior<Ribbon>
    {
        public static readonly DependencyProperty CurrentViewModelProperty = DependencyProperty.Register(
            "CurrentViewModel",
            typeof(VMBase),
            typeof(RibbonTabBehavior),
            new PropertyMetadata(null, OnCurrentViewModelChanged)
        );

        public VMBase CurrentViewModel
        {
            get { return (VMBase)GetValue(CurrentViewModelProperty); }
            set { SetValue(CurrentViewModelProperty, value); }
        }

        protected override void OnAttached()
        {
            base.OnAttached();
            UpdateRibbonTab();
        }

        private RibbonTab _dynamicTab;

        private static void OnCurrentViewModelChanged(DependencyObject d, DependencyPropertyChangedEventArgs e)
        {
            var behavior = (RibbonTabBehavior)d;
            behavior.UpdateRibbonTab();
        }

        private void UpdateRibbonTab()
        {
            if (AssociatedObject == null)
                return;

            // Удаляем старую вкладку
            if (_dynamicTab != null)
            {
                AssociatedObject.Items.Remove(_dynamicTab);
                _dynamicTab = null;
            }

            if (CurrentViewModel == null)
            {
                return;
            }

            // Создаем новую вкладку
            _dynamicTab = CreateTabForViewModel(CurrentViewModel);
            if (_dynamicTab != null)
            {
                // Вставляем первой вкладкой (после ApplicationMenu)
                AssociatedObject.Items.Insert(0, _dynamicTab);
                _dynamicTab.IsSelected = true;
            }


        }

        private RibbonTab CreateTabForViewModel(VMBase viewModel)
        {
            if (viewModel is vmBaseApproval approvalViewModel)
            {
                RibbonTab tab = new RibbonTab
                {
                    Header = approvalViewModel.GetType().Name.Replace("vm", ""),
                    DataContext = approvalViewModel
                };

                // Добавляем общие группы
                var approveGroup = CreateCommonApproveGroup(approvalViewModel);
                if (approveGroup.Items.Count > 0)
                    tab.Items.Add(approveGroup);

                // Добавляем роле-специфичные группы
                if (approvalViewModel is vmOrderManager orderManager)
                {
                    var orderGroup = CreateOrderManagerSpecificGroup(orderManager);
                    tab.Items.Add(orderGroup);
                }

                return tab;
            }

            // Обработка других типов ViewModel (vmDev и т.д.)
            return null;
        }

        private RibbonGroup CreateCommonApproveGroup(vmBaseApproval viewModel)
        {
            RibbonGroup group = new RibbonGroup { Header = "Согласование" };

            if (viewModel.CanApproveOrders && viewModel.ApprovalOrderCommand != null)
            {
                group.Items.Add(new RibbonButton
                {
                    Label = "Согласовать",
                    Command = viewModel.ApprovalOrderCommand,
                    LargeImageSource = CreateCheckIcon()
                });
            }

            if (viewModel.CanRejectOrders && viewModel.RejectOrderCommand != null)
            {
                group.Items.Add(new RibbonButton
                {
                    Label = "Не согласовывать",
                    Command = viewModel.RejectOrderCommand,
                    LargeImageSource = CreateCrossIcon()
                });
            }

            // Кнопка "История" для всех
            group.Items.Add(new RibbonButton
            {
                Label = "История согласования",
                LargeImageSource = CreateHistoryIcon()
            });

            return group;
        }

        private RibbonGroup CreateOrderManagerSpecificGroup(vmOrderManager orderManager)
        {
            RibbonGroup group = new RibbonGroup { Header = "Заказ" };
            group.Items.Add(new RibbonButton
            {
                Label = "По СЗ",
                Command = orderManager.OrderByMemoCommand,
                LargeImageSource = CreateCheckIcon()
            });
            return group;
        }


        // Вспомогательный метод для создания ImageSource из Geometry
        private ImageSource CreateGeometryImageSource(string geometryData, Brush brush, double width, double height)
        {
            Geometry geometry = Geometry.Parse(geometryData);
            GeometryDrawing drawing = new GeometryDrawing(brush, null, geometry);
            DrawingImage drawingImage = new DrawingImage(drawing);
            drawingImage.Freeze();
            return drawingImage;
        }

        private ImageSource CreateCheckIcon()
        {
            return CreateGeometryImageSource(
                "M9 16.17L4.83 12L3.41 13.41L9 19L21 7L19.59 5.59L9 16.17Z",
                Brushes.Green,
                32, 32
            );
        }

        // Метод для создания иконки крестика
        private ImageSource CreateCrossIcon()
        {
            return CreateGeometryImageSource(
                "M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12L19 6.41Z",
                Brushes.Red,
                32, 32
            );
        }

        private ImageSource CreateHistoryIcon()
        {
            // Данные геометрии: круг часов и стрелки
            return CreateGeometryImageSource(
                "M13,3A9,9 0 0,0 4,12H1L4.89,15.89L4.96,16.03L9,12H6A7,7 0 0,1 13,5A7,7 0 0,1 20,12A7,7 0 0,1 13,19C11.07,19 9.32,18.21 8.06,16.94L6.64,18.36C8.27,20 10.5,21 13,21A9,9 0 0,0 22,12A9,9 0 0,0 13,3M12,8V13L16.28,15.54L17,14.33L13.5,12.25V8H12Z",
                (Brush)Application.Current.Resources["TextBrush"],
                32, 32
            );
        }

    }

}


using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Linq;
using Fox;
using Fox.Core;
using Fox.Core.Logging;
using Fox.DatabaseService;
using Fox.DatabaseService.Entities;
using OrderApprovalSystem.Data;
using OrderApprovalSystem.Data.Entities;

namespace OrderApprovalSystem.Models
{
    public abstract class mApproval : MBase
    {
        protected Fox.DatabaseService.IDatabaseService db = ServiceLocator.DatabaseService;

        #region Свойства

        private ObservableCollection<TechnologistGroup> _groupedData;
        public ObservableCollection<TechnologistGroup> GroupedData
        {
            get => _groupedData;
            set
            {
                _groupedData = value;
                OnPropertyChanged(nameof(GroupedData));
                OnPropertyChanged(nameof(TotalGroups));

                if (_groupedData != null && _groupedData.Any())
                {
                    CurrentGroup = _groupedData.First();
                }
            }
        }

        private TechnologistGroup _currentGroup;
        public TechnologistGroup CurrentGroup
        {
            get => _currentGroup;
            set
            {
                _currentGroup = value;
                OnPropertyChanged(nameof(CurrentGroup));

                if (_groupedData != null && _currentGroup != null)
                {
                    CurrentGroupIndex = _groupedData.IndexOf(_currentGroup);
                }

                if (_currentGroup != null && _currentGroup.Items.Any())
                {
                    CurrentItem = _currentGroup.Items.First();
                    CurrentIndex = 0;
                }
                else
                {
                    CurrentItem = null;
                    CurrentIndex = 0;
                }
            }
        }

        private TechnologicalOrder _currentItem;
        public TechnologicalOrder CurrentItem
        {
            get => _currentItem;
            set
            {
                _currentItem = value;
                OnPropertyChanged(nameof(CurrentItem));

                if (_currentGroup != null && _currentItem != null && _currentGroup.Items.Contains(_currentItem))
                {
                    CurrentIndex = _currentGroup.Items.IndexOf(_currentItem);
                }
            }
        }

        private int _currentGroupIndex;
        public int CurrentGroupIndex
        {
            get => _currentGroupIndex;
            set
            {
                _currentGroupIndex = value;
                OnPropertyChanged(nameof(CurrentGroupIndex));
            }
        }

        private int _currentIndex;
        public int CurrentIndex
        {
            get => _currentIndex;
            set
            {
                _currentIndex = value;
                OnPropertyChanged(nameof(CurrentIndex));
            }
        }

        public bool HasPrevious => CurrentGroup != null && CurrentIndex > 0;
        public bool HasNext => CurrentGroup != null && CurrentIndex < CurrentGroup.Items.Count - 1;
        public bool HasPreviousGroup => GroupedData != null && CurrentGroupIndex > 0;
        public bool HasNextGroup => GroupedData != null && CurrentGroupIndex < GroupedData.Count - 1;
        public int TotalGroups => GroupedData?.Count ?? 0;

        #endregion

        #region Методы навигации

        public void NavigatePrevious()
        {
            if (HasPrevious)
            {
                CurrentIndex--;
                CurrentItem = CurrentGroup.Items[CurrentIndex];
            }
        }

        public void NavigateNext()
        {
            if (HasNext)
            {
                CurrentIndex++;
                CurrentItem = CurrentGroup.Items[CurrentIndex];
            }
        }

        public void NavigateNextGroup()
        {
            if (HasNextGroup)
            {
                CurrentGroup = GroupedData[CurrentGroupIndex + 1];
            }
        }

        public void NavigatePreviousGroup()
        {
            if (HasPreviousGroup)
            {
                CurrentGroup = GroupedData[CurrentGroupIndex - 1];
            }
        }

        public void FindAndNavigate(string searchText)
        {
            if (string.IsNullOrWhiteSpace(searchText) || GroupedData == null)
                return;

            string query = searchText.ToLower().Trim();

            var targetGroup = GroupedData.FirstOrDefault(g =>
                g.Zak1 != null && g.Zak1.ToLower().Contains(query));

            if (targetGroup != null && CurrentGroup != targetGroup)
            {
                CurrentGroup = targetGroup;
            }
        }

        #endregion

        #region Абстрактные методы

        protected abstract IQueryable<TechnologicalOrder> BuildBaseQuery();

        #endregion

        #region Загрузка данных

        protected virtual void LoadData()
        {
            try
            {
                var query = BuildBaseQuery();
                List<TechnologicalOrder> data = query.Distinct().ToList();

                GroupedData = new ObservableCollection<TechnologistGroup>(
                    data
                    .OrderBy(x => x.EquipmentDraft)
                    .GroupBy(x => x.OrderNumber)
                    .Select(g => new TechnologistGroup
                    {
                        Zak1 = g.Key,
                        Items = new ObservableCollection<TechnologicalOrder>(
                            g.OrderBy(x => x.OpenAtByTechnologist).ToList())
                    })
                    .OrderBy(g => g.Zak1)
                    .ToList()
                );
            }
            catch (Exception ex)
            {
                LoggerManager.MainLogger.Error($"Error loading data: {ex.Message}");
                GroupedData = new ObservableCollection<TechnologistGroup>();
            }
        }

        #endregion
    }
}

using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Linq;
using Fox;
using Fox.Core;
using Fox.Core.Logging;
using Fox.DatabaseService.Entities;
using OrderApprovalSystem.Data;
using OrderApprovalSystem.Data.Entities;

namespace OrderApprovalSystem.Models
{
    public class mHeadOrderDepartment : mApproval
    {
        /// <summary>
        /// Конструктор
        /// </summary>
        public mHeadOrderDepartment()
        {
            LoadData();
        }

        #region Загрузка данных

        protected override IQueryable<TechnologicalOrder> BuildBaseQuery()
        {
            return from OrderApproval in db.mGetQuery<OrderApproval>()
                   join OrderApprovalDrafts in db.mGetQuery<OrderApprovalDrafts>() on OrderApproval.ID equals OrderApprovalDrafts.OrderApprovalID
                   join zayvka in db.mGetQuery<zayvka>() on OrderApproval.zayvkaID equals zayvka.id
                   join os_pro in db.mGetQuery<os_pro>() on zayvka.zak_1 equals os_pro.zak_1

                   // LEFT JOIN oborud
                   join oborud in db.mGetQuery<oborud>() on zayvka.rab_m equals oborud.rab_m into obGroup
                   from oborud in obGroup.DefaultIfEmpty()

                       // LEFT JOIN s_oper
                   join s_oper in db.mGetQuery<s_oper>() on zayvka.kodop equals s_oper.code into soGroup
                   from s_oper in soGroup.DefaultIfEmpty()

                       // LEFT JOIN prod
                   join p in db.mGetQuery<prod>()
                       on new { zayvka.zak_1, IsDrNull = (decimal?)null }
                       equals new { p.zak_1, IsDrNull = p.dr } into pGroup
                   from p in pGroup.DefaultIfEmpty()

                   where os_pro.d_vn_14 != null

                   orderby zayvka.zak_1

                   select new TechnologicalOrder
                   {
                       OrderNumber = zayvka.zak_1,
                       OrderApprovalID = OrderApproval.ID,
                       OrderApprovalDraftID = OrderApprovalDrafts.ID,
                       Technologist = OrderApproval.Technologist,
                       CoreDraft = (decimal)OrderApproval.CoreDraft,
                       Draft = OrderApproval.Draft,
                       CoreDraftName = OrderApproval.CoreDraftName.Trim(),
                       DraftName = OrderApproval.DraftName.Trim(),

                       Workshop = OrderApproval.Workshop,
                       Warehouse = OrderApproval.Warehouse,
                       Schedule = zayvka.graf,

                       Workplace = oborud != null ? (oborud.code + " " + oborud.oborud1).Trim() : null,
                       Operation = s_oper != null ? s_oper.oper.Trim() : null,

                       EquipmentDraft = OrderApprovalDrafts.EquipmentDraft,
                       EquipmentName = OrderApprovalDrafts.EquipmentName.Trim(),
                       EquipmentNameFromTechologist = OrderApproval.EquipmentNameFromTechnologist.Trim(),
                       EquipmentQuantityForOperation = OrderApproval.EquipmentQuantityForOperation,
                       EquimentRequiredQuantity = OrderApprovalDrafts.EquimentRequiredQuantity,
                       Cooperation = OrderApprovalDrafts.Cooperation,
                       IsDeletedFromOrder = OrderApprovalDrafts.IsDeletedFromOrder,

                       Note = zayvka.prim,
                       Analog = OrderApproval.Analog,
                       DesignComment = OrderApprovalDrafts.CommentForDesign,
                       ManufacturingComment = OrderApprovalDrafts.CommentForManufacturing,
                       OpenAtByTechnologist = OrderApproval.OpenAt,
                       Comment = null
                   };
        }

        #endregion Загрузка данных

        #region Методы согласования

        public Result ApproveOrder(Dictionary<string, object> data)
        {
            LoggerManager.MainLogger.Debug($"ApproveOrder for {CurrentItem.OrderNumber}");

            try
            {
                string comment = (string)data["Comment"];

                // Получение количества рабочих дней для согласования
                int workingDaysCount = db.mGetQuery<OrderApproval>()
                    .Where(order => order.ID == CurrentItem.OrderApprovalID)
                    .Join(
                        db.mGetQuery<OrderApprovalTypes>(),
                        order => order.EquipmentTypeID,
                        approvalType => approvalType.ID,
                        (order, approvalType) => approvalType.Term
                    )
                    .FirstOrDefault();

                // Получение даты выполнения с учетом рабочих дней
                DateTime deadlineDate = db.mGetQuery<calend>()
                    .Where(calendarDay => calendarDay.mday > DateTime.Today && calendarDay.v == true)
                    .OrderBy(calendarDay => calendarDay.mday)
                    .Skip(workingDaysCount - 1)
                    .Take(1)
                    .Select(calendarDay => calendarDay.mday)
                    .FirstOrDefault();

                // Если не нашли дату в календаре, используем простое сложение дней
                if (deadlineDate == default(DateTime))
                {
                    deadlineDate = DateTime.Today.AddDays(workingDaysCount);
                }

                // Обновление текущей записи согласования
                OrderApprovalHistory thisStepRecord = db.mGetList<OrderApprovalHistory>(
                    record =>
                    record.OrderApprovalID == CurrentItem.OrderApprovalID
                    && record.RecipientRole == "Начальник отдела заказов"
                    && record.RecipientName == "Дингес"
                )
                .Data
                .OrderByDescending(record => record.ID)
                .FirstOrDefault();

                if (thisStepRecord == null)
                {
                    return Result.Failed("Не найдена текущая запись согласования!");
                }

                thisStepRecord.CompletionDate = DateTime.Now;
                thisStepRecord.Status = "Выполнено";
                thisStepRecord.Result = "Согласовано";

                Result status = db.mUpdate(thisStepRecord);
                if (status.IsFailed)
                {
                    return Result.Failed("Не удалось обновить запись текущего согласования в БД!");
                }

                // Создание новой записи для следующего этапа согласования
                OrderApprovalHistory nextStepRecord = new OrderApprovalHistory
                {
                    OrderApprovalID = CurrentItem.OrderApprovalID,
                    ReceiptDate = DateTime.Now,
                    CompletionDate = null,
                    Term = deadlineDate,
                    RecipientRole = "Менеджер заказов",
                    RecipientName = "Папаева",
                    SenderRole = "Начальник отдела заказов",
                    SenderName = "Дингес",
                    Result = null,
                    Comment = comment
                };

                status = db.mAdd(nextStepRecord);
                if (status.IsFailed)
                {
                    return Result.Failed("Не удалось сохранить запись нового согласования в БД!");
                }

                return Result.Success();
            }
            catch (Exception ex)
            {
                LoggerManager.MainLogger.Error($"Ошибка в ApproveOrder: {ex.Message}");
                return Result.Failed($"Произошла ошибка при согласовании: {ex.Message}");
            }
        }

        public Result RejectOrder(Dictionary<string, object> data)
        {
            LoggerManager.MainLogger.Debug("Call RejectOrder");

            try
            {
                // Находим ID последней записи согласования
                var maxId = db.mGetQuery<OrderApprovalHistory>()
                    .Where(oah => oah.OrderApprovalID == CurrentItem.OrderApprovalID
                               && oah.RecipientRole == "Начальник отдела заказов"
                               && oah.RecipientName == "Дингес")
                    .Select(oah => oah.ID)
                    .Max();

                // Получаем последнюю запись согласования
                OrderApprovalHistory previousStepRecord = db.mGetSingle<OrderApprovalHistory>(
                    record => record.ID == maxId
                ).Data;

                if (previousStepRecord is null)
                {
                    LoggerManager.MainLogger.Error("Не найдена прошлая строка согласования");
                    return Result.Failed("Не найдена предыдущая запись согласования");
                }

                // Обновляем текущую запись согласования
                previousStepRecord.Status = "Выполнено";
                previousStepRecord.Result = "На доработку";
                previousStepRecord.CompletionDate = DateTime.Now;

                Result updateResult = db.mUpdate(previousStepRecord);
                if (updateResult.IsFailed)
                {
                    LoggerManager.MainLogger.Error($"Ошибка при обновлении записи: {updateResult.Message}");
                    return Result.Failed("Не удалось обновить запись согласования");
                }

                // Получение количества рабочих дней для согласования из OrderApprovalTypes
                int workingDaysCount = db.mGetQuery<OrderApproval>()
                    .Where(order => order.ID == CurrentItem.OrderApprovalID)
                    .Join(
                        db.mGetQuery<OrderApprovalTypes>(),
                        order => order.EquipmentTypeID,
                        approvalType => approvalType.ID,
                        (order, approvalType) => approvalType.Term
                    )
                    .FirstOrDefault();

                if (workingDaysCount <= 0)
                {
                    LoggerManager.MainLogger.Error($"Not found term for approvalType:");
                    return Result.Failed("Не найден срок");
                }

                // Расчет даты выполнения с учетом рабочих дней
                DateTime today = DateTime.Today;
                DateTime deadlineDate;

                // Получаем ближайшую рабочую дату после сегодняшней
                var firstWorkingDay = db.mGetQuery<calend>()
                    .Where(calendarDay => calendarDay.mday > today && calendarDay.v == true)
                    .OrderBy(calendarDay => calendarDay.mday)
                    .FirstOrDefault();

                if (firstWorkingDay != null)
                {
                    // Ищем дату, отстоящую на workingDaysCount рабочих дней вперед
                    deadlineDate = db.mGetQuery<calend>()
                        .Where(calendarDay => calendarDay.mday > today && calendarDay.v == true)
                        .OrderBy(calendarDay => calendarDay.mday)
                        .Skip(workingDaysCount - 1)
                        .Take(1)
                        .Select(calendarDay => calendarDay.mday)
                        .FirstOrDefault();
                }
                else
                {
                    deadlineDate = default(DateTime);
                }

                // Если не нашли дату в календаре, используем простое сложение дней
                if (deadlineDate == default(DateTime))
                {
                    // Добавляем рабочие дни + возможные выходные
                    deadlineDate = today.AddDays(workingDaysCount * 1.4);
                }

                // Извлечение данных из входного словаря
                string recipientRole = (string)data["Subdivision"];
                string recipientName = (string)data["SubdivisionRecipient"];
                string comment = (string)data["Comment"];

                // Создание новой записи для следующего этапа согласования
                OrderApprovalHistory nextStepRecord = new OrderApprovalHistory
                {
                    OrderApprovalID = CurrentItem.OrderApprovalID,
                    ReceiptDate = DateTime.Now,
                    CompletionDate = null,
                    Term = deadlineDate,
                    RecipientRole = recipientRole,
                    RecipientName = recipientName,
                    SenderRole = "Начальник отдела заказов",
                    SenderName = "Дингес",
                    Status = "В работе",
                    Result = null,
                    Comment = comment
                };

                Result addResult = db.mAdd(nextStepRecord);
                if (addResult.IsFailed)
                {
                    LoggerManager.MainLogger.Error($"Ошибка при добавлении записи: {addResult.Message}");
                    return Result.Failed("Не удалось создать новую запись согласования");
                }

                LoggerManager.MainLogger.Info($"Заказ отклонен и перенаправлен в {recipientRole} - {recipientName}");
                return Result.Success();
            }
            catch (Exception ex)
            {
                LoggerManager.MainLogger.Error($"Ошибка в RejectOrder: {ex.Message}", ex);
                return Result.Failed($"Произошла ошибка при отклонении заказа: {ex.Message}");
            }
        }

        #endregion Методы согласования
    }
}

using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Linq;
using Fox;
using Fox.Core;
using Fox.Core.Logging;
using Fox.DatabaseService.Entities;
using OrderApprovalSystem.Data;
using OrderApprovalSystem.Data.Entities;
using OrderApprovalSystem.Services;
using OrderApprovalSystem.Validators;

namespace OrderApprovalSystem.Models
{
    public class mOrderManager : mApproval
    {
        #region Свойства для UI

        private ObservableCollection<string> _nomenclatureGroups;
        public ObservableCollection<string> NomenclatureGroups
        {
            get => _nomenclatureGroups;
            set
            {
                _nomenclatureGroups = value;
                OnPropertyChanged(nameof(NomenclatureGroups));
            }
        }

        private ObservableCollection<OrderApprovalTypes> _equipmentTypes;
        public ObservableCollection<OrderApprovalTypes> EquipmentTypes
        {
            get => _equipmentTypes;
            set
            {
                _equipmentTypes = value;
                OnPropertyChanged(nameof(EquipmentTypes));
            }
        }

        #endregion Свойства для UI

        #region Конструктор

        public mOrderManager()
        {
            // Инициализация данных для выпадающих списков
            NomenclatureGroups = new ObservableCollection<string> { "Первая", "Вторая", "Третья" };
            EquipmentTypes = new ObservableCollection<OrderApprovalTypes>(
                db.mGetQuery<OrderApprovalTypes>().ToList()
            );

            LoadData();
        }

        #endregion Конструктор

        #region Загрузка данных

        protected override IQueryable<TechnologicalOrder> BuildBaseQuery()
        {
            return from OrderApproval in db.mGetQuery<OrderApproval>()
                   join OrderApprovalDrafts in db.mGetQuery<OrderApprovalDrafts>() on OrderApproval.ID equals OrderApprovalDrafts.OrderApprovalID
                   join zayvka in db.mGetQuery<zayvka>() on OrderApproval.zayvkaID equals zayvka.id
                   join os_pro in db.mGetQuery<os_pro>() on zayvka.zak_1 equals os_pro.zak_1

                   // LEFT JOIN oborud
                   join oborud in db.mGetQuery<oborud>() on zayvka.rab_m equals oborud.rab_m into obGroup
                   from oborud in obGroup.DefaultIfEmpty()

                       // LEFT JOIN s_oper
                   join s_oper in db.mGetQuery<s_oper>() on zayvka.kodop equals s_oper.code into soGroup
                   from s_oper in soGroup.DefaultIfEmpty()

                       // LEFT JOIN prod
                   join p in db.mGetQuery<prod>()
                       on new { zayvka.zak_1, IsDrNull = (decimal?)null }
                       equals new { p.zak_1, IsDrNull = p.dr } into pGroup
                   from p in pGroup.DefaultIfEmpty()

                   where os_pro.d_vn_14 != null

                   orderby zayvka.zak_1

                   select new TechnologicalOrder
                   {
                       OrderNumber = zayvka.zak_1,
                       OrderApprovalID = OrderApproval.ID,
                       OrderApprovalDraftID = OrderApprovalDrafts.ID,
                       Technologist = OrderApproval.Technologist,
                       CoreDraft = (decimal)OrderApproval.CoreDraft,
                       Draft = OrderApproval.Draft,
                       CoreDraftName = OrderApproval.CoreDraftName.Trim(),
                       DraftName = OrderApproval.DraftName.Trim(),

                       Workshop = OrderApproval.Workshop,
                       Warehouse = OrderApproval.Warehouse,
                       Schedule = zayvka.graf,

                       Workplace = oborud != null ? (oborud.code + " " + oborud.oborud1).Trim() : null,
                       Operation = s_oper != null ? s_oper.oper.Trim() : null,

                       EquipmentDraft = OrderApprovalDrafts.EquipmentDraft,
                       EquipmentName = OrderApprovalDrafts.EquipmentName.Trim(),
                       EquipmentNameFromTechologist = OrderApproval.EquipmentNameFromTechnologist.Trim(),
                       EquipmentQuantityForOperation = OrderApproval.EquipmentQuantityForOperation,
                       EquimentRequiredQuantity = OrderApprovalDrafts.EquimentRequiredQuantity,
                       Cooperation = OrderApprovalDrafts.Cooperation,
                       IsDeletedFromOrder = OrderApprovalDrafts.IsDeletedFromOrder,

                       Note = zayvka.prim,
                       Analog = OrderApproval.Analog,
                       DesignComment = OrderApprovalDrafts.CommentForDesign,
                       ManufacturingComment = OrderApprovalDrafts.CommentForManufacturing,
                       OpenAtByTechnologist = OrderApproval.OpenAt,
                       Comment = null,

                       IsByMemo = OrderApproval.IsByMemo,
                       MemoNumber = OrderApproval.MemoNumber,
                       MemoAuthor = OrderApproval.MemoAuthor,
                       CoreOrderByMemo = OrderApproval.CoreOrder,
                       CoreNumberByMemo = OrderApproval.CoreNumber,
                       OrderByMemo = OrderApproval.Order,
                       NumberByMemo = OrderApproval.Number,
                       OrderName = OrderApproval.OrderName,
                       OpenAtByMemo = OrderApproval.OpenAtByMemo,
                       NomenclatureGroup = OrderApproval.NomenclatureGroup,
                       EquipmentTypeID = OrderApproval.EquipmentTypeID,
                       DraftByMemo = OrderApproval.DraftByMemo,
                       DraftNameByMemo = OrderApproval.DraftNameByMemo,
                       Balance = OrderApproval.Balance,
                       WorkshopByMemo = OrderApproval.WorkshopByMemo,
                       EquipmentRequiredQuantityByMemo = OrderApproval.EquipmentRequiredQuantityByMemo
                   };
        }

        protected override void LoadData()
        {
            try
            {
                base.LoadData();

                // Обновляем EquipmentType для каждого заказа
                foreach (var group in GroupedData)
                {
                    foreach (var order in group.Items)
                    {
                        order.EquipmentType = ConvertToOrderApprovalType(order.EquipmentTypeID);
                    }
                }
            }
            catch (Exception ex)
            {
                LoggerManager.MainLogger.Error($"Error loading data: {ex.Message}");
                GroupedData = new ObservableCollection<TechnologistGroup>();
            }
        }

        private OrderApprovalTypes ConvertToOrderApprovalType(int? typeId)
        {
            if (typeId.HasValue)
            {
                return db.mGetSingle<OrderApprovalTypes>(
                    record => record.ID == typeId.Value
                ).Data;
            }
            return null;
        }

        #endregion Загрузка данных

        #region Методы согласования

        public Result ApproveOrder()
        {
            if (CurrentItem.IsByMemo)
            {
                return ApproveOrderByMemo();
            }
            return ApproveTechnologicalOrder();
        }

        private Result ApproveOrderByMemo()
        {
            // Валидация данных
            var validationResult = CreateOrderByMemoValidator.Validate(CurrentItem);
            if (validationResult.IsFailed)
            {
                return validationResult;
            }

            try
            {
                // Создаем новую запись OrderApproval для СЗ
                var newOrder = new OrderApproval
                {
                    IsByMemo = true,
                    MemoNumber = CurrentItem.MemoNumber,
                    MemoAuthor = CurrentItem.MemoAuthor,
                    Order = CurrentItem.OrderByMemo,
                    Number = CurrentItem.NumberByMemo,
                    OrderName = CurrentItem.OrderName,
                    CoreOrder = CurrentItem.CoreOrderByMemo,
                    CoreNumber = CurrentItem.CoreNumberByMemo,
                    OpenAtByMemo = CurrentItem.OpenAtByMemo,
                    NomenclatureGroup = CurrentItem.NomenclatureGroup,
                    EquipmentTypeID = CurrentItem.EquipmentType?.ID,
                    DraftByMemo = CurrentItem.DraftByMemo,
                    DraftNameByMemo = CurrentItem.DraftNameByMemo,
                    Balance = CurrentItem.Balance,
                    WorkshopByMemo = CurrentItem.WorkshopByMemo,
                    EquipmentRequiredQuantityByMemo = CurrentItem.EquipmentRequiredQuantityByMemo
                };

                var addResult = db.mAdd(newOrder);
                if (addResult.IsFailed)
                {
                    return Result.Failed("Не удалось создать заказ по СЗ");
                }

                db.mSaveChanges();

                // Получаем созданную запись
                var addedRecord = db.mGetQuery<OrderApproval>()
                    .OrderByDescending(r => r.ID)
                    .FirstOrDefault();

                // Создаем запись в истории согласования
                var historyRecord = new OrderApprovalHistory
                {
                    OrderApprovalID = addedRecord.ID,
                    ReceiptDate = DateTime.Now,
                    CompletionDate = DateTime.Now,
                    Term = DateTime.Now.Date.AddDays(1),
                    RecipientRole = "дальше",
                    RecipientName = "кто-то",
                    SenderRole = "Менеджер заказов",
                    SenderName = "Папаева",
                    Status = "Выполнено",
                    Result = "Согласовано"
                };

                db.mAdd(historyRecord);
                db.mSaveChanges();

                return Result.Success();
            }
            catch (Exception ex)
            {
                LoggerManager.MainLogger.Error($"Ошибка при создании заказа по СЗ: {ex.Message}");
                return Result.Failed($"Ошибка при создании заказа: {ex.Message}");
            }
        }

        private Result ApproveTechnologicalOrder()
        {
            // Валидация данных
            var validationResult = CreateOrderByMemoValidator.Validate(CurrentItem);
            if (validationResult.IsFailed)
            {
                return validationResult;
            }

            try
            {
                // Обновляем существующий OrderApproval
                var orderRecord = db.mGetSingle<OrderApproval>(
                    r => r.ID == CurrentItem.OrderApprovalID
                ).Data;

                if (orderRecord == null)
                {
                    return Result.Failed("Не найден заказ для обновления");
                }

                orderRecord.Order = CurrentItem.OrderByMemo;
                orderRecord.Number = CurrentItem.NumberByMemo;
                orderRecord.OrderName = CurrentItem.OrderName;
                orderRecord.CoreOrder = CurrentItem.CoreOrderByMemo;
                orderRecord.CoreNumber = CurrentItem.CoreNumberByMemo;
                orderRecord.OpenAtByMemo = CurrentItem.OpenAtByMemo;
                orderRecord.NomenclatureGroup = CurrentItem.NomenclatureGroup;
                orderRecord.EquipmentTypeID = CurrentItem.EquipmentType?.ID;
                orderRecord.DraftByMemo = CurrentItem.DraftByMemo;
                orderRecord.DraftNameByMemo = CurrentItem.DraftNameByMemo;
                orderRecord.Balance = CurrentItem.Balance;
                orderRecord.WorkshopByMemo = CurrentItem.WorkshopByMemo;
                orderRecord.EquipmentRequiredQuantityByMemo = CurrentItem.EquipmentRequiredQuantityByMemo;

                var updateResult = db.mUpdate(orderRecord);
                if (updateResult.IsFailed)
                {
                    return Result.Failed("Не удалось обновить данные заказа");
                }

                // Обновляем текущую запись в истории согласования
                var currentHistory = db.mGetList<OrderApprovalHistory>(
                    r => r.OrderApprovalID == orderRecord.ID
                ).Data
                .OrderByDescending(r => r.ID)
                .FirstOrDefault();

                if (currentHistory != null)
                {
                    currentHistory.CompletionDate = DateTime.Now;
                    currentHistory.Status = "Выполнено";
                    currentHistory.Result = "Согласовано";
                    db.mUpdate(currentHistory);
                }

                // Получение количества рабочих дней для согласования
                int workingDaysCount = db.mGetQuery<OrderApproval>()
                    .Where(order => order.ID == CurrentItem.OrderApprovalID)
                    .Join(
                        db.mGetQuery<OrderApprovalTypes>(),
                        order => order.EquipmentTypeID,
                        approvalType => approvalType.ID,
                        (order, approvalType) => approvalType.Term
                    )
                    .FirstOrDefault();

                // Получение даты выполнения с учетом рабочих дней
                DateTime deadlineDate = db.mGetQuery<calend>()
                    .Where(calendarDay => calendarDay.mday > DateTime.Today && calendarDay.v == true)
                    .OrderBy(calendarDay => calendarDay.mday)
                    .Skip(workingDaysCount - 1)
                    .Take(1)
                    .Select(calendarDay => calendarDay.mday)
                    .FirstOrDefault();

                if (deadlineDate == default(DateTime))
                {
                    deadlineDate = DateTime.Today.AddDays(workingDaysCount);
                }

                // Создаем новую запись для следующего этапа
                var nextHistory = new OrderApprovalHistory
                {
                    OrderApprovalID = orderRecord.ID,
                    ReceiptDate = DateTime.Now,
                    CompletionDate = null,
                    Term = deadlineDate,
                    RecipientRole = "Кто-то после менеджера",
                    RecipientName = "Кто-то после менеджера",
                    SenderRole = "Менеджер заказов",
                    SenderName = "Папаева",
                    Status = "В работе",
                    Result = null
                };

                db.mAdd(nextHistory);
                db.mSaveChanges();

                return Result.Success();
            }
            catch (Exception ex)
            {
                LoggerManager.MainLogger.Error($"Ошибка при согласовании тех. заказа: {ex.Message}");
                return Result.Failed($"Ошибка при согласовании: {ex.Message}");
            }
        }

        public Result RejectOrder(Dictionary<string, object> data)
        {
            LoggerManager.MainLogger.Debug("Call RejectOrder");

            try
            {
                // Находим ID последней записи согласования для менеджера Папаевой
                var maxId = db.mGetQuery<OrderApprovalHistory>()
                    .Where(oah => oah.OrderApprovalID == CurrentItem.OrderApprovalID
                               && oah.RecipientRole == "Менеджер заказов"
                               && oah.RecipientName == "Папаева")
                    .Select(oah => oah.ID)
                    .Max();

                // Получаем последнюю запись согласования
                var previousStepRecord = db.mGetSingle<OrderApprovalHistory>(
                    record => record.ID == maxId
                ).Data;

                if (previousStepRecord is null)
                {
                    LoggerManager.MainLogger.Error("Не найдена прошлая строка согласования");
                    return Result.Failed("Не найдена предыдущая запись согласования");
                }

                // Обновляем текущую запись согласования
                previousStepRecord.Status = "Выполнено";
                previousStepRecord.Result = "На доработку";
                previousStepRecord.CompletionDate = DateTime.Now;

                var updateResult = db.mUpdate(previousStepRecord);
                if (updateResult.IsFailed)
                {
                    LoggerManager.MainLogger.Error($"Ошибка при обновлении записи: {updateResult.Message}");
                    return Result.Failed("Не удалось обновить запись согласования");
                }

                // Получение количества рабочих дней для согласования
                int workingDaysCount = db.mGetQuery<OrderApproval>()
                    .Where(order => order.ID == CurrentItem.OrderApprovalID)
                    .Join(
                        db.mGetQuery<OrderApprovalTypes>(),
                        order => order.EquipmentTypeID,
                        approvalType => approvalType.ID,
                        (order, approvalType) => approvalType.Term
                    )
                    .FirstOrDefault();

                if (workingDaysCount <= 0)
                {
                    return Result.Failed("Не найден срок для назначения согласования!");
                }

                // Расчет даты выполнения с учетом рабочих дней
                DateTime today = DateTime.Today;
                DateTime deadlineDate;

                // Получаем ближайшую рабочую дату после сегодняшней
                var firstWorkingDay = db.mGetQuery<calend>()
                    .Where(calendarDay => calendarDay.mday > today && calendarDay.v == true)
                    .OrderBy(calendarDay => calendarDay.mday)
                    .FirstOrDefault();

                if (firstWorkingDay != null)
                {
                    // Ищем дату, отстоящую на workingDaysCount рабочих дней вперед
                    deadlineDate = db.mGetQuery<calend>()
                        .Where(calendarDay => calendarDay.mday > today && calendarDay.v == true)
                        .OrderBy(calendarDay => calendarDay.mday)
                        .Skip(workingDaysCount - 1)
                        .Take(1)
                        .Select(calendarDay => calendarDay.mday)
                        .FirstOrDefault();
                }
                else
                {
                    return Result.Failed("Ошибка установки строки согласования");
                }

                if (deadlineDate == default(DateTime))
                {
                    deadlineDate = today.AddDays(workingDaysCount * 1.4);
                }

                // Извлечение данных из входного словаря
                string recipientRole = (string)data["Subdivision"];
                string recipientName = (string)data["SubdivisionRecipient"];
                string comment = (string)data["Comment"];

                // Создание новой записи для следующего этапа согласования
                var nextStepRecord = new OrderApprovalHistory
                {
                    OrderApprovalID = CurrentItem.OrderApprovalID,
                    ReceiptDate = DateTime.Now,
                    CompletionDate = null,
                    Term = deadlineDate,
                    RecipientRole = recipientRole,
                    RecipientName = recipientName,
                    SenderRole = "Менеджер заказов",
                    SenderName = "Папаева",
                    Status = "В работе",
                    Result = null,
                    Comment = comment
                };

                var addResult = db.mAdd(nextStepRecord);
                if (addResult.IsFailed)
                {
                    LoggerManager.MainLogger.Error($"Ошибка при добавлении записи: {addResult.Message}");
                    return Result.Failed("Не удалось создать новую запись согласования");
                }

                LoggerManager.MainLogger.Info($"Заказ отклонен и перенаправлен в {recipientRole} - {recipientName}");
                return Result.Success();
            }
            catch (Exception ex)
            {
                LoggerManager.MainLogger.Error($"Ошибка в RejectOrder: {ex.Message}", ex);
                return Result.Failed($"Произошла ошибка при отклонении заказа: {ex.Message}");
            }
        }

        #endregion Методы согласования

        #region Методы для UI

        public Result CreateOrderByMemo()
        {
            try
            {
                var newGroup = new TechnologistGroup
                {
                    Zak1 = "Новая СЗ",
                    IsByMemo = true,
                    Items = new ObservableCollection<TechnologicalOrder>
                    {
                        new TechnologicalOrder
                        {
                            IsByMemo = true,
                            MemoNumber = "Новая",
                            OpenAtByMemo = DateTime.Now
                        }
                    }
                };

                if (GroupedData == null)
                {
                    GroupedData = new ObservableCollection<TechnologistGroup>();
                }

                GroupedData.Add(newGroup);
                CurrentGroup = newGroup;

                return Result.Success();
            }
            catch (Exception ex)
            {
                LoggerManager.MainLogger.Error($"Ошибка при создании заказа по СЗ: {ex.Message}");
                return Result.Failed($"Ошибка: {ex.Message}");
            }
        }

        #endregion Методы для UI
    }
}

using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Linq;
using Fox;
using Fox.Core;
using Fox.Core.Logging;
using Fox.DatabaseService.Entities;
using OrderApprovalSystem.Data;
using OrderApprovalSystem.Data.Entities;

namespace OrderApprovalSystem.Models
{
    public class mSubTechnologist : mApproval
    {
        /// <summary>
        /// Конструктор
        /// </summary>
        public mSubTechnologist()
        {
            LoadData();
        }

        #region Загрузка данных

        protected override IQueryable<TechnologicalOrder> BuildBaseQuery()
        {
            return from OrderApproval in db.mGetQuery<OrderApproval>()
                   join OrderApprovalDrafts in db.mGetQuery<OrderApprovalDrafts>() on OrderApproval.ID equals OrderApprovalDrafts.OrderApprovalID
                   join zayvka in db.mGetQuery<zayvka>() on OrderApproval.zayvkaID equals zayvka.id
                   join os_pro in db.mGetQuery<os_pro>() on zayvka.zak_1 equals os_pro.zak_1

                   // LEFT JOIN oborud
                   join oborud in db.mGetQuery<oborud>() on zayvka.rab_m equals oborud.rab_m into obGroup
                   from oborud in obGroup.DefaultIfEmpty()

                       // LEFT JOIN s_oper
                   join s_oper in db.mGetQuery<s_oper>() on zayvka.kodop equals s_oper.code into soGroup
                   from s_oper in soGroup.DefaultIfEmpty()

                       // LEFT JOIN prod
                   join p in db.mGetQuery<prod>()
                       on new { zayvka.zak_1, IsDrNull = (decimal?)null }
                       equals new { p.zak_1, IsDrNull = p.dr } into pGroup
                   from p in pGroup.DefaultIfEmpty()

                   where os_pro.d_vn_14 != null

                   orderby zayvka.zak_1

                   select new TechnologicalOrder
                   {
                       OrderNumber = zayvka.zak_1,
                       OrderApprovalID = OrderApproval.ID,
                       OrderApprovalDraftID = OrderApprovalDrafts.ID,
                       Technologist = OrderApproval.Technologist,
                       CoreDraft = (decimal)OrderApproval.CoreDraft,
                       Draft = OrderApproval.Draft,
                       CoreDraftName = OrderApproval.CoreDraftName.Trim(),
                       DraftName = OrderApproval.DraftName.Trim(),

                       Workshop = OrderApproval.Workshop,
                       Warehouse = OrderApproval.Warehouse,
                       Schedule = zayvka.graf,

                       Workplace = oborud != null ? (oborud.code + " " + oborud.oborud1).Trim() : null,
                       Operation = s_oper != null ? s_oper.oper.Trim() : null,

                       EquipmentDraft = OrderApprovalDrafts.EquipmentDraft,
                       EquipmentName = OrderApprovalDrafts.EquipmentName.Trim(),
                       EquipmentNameFromTechologist = OrderApproval.EquipmentNameFromTechnologist.Trim(),
                       EquipmentQuantityForOperation = OrderApproval.EquipmentQuantityForOperation,
                       EquimentRequiredQuantity = OrderApprovalDrafts.EquimentRequiredQuantity,
                       Cooperation = OrderApprovalDrafts.Cooperation,
                       IsDeletedFromOrder = OrderApprovalDrafts.IsDeletedFromOrder,

                       Note = zayvka.prim,
                       Analog = OrderApproval.Analog,
                       DesignComment = OrderApprovalDrafts.CommentForDesign,
                       ManufacturingComment = OrderApprovalDrafts.CommentForManufacturing,
                       OpenAtByTechnologist = OrderApproval.OpenAt,
                       Comment = null
                   };
        }

        #endregion Загрузка данных

        #region Методы согласования

        public Result ApproveOrder(Dictionary<string, object> data)
        {
            LoggerManager.MainLogger.Debug($"ApproveOrder for {CurrentItem.OrderNumber}");

            try
            {
                // Извлечение данных из входного словаря
                DateTime manufacturingTerm = (DateTime)data["ManufacturingTerm"];
                string comment = (string)data["Comment"];

                // Получение количества рабочих дней для согласования
                int workingDaysCount = db.mGetQuery<OrderApproval>()
                    .Where(order => order.ID == CurrentItem.OrderApprovalID)
                    .Join(
                        db.mGetQuery<OrderApprovalTypes>(),
                        order => order.EquipmentTypeID,
                        approvalType => approvalType.ID,
                        (order, approvalType) => approvalType.Term
                    )
                    .FirstOrDefault();

                // Получение даты выполнения с учетом рабочих дней
                DateTime deadlineDate = db.mGetQuery<calend>()
                    .Where(calendarDay => calendarDay.mday > manufacturingTerm && calendarDay.v == true)
                    .OrderBy(calendarDay => calendarDay.mday)
                    .Skip(workingDaysCount - 1) // Пропускаем N-1 рабочих дней
                    .Take(1)
                    .Select(calendarDay => calendarDay.mday)
                    .FirstOrDefault();

                // Если не нашли дату в календаре, используем простое сложение дней
                if (deadlineDate == default(DateTime))
                {
                    deadlineDate = DateTime.Today.AddDays(workingDaysCount);
                }

                // Обновление текущей записи согласования
                OrderApprovalHistory thisStepRecord = db.mGetList<OrderApprovalHistory>(
                    record =>
                    record.OrderApprovalID == CurrentItem.OrderApprovalID
                    && record.RecipientRole == "Технолог"
                    && record.RecipientName == "Рагульский"
                )
                .Data
                .OrderByDescending(record => record.ID)
                .FirstOrDefault();

                if (thisStepRecord == null)
                {
                    return Result.Failed("Не найдена текущая запись согласования!");
                }

                thisStepRecord.Status = "Выполнено";
                thisStepRecord.Result = "Согласовано";

                Result status = db.mUpdate(thisStepRecord);
                if (status.IsFailed)
                {
                    return Result.Failed("Не удалось обновить запись текущего согласования в БД!");
                }

                // Создание новой записи для следующего этапа согласования
                OrderApprovalHistory nextStepRecord = new OrderApprovalHistory
                {
                    OrderApprovalID = CurrentItem.OrderApprovalID,
                    ReceiptDate = DateTime.Now,
                    CompletionDate = null,
                    Term = deadlineDate,
                    RecipientRole = "Начальник отдела заказов",
                    RecipientName = "Дингес",
                    SenderRole = "Технолог",
                    SenderName = "Рагульский",
                    Result = null,
                    Comment = comment
                };

                status = db.mAdd(nextStepRecord);
                if (status.IsFailed)
                {
                    return Result.Failed("Не удалось сохранить запись нового согласования в БД!");
                }

                return Result.Success();
            }
            catch (Exception ex)
            {
                LoggerManager.MainLogger.Error($"Ошибка в ApproveOrder: {ex.Message}");
                return Result.Failed($"Произошла ошибка при согласовании: {ex.Message}");
            }
        }

        public Result RejectOrder(Dictionary<string, object> data)
        {
            LoggerManager.MainLogger.Debug("Call RejectOrder");

            try
            {
                // Находим ID последней записи согласования для технолога Рагульского
                var maxId = db.mGetQuery<OrderApprovalHistory>()
                    .Where(oah => oah.OrderApprovalID == CurrentItem.OrderApprovalID
                               && oah.RecipientRole == "Технолог"
                               && oah.RecipientName == "Рагульский")
                    .Select(oah => oah.ID)
                    .Max();

                // Получаем последнюю запись согласования
                OrderApprovalHistory previousStepRecord = db.mGetSingle<OrderApprovalHistory>(
                    record => record.ID == maxId
                ).Data;

                if (previousStepRecord is null)
                {
                    LoggerManager.MainLogger.Error("Не найдена прошлая строка согласования");
                    return Result.Failed("Не найдена предыдущая запись согласования");
                }

                // Обновляем текущую запись согласования
                previousStepRecord.Status = "Выполнено";
                previousStepRecord.Result = "На доработку";
                previousStepRecord.CompletionDate = DateTime.Now;

                Result updateResult = db.mUpdate(previousStepRecord);
                if (updateResult.IsFailed)
                {
                    LoggerManager.MainLogger.Error($"Ошибка при обновлении записи: {updateResult.Message}");
                    return Result.Failed("Не удалось обновить запись согласования");
                }

                // Получение количества рабочих дней для согласования из OrderApprovalTypes
                int workingDaysCount = db.mGetQuery<OrderApproval>()
                    .Where(order => order.ID == CurrentItem.OrderApprovalID)
                    .Join(
                        db.mGetQuery<OrderApprovalTypes>(),
                        order => order.EquipmentTypeID,
                        approvalType => approvalType.ID,
                        (order, approvalType) => approvalType.Term
                    )
                    .FirstOrDefault();

                if (workingDaysCount <= 0)
                {
                    LoggerManager.MainLogger.Error($"Not found term for approvalType:");
                    return Result.Failed("Не найден срок");
                }

                // Расчет даты выполнения с учетом рабочих дней
                DateTime today = DateTime.Today;
                DateTime deadlineDate;

                // Получаем ближайшую рабочую дату после сегодняшней
                var firstWorkingDay = db.mGetQuery<calend>()
                    .Where(calendarDay => calendarDay.mday > today && calendarDay.v == true)
                    .OrderBy(calendarDay => calendarDay.mday)
                    .FirstOrDefault();

                if (firstWorkingDay != null)
                {
                    // Ищем дату, отстоящую на workingDaysCount рабочих дней вперед
                    deadlineDate = db.mGetQuery<calend>()
                        .Where(calendarDay => calendarDay.mday > today && calendarDay.v == true)
                        .OrderBy(calendarDay => calendarDay.mday)
                        .Skip(workingDaysCount - 1) // Пропускаем N-1 рабочих дней
                        .Take(1)
                        .Select(calendarDay => calendarDay.mday)
                        .FirstOrDefault();
                }
                else
                {
                    deadlineDate = default(DateTime);
                }

                // Если не нашли дату в календаре, используем простое сложение дней
                if (deadlineDate == default(DateTime))
                {
                    // Добавляем рабочие дни + возможные выходные
                    deadlineDate = today.AddDays(workingDaysCount * 1.4); // коэффициент для учета выходных
                }

                // Извлечение данных из входного словаря
                string recipientRole = (string)data["Subdivision"];
                string recipientName = (string)data["SubdivisionRecipient"];
                string comment = (string)data["Comment"];

                // Создание новой записи для следующего этапа согласования
                OrderApprovalHistory nextStepRecord = new OrderApprovalHistory
                {
                    OrderApprovalID = CurrentItem.OrderApprovalID,
                    ReceiptDate = DateTime.Now,
                    CompletionDate = null, // Для новой записи CompletionDate должен быть null
                    Term = deadlineDate,
                    RecipientRole = recipientRole,
                    RecipientName = recipientName,
                    SenderRole = "Технолог",
                    SenderName = "Рагульский",
                    Status = "В работе", // Новая запись начинается со статуса "В работе"
                    Result = null, // Результат еще не определен
                    Comment = comment
                };

                Result addResult = db.mAdd(nextStepRecord);
                if (addResult.IsFailed)
                {
                    LoggerManager.MainLogger.Error($"Ошибка при добавлении записи: {addResult.Message}");
                    return Result.Failed("Не удалось создать новую запись согласования");
                }

                LoggerManager.MainLogger.Info($"Заказ отклонен и перенаправлен в {recipientRole} - {recipientName}");
                return Result.Success();
            }
            catch (Exception ex)
            {
                LoggerManager.MainLogger.Error($"Ошибка в RejectOrder: {ex.Message}", ex);
                return Result.Failed($"Произошла ошибка при отклонении заказа: {ex.Message}");
            }
        }

        #endregion Методы согласования
    }
}

using Fox;


namespace OrderApprovalSystem.Models
{

    public class mMain : MBase
    {
        /// <summary>
        /// Конструктор
        /// </summary>
        public mMain()
        {
            pCurrentViewName = "Dev"; // Начальное представление
        }

        #region Свойства

        /// <summary>
        /// Имя текущего представления
        /// </summary>
        public string pCurrentViewName
        {
            get { return _currentViewName; }
            set
            {
                _currentViewName = value;
                OnPropertyChanged("pCurrentViewName");
            }
        }

        #endregion Свойства

        #region Переменные

        /// <summary>
        /// Текущее активное представление
        /// </summary>
        private string _currentViewName;

        #endregion Переменные
    }

}

<UserControl x:Class="OrderApprovalSystem.Views.BaseApprovalView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
             xmlns:behaviors="clr-namespace:OrderApprovalSystem.Behaviors"
             Background="{DynamicResource PrimaryBackgroundBrush}"
             Foreground="{DynamicResource TextBrush}">

    <i:Interaction.Triggers>
        <i:EventTrigger EventName="Loaded">
            <i:CallMethodAction TargetObject="{Binding}" MethodName="viewLoaded"/>
        </i:EventTrigger>
    </i:Interaction.Triggers>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="{Binding LeftColumnWidth}"/>
            <ColumnDefinition Width="{Binding CenterColumnWidth}"/>
            <ColumnDefinition Width="{Binding RightColumnWidth}"/>
        </Grid.ColumnDefinitions>

        <!-- Левая панель - Список заказов -->
        <Border Grid.Column="0" 
                Margin="5" 
                BorderThickness="2" 
                BorderBrush="{DynamicResource AccentBrush}" 
                Background="{DynamicResource SecondaryBackgroundBrush}"
                CornerRadius="4">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Заголовок таблицы -->
                <Border Grid.Row="0"
                        Background="{DynamicResource AccentBrush}"
                        CornerRadius="2,2,0,0"
                        Padding="10">
                    <TextBlock Text="{Binding OrdersTitle}"
                               Foreground="White"
                               FontSize="14"
                               FontWeight="Bold"
                               HorizontalAlignment="Center"/>
                </Border>

                <!-- DataGrid с группами заказов -->
                <DataGrid Grid.Row="1"
                          IsReadOnly="True"
                          AutoGenerateColumns="False"
                          SelectionMode="Single"
                          HeadersVisibility="Column"
                          HorizontalScrollBarVisibility="Disabled"
                          CanUserAddRows="False"
                          x:Name="dgReport" 
                          ItemsSource="{Binding model.GroupedData}" 
                          SelectedItem="{Binding model.CurrentGroup, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">

                    <i:Interaction.Behaviors>
                        <behaviors:ScrollIntoViewBehavior SelectedItem="{Binding model.CurrentGroup, Mode=OneWay}"/>
                    </i:Interaction.Behaviors>

                    <DataGrid.Columns>
                        <!-- Базовые колонки -->
                        <DataGridTextColumn Header="Тех. заказ" 
                                            Binding="{Binding Zak1}" 
                                            Width="80"/>
                        <!-- Динамические колонки добавляются через ViewModel -->
                    </DataGrid.Columns>
                </DataGrid>
            </Grid>
        </Border>

        <!-- Центральная панель - Детали заказа -->
        <Border Grid.Column="1" 
                Margin="0,5,0,5" 
                BorderThickness="2" 
                BorderBrush="{DynamicResource GreenAccentBrush}" 
                Background="{DynamicResource SecondaryBackgroundBrush}"
                CornerRadius="4"
                Padding="5">
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <Grid IsSharedSizeScope="True">
                    <StackPanel>
                        <TextBlock Text="{Binding OrderDetailsTitle}"
                                   FontSize="16"
                                   FontWeight="Bold"
                                   HorizontalAlignment="Center"
                                   Foreground="{DynamicResource TextBrush}"
                                   Margin="0"/>

                        <!-- Статические атрибуты (общие для всех) -->
                        <Grid Style="{StaticResource AttributeRowStyle}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>
                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Изделие:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>
                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.CoreDraft}" 
                                       Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

                        <Grid Style="{StaticResource AttributeRowStyle}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>
                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Наименование изделия:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>
                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.CoreDraftName}" 
                                       Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <!-- Динамический контент для ролей -->
                        <ContentControl Content="{Binding RoleSpecificCentralContent}"/>
                    </StackPanel>
                </Grid>
            </ScrollViewer>
        </Border>

        <!-- Правая панель - Подзаказы -->
        <Border Grid.Column="2" 
                Margin="5,5,5,5" 
                BorderThickness="2" 
                BorderBrush="{DynamicResource GreenAccentBrush}" 
                Background="{DynamicResource SecondaryBackgroundBrush}"
                CornerRadius="4"
                Padding="5">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <TextBlock Grid.Row="0"
                           Text="{Binding model.CurrentGroup.Zak1, StringFormat='Тех. заказ: {0}'}"
                           FontSize="16"
                           FontWeight="Bold"
                           HorizontalAlignment="Center"
                           Foreground="{DynamicResource TextBrush}"
                           Margin="0,0,0,10"/>

                <!-- DataGrid подзаказов -->
                <DataGrid Grid.Row="1"
                          ItemsSource="{Binding model.CurrentGroup.Items}"
                          SelectedItem="{Binding model.CurrentItem, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                          AutoGenerateColumns="False"
                          IsReadOnly="{Binding IsSubOrdersReadOnly}"
                          CanUserAddRows="False"
                          HeadersVisibility="Column"
                          SelectionMode="Single"
                          Margin="0,0,0,5">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Чертеж" Binding="{Binding EquipmentDraft}" Width="Auto"/>
                        <DataGridTextColumn Header="Наименование" Binding="{Binding EquipmentNameFromTechologist}" 
                                           Width="Auto" CellStyle="{DynamicResource LeftAlignedDataGridCell}"/>
                        <!-- Динамические колонки добавляются через ViewModel -->
                    </DataGrid.Columns>
                </DataGrid>

                <!-- Детальная информация -->
                <Border Grid.Row="2"
                        BorderThickness="2" 
                        BorderBrush="Red" 
                        Background="{DynamicResource SecondaryBackgroundBrush}"
                        CornerRadius="4"
                        Padding="5">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <Grid IsSharedSizeScope="True">
                            <StackPanel>
                                <TextBlock Text="Данные чертежа"
                                           FontSize="16"
                                           FontWeight="Bold"
                                           HorizontalAlignment="Center"
                                           Foreground="{DynamicResource TextBrush}"
                                           Margin="0"/>

                                <Grid Style="{StaticResource AttributeRowStyle}">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                        <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                                    </Grid.ColumnDefinitions>
                                    <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                        <TextBlock Text="Доп. сведения для проектирования:" Style="{StaticResource AttributeLabelTextStyle}"/>
                                    </Border>
                                    <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.DesignComment}" 
                                               TextWrapping="Wrap" Style="{StaticResource AttributeValueStyle}"/>
                                </Grid>

                                <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

                                <Grid Style="{StaticResource AttributeRowStyle}">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                        <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                                    </Grid.ColumnDefinitions>
                                    <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                        <TextBlock Text="Доп. сведения для производства:" Style="{StaticResource AttributeLabelTextStyle}"/>
                                    </Border>
                                    <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.ManufacturingComment}" 
                                               TextWrapping="Wrap" Style="{StaticResource AttributeValueStyle}"/>
                                </Grid>
                            </StackPanel>
                        </Grid>
                    </ScrollViewer>
                </Border>
            </Grid>
        </Border>
    </Grid>
</UserControl>

<UserControl x:Class="OrderApprovalSystem.Views.RoleSpecificPanels.HeadOrderDepartmentCentralPanel"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:local="clr-namespace:OrderApprovalSystem.ViewModels"
             DataContext="{Binding RelativeSource={RelativeSource Self}, Path=ViewModel}">

    <StackPanel>
        <!-- Технолог (только для чтения) -->
        <Grid Style="{StaticResource AttributeRowStyle}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
            </Grid.ColumnDefinitions>
            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                <TextBlock Text="Технолог:" Style="{StaticResource AttributeLabelTextStyle}"/>
            </Border>
            <TextBlock Grid.Column="1" 
                       Text="{Binding Model.CurrentItem.Technologist}" 
                       Style="{StaticResource AttributeValueStyle}"/>
        </Grid>

        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

        <!-- Номер СЗ (только для чтения) -->
        <Grid>
            <Grid.Style>
                <Style TargetType="Grid" BasedOn="{StaticResource AttributeRowStyle}">
                    <Setter Property="Visibility" Value="Visible"/>
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding Model.CurrentGroup.IsByMemo}" Value="False">
                            <Setter Property="Visibility" Value="Collapsed"/>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </Grid.Style>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
            </Grid.ColumnDefinitions>
            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                <TextBlock Text="Номер СЗ:" Style="{StaticResource AttributeLabelTextStyle}"/>
            </Border>
            <TextBlock Grid.Column="1" 
               Text="{Binding Model.CurrentItem.MemoNumber}" 
               Style="{StaticResource AttributeValueStyle}"/>
        </Grid>

        <Separator>
            <Separator.Style>
                <Style TargetType="Separator" BasedOn="{StaticResource AttributeSeparatorStyle}">
                    <Setter Property="Visibility" Value="Visible"/>
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding Model.CurrentGroup.IsByMemo}" Value="False">
                            <Setter Property="Visibility" Value="Collapsed"/>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </Separator.Style>
        </Separator>

        <!-- Заказ (только для чтения) -->
        <Grid Style="{StaticResource AttributeRowStyle}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
            </Grid.ColumnDefinitions>
            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                <TextBlock Text="Заказ:" Style="{StaticResource AttributeLabelTextStyle}"/>
            </Border>
            <TextBlock Grid.Column="1" 
                       Text="{Binding Model.CurrentItem.OrderByMemo}" 
                       Style="{StaticResource AttributeValueStyle}"/>
        </Grid>

        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

        <!-- Тип оснастки (только для чтения) -->
        <Grid Style="{StaticResource AttributeRowStyle}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
            </Grid.ColumnDefinitions>
            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                <TextBlock Text="Тип оснастки:" Style="{StaticResource AttributeLabelTextStyle}"/>
            </Border>
            <TextBlock Grid.Column="1" 
                       Text="{Binding Model.CurrentItem.EquipmentType.TypeName}" 
                       Style="{StaticResource AttributeValueStyle}"/>
        </Grid>
    </StackPanel>
</UserControl>

using System.Windows;
using System.Windows.Controls;
using OrderApprovalSystem.ViewModels;

namespace OrderApprovalSystem.Views.RoleSpecificPanels
{
    public partial class HeadOrderDepartmentCentralPanel : UserControl
    {
        public static readonly DependencyProperty ViewModelProperty =
            DependencyProperty.Register(
                "ViewModel",
                typeof(vmHeadOrderDepartment),
                typeof(HeadOrderDepartmentCentralPanel),
                new PropertyMetadata(null));

        public vmHeadOrderDepartment ViewModel
        {
            get => (vmHeadOrderDepartment)GetValue(ViewModelProperty);
            set => SetValue(ViewModelProperty, value);
        }

        public HeadOrderDepartmentCentralPanel()
        {
            InitializeComponent();
        }
    }
}

<UserControl x:Class="OrderApprovalSystem.Views.RoleSpecificPanels.OrderManagerCentralPanel"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:local="clr-namespace:OrderApprovalSystem.ViewModels"
             xmlns:converters="clr-namespace:OrderApprovalSystem.Converters"
             DataContext="{Binding RelativeSource={RelativeSource Self}, Path=ViewModel}">

    <UserControl.Resources>
        <converters:MaskedDateConverter x:Key="MaskedDateConverter"/>

        <!-- Стили для условного отображения -->
        <Style x:Key="MemoConditionalRowStyle" TargetType="Grid" BasedOn="{StaticResource AttributeRowStyle}">
            <Setter Property="Visibility" Value="Visible"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding Model.CurrentGroup.IsByMemo}" Value="False">
                    <Setter Property="Visibility" Value="Collapsed"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="TechnologistConditionalRowStyle" TargetType="Grid" BasedOn="{StaticResource AttributeRowStyle}">
            <Setter Property="Visibility" Value="Visible"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding Model.CurrentGroup.IsByMemo}" Value="True">
                    <Setter Property="Visibility" Value="Collapsed"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>
    </UserControl.Resources>

    <StackPanel>
        <!-- Заголовок раздела СЗ -->
        <TextBlock Text="Данные служебной записки"
                   FontSize="14"
                   FontWeight="Bold"
                   HorizontalAlignment="Center"
                   Foreground="{DynamicResource TextBrush}"
                   Margin="0,10,0,5">
            <TextBlock.Style>
                <Style TargetType="TextBlock">
                    <Setter Property="Visibility" Value="Collapsed"/>
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding Model.CurrentGroup.IsByMemo}" Value="True">
                            <Setter Property="Visibility" Value="Visible"/>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </TextBlock.Style>
        </TextBlock>

        <!-- Номер служебной записки -->
        <Grid Style="{StaticResource MemoConditionalRowStyle}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
            </Grid.ColumnDefinitions>
            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                <TextBlock Text="Номер СЗ:" Style="{StaticResource AttributeLabelTextStyle}"/>
            </Border>
            <TextBox Grid.Column="1" 
                     Text="{Binding Model.CurrentItem.MemoNumber, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                     Style="{StaticResource AttributeTextBoxStyle}"/>
        </Grid>

        <Separator>
            <Separator.Style>
                <Style TargetType="Separator" BasedOn="{StaticResource AttributeSeparatorStyle}">
                    <Setter Property="Visibility" Value="Visible"/>
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding Model.CurrentGroup.IsByMemo}" Value="False">
                            <Setter Property="Visibility" Value="Collapsed"/>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </Separator.Style>
        </Separator>

        <!-- Автор служебной записки -->
        <Grid Style="{StaticResource MemoConditionalRowStyle}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
            </Grid.ColumnDefinitions>
            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                <TextBlock Text="Автор СЗ:" Style="{StaticResource AttributeLabelTextStyle}"/>
            </Border>
            <TextBox Grid.Column="1" 
                     Text="{Binding Model.CurrentItem.MemoAuthor, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                     Style="{StaticResource AttributeTextBoxStyle}"/>
        </Grid>

        <Separator>
            <Separator.Style>
                <Style TargetType="Separator" BasedOn="{StaticResource AttributeSeparatorStyle}">
                    <Setter Property="Visibility" Value="Visible"/>
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding Model.CurrentGroup.IsByMemo}" Value="False">
                            <Setter Property="Visibility" Value="Collapsed"/>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </Separator.Style>
        </Separator>

        <!-- Технолог (только для тех. заказов) -->
        <Grid Style="{StaticResource TechnologistConditionalRowStyle}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
            </Grid.ColumnDefinitions>
            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                <TextBlock Text="Технолог:" Style="{StaticResource AttributeLabelTextStyle}"/>
            </Border>
            <TextBlock Grid.Column="1" 
                       Text="{Binding Model.CurrentItem.Technologist}" 
                       Style="{StaticResource AttributeValueStyle}"/>
        </Grid>

        <Separator>
            <Separator.Style>
                <Style TargetType="Separator" BasedOn="{StaticResource AttributeSeparatorStyle}">
                    <Setter Property="Visibility" Value="Visible"/>
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding Model.CurrentGroup.IsByMemo}" Value="True">
                            <Setter Property="Visibility" Value="Collapsed"/>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </Separator.Style>
        </Separator>

        <!-- Общие поля (всегда видны) -->

        <!-- Заказ -->
        <Grid Style="{StaticResource AttributeRowStyle}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
            </Grid.ColumnDefinitions>
            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                <TextBlock Text="Заказ:" Style="{StaticResource AttributeLabelTextStyle}"/>
            </Border>
            <TextBox Grid.Column="1" 
                     Text="{Binding Model.CurrentItem.OrderByMemo, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                     Style="{StaticResource AttributeTextBoxStyle}"/>
        </Grid>

        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

        <!-- Номер -->
        <Grid Style="{StaticResource AttributeRowStyle}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
            </Grid.ColumnDefinitions>
            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                <TextBlock Text="Номер:" Style="{StaticResource AttributeLabelTextStyle}"/>
            </Border>
            <TextBox Grid.Column="1" 
                     Text="{Binding Model.CurrentItem.NumberByMemo, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                     Style="{StaticResource AttributeTextBoxStyle}"/>
        </Grid>

        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

        <!-- Наименование заказа -->
        <Grid Style="{StaticResource AttributeRowStyle}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
            </Grid.ColumnDefinitions>
            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                <TextBlock Text="Наименование:" Style="{StaticResource AttributeLabelTextStyle}"/>
            </Border>
            <TextBox Grid.Column="1" 
                     Text="{Binding Model.CurrentItem.OrderName, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                     Style="{StaticResource AttributeTextBoxStyle}"/>
        </Grid>

        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

        <!-- Дата открытия -->
        <Grid Style="{StaticResource AttributeRowStyle}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
            </Grid.ColumnDefinitions>
            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                <TextBlock Text="Дата открытия:" Style="{StaticResource AttributeLabelTextStyle}"/>
            </Border>
            <TextBox Grid.Column="1" 
                     Text="{Binding Model.CurrentItem.OpenAtByMemo, Mode=TwoWay, UpdateSourceTrigger=LostFocus,
                            Converter={StaticResource MaskedDateConverter},
                            StringFormat='{}{0:dd.MM.yyyy}'}"
                     Style="{StaticResource AttributeTextBoxStyle}"/>
        </Grid>

        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

        <!-- Тип оснастки -->
        <Grid Style="{StaticResource AttributeRowStyle}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
            </Grid.ColumnDefinitions>
            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                <TextBlock Text="Тип оснастки:" Style="{StaticResource AttributeLabelTextStyle}"/>
            </Border>
            <!-- Исправленная привязка - напрямую к свойству ViewModel -->
            <ComboBox Grid.Column="1"
                      ItemsSource="{Binding EquipmentTypes}"
                      SelectedItem="{Binding Model.CurrentItem.EquipmentType, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                      Style="{StaticResource AttributeComboBoxStyle}">
                <ComboBox.ItemTemplate>
                    <DataTemplate>
                        <TextBlock Text="{Binding TypeName}"/>
                    </DataTemplate>
                </ComboBox.ItemTemplate>
            </ComboBox>
        </Grid>

        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

        <!-- Балансовый счет -->
        <Grid Style="{StaticResource AttributeRowStyle}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
            </Grid.ColumnDefinitions>
            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                <TextBlock Text="Балансовый счет:" Style="{StaticResource AttributeLabelTextStyle}"/>
            </Border>
            <TextBox Grid.Column="1" 
                     Text="{Binding Model.CurrentItem.Balance, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                     Style="{StaticResource AttributeTextBoxStyle}"/>
        </Grid>

        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

        <!-- Номенклатурная группа -->
        <Grid Style="{StaticResource AttributeRowStyle}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
            </Grid.ColumnDefinitions>
            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                <TextBlock Text="Номенклатурная группа:" Style="{StaticResource AttributeLabelTextStyle}"/>
            </Border>
            <ComboBox Grid.Column="1"
                      ItemsSource="{Binding NomenclatureGroups}"
                      SelectedItem="{Binding Model.CurrentItem.NomenclatureGroup, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                      Style="{StaticResource AttributeComboBoxStyle}">
            </ComboBox>
        </Grid>

        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

        <!-- Чертеж по служебной -->
        <Grid Style="{StaticResource AttributeRowStyle}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
            </Grid.ColumnDefinitions>
            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                <TextBlock Text="Чертеж:" Style="{StaticResource AttributeLabelTextStyle}"/>
            </Border>
            <TextBox Grid.Column="1" 
                     Text="{Binding Model.CurrentItem.DraftByMemo, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                     Style="{StaticResource AttributeTextBoxStyle}"/>
        </Grid>

        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

        <!-- Наименование чертежа по служебной -->
        <Grid Style="{StaticResource AttributeRowStyle}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
            </Grid.ColumnDefinitions>
            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                <TextBlock Text="Чертежное обозначение:" Style="{StaticResource AttributeLabelTextStyle}"/>
            </Border>
            <TextBox Grid.Column="1" 
                     Text="{Binding Model.CurrentItem.DraftNameByMemo, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                     Style="{StaticResource AttributeTextBoxStyle}"/>
        </Grid>

        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

        <!-- Склад по служебной -->
        <Grid Style="{StaticResource AttributeRowStyle}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
            </Grid.ColumnDefinitions>
            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                <TextBlock Text="Склад:" Style="{StaticResource AttributeLabelTextStyle}"/>
            </Border>
            <TextBox Grid.Column="1" 
                     Text="{Binding Model.CurrentItem.WorkshopByMemo, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                     Style="{StaticResource AttributeTextBoxStyle}"/>
        </Grid>

        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

        <!-- Количество по служебной -->
        <Grid Style="{StaticResource AttributeRowStyle}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
            </Grid.ColumnDefinitions>
            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                <TextBlock Text="Количество:" Style="{StaticResource AttributeLabelTextStyle}"/>
            </Border>
            <TextBox Grid.Column="1" 
                     Text="{Binding Model.CurrentItem.EquipmentRequiredQuantityByMemo, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                     Style="{StaticResource AttributeTextBoxStyle}"/>
        </Grid>
    </StackPanel>
</UserControl>

using System.Windows;
using System.Windows.Controls;
using OrderApprovalSystem.ViewModels;

namespace OrderApprovalSystem.Views.RoleSpecificPanels
{
    public partial class OrderManagerCentralPanel : UserControl
    {
        public static readonly DependencyProperty ViewModelProperty =
            DependencyProperty.Register(
                "ViewModel",
                typeof(vmOrderManager),
                typeof(OrderManagerCentralPanel),
                new PropertyMetadata(null));

        public vmOrderManager ViewModel
        {
            get => (vmOrderManager)GetValue(ViewModelProperty);
            set => SetValue(ViewModelProperty, value);
        }

        public OrderManagerCentralPanel()
        {
            InitializeComponent();
        }
    }
}

<UserControl x:Class="OrderApprovalSystem.Views.RoleSpecificPanels.TechnologistCentralPanel"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:local="clr-namespace:OrderApprovalSystem.ViewModels"
             DataContext="{Binding RelativeSource={RelativeSource Self}, Path=ViewModel}">

    <UserControl.Resources>
        <!-- Стили наследуются из родительского окна -->
    </UserControl.Resources>

    <StackPanel>
        <!-- Технолог -->
        <Grid Style="{StaticResource AttributeRowStyle}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
            </Grid.ColumnDefinitions>
            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                <TextBlock Text="Технолог:" Style="{StaticResource AttributeLabelTextStyle}"/>
            </Border>
            <TextBlock Grid.Column="1" 
                       Text="{Binding Model.CurrentItem.Technologist}" 
                       Style="{StaticResource AttributeValueStyle}"/>
        </Grid>

        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

        <!-- Изделие -->
        <Grid Style="{StaticResource AttributeRowStyle}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
            </Grid.ColumnDefinitions>
            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                <TextBlock Text="Изделие:" Style="{StaticResource AttributeLabelTextStyle}"/>
            </Border>
            <TextBlock Grid.Column="1" 
                       Text="{Binding Model.CurrentItem.CoreDraft}" 
                       Style="{StaticResource AttributeValueStyle}"/>
        </Grid>

        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

        <!-- Наименование изделия -->
        <Grid Style="{StaticResource AttributeRowStyle}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
            </Grid.ColumnDefinitions>
            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                <TextBlock Text="Наименование изделия:" Style="{StaticResource AttributeLabelTextStyle}"/>
            </Border>
            <TextBlock Grid.Column="1" 
                       Text="{Binding Model.CurrentItem.CoreDraftName}" 
                       Style="{StaticResource AttributeValueStyle}"/>
        </Grid>

        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

        <!-- Деталь -->
        <Grid Style="{StaticResource AttributeRowStyle}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
            </Grid.ColumnDefinitions>
            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                <TextBlock Text="Деталь:" Style="{StaticResource AttributeLabelTextStyle}"/>
            </Border>
            <TextBlock Grid.Column="1" 
                       Text="{Binding Model.CurrentItem.Draft}" 
                       Style="{StaticResource AttributeValueStyle}"/>
        </Grid>

        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

        <!-- Наименование детали -->
        <Grid Style="{StaticResource AttributeRowStyle}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
            </Grid.ColumnDefinitions>
            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                <TextBlock Text="Наименование детали:" Style="{StaticResource AttributeLabelTextStyle}"/>
            </Border>
            <TextBlock Grid.Column="1" 
                       Text="{Binding Model.CurrentItem.DraftName}" 
                       Style="{StaticResource AttributeValueStyle}"/>
        </Grid>

        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

        <!-- Цех получатель -->
        <Grid Style="{StaticResource AttributeRowStyle}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
            </Grid.ColumnDefinitions>
            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                <TextBlock Text="Цех получ.:" Style="{StaticResource AttributeLabelTextStyle}"/>
            </Border>
            <TextBlock Grid.Column="1" 
                       Text="{Binding Model.CurrentItem.Workshop}" 
                       Style="{StaticResource AttributeValueStyle}"/>
        </Grid>

        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

        <!-- Кладовая -->
        <Grid Style="{StaticResource AttributeRowStyle}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
            </Grid.ColumnDefinitions>
            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                <TextBlock Text="Кладовая:" Style="{StaticResource AttributeLabelTextStyle}"/>
            </Border>
            <TextBlock Grid.Column="1" 
                       Text="{Binding Model.CurrentItem.Warehouse}" 
                       Style="{StaticResource AttributeValueStyle}"/>
        </Grid>

        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

        <!-- Рабочее место -->
        <Grid Style="{StaticResource AttributeRowStyle}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
            </Grid.ColumnDefinitions>
            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                <TextBlock Text="Раб. место:" Style="{StaticResource AttributeLabelTextStyle}"/>
            </Border>
            <TextBlock Grid.Column="1" 
                       Text="{Binding Model.CurrentItem.Workplace}" 
                       Style="{StaticResource AttributeValueStyle}"/>
        </Grid>

        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

        <!-- Операция -->
        <Grid Style="{StaticResource AttributeRowStyle}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
            </Grid.ColumnDefinitions>
            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                <TextBlock Text="Операция:" Style="{StaticResource AttributeLabelTextStyle}"/>
            </Border>
            <TextBlock Grid.Column="1" 
                       Text="{Binding Model.CurrentItem.Operation}" 
                       Style="{StaticResource AttributeValueStyle}"/>
        </Grid>

        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

        <!-- Наименование оснастки -->
        <Grid Style="{StaticResource AttributeRowStyle}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
            </Grid.ColumnDefinitions>
            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                <TextBlock Text="Наименование оснастки:" Style="{StaticResource AttributeLabelTextStyle}"/>
            </Border>
            <TextBlock Grid.Column="1" 
                       Text="{Binding Model.CurrentItem.EquipmentName}" 
                       Style="{StaticResource AttributeValueStyle}"/>
        </Grid>

        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

        <!-- Аналог -->
        <Grid Style="{StaticResource AttributeRowStyle}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
            </Grid.ColumnDefinitions>
            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                <TextBlock Text="Аналог:" Style="{StaticResource AttributeLabelTextStyle}"/>
            </Border>
            <TextBlock Grid.Column="1" 
                       Text="{Binding Model.CurrentItem.Analog}" 
                       Style="{StaticResource AttributeValueStyle}"/>
        </Grid>

        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

        <!-- Количество оснастки на операцию -->
        <Grid Style="{StaticResource AttributeRowStyle}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
            </Grid.ColumnDefinitions>
            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                <TextBlock Text="Кол-во оснастки на операцию:" Style="{StaticResource AttributeLabelTextStyle}"/>
            </Border>
            <TextBlock Grid.Column="1" 
                       Text="{Binding Model.CurrentItem.EquipmentQuantityForOperation}" 
                       Style="{StaticResource AttributeValueStyle}"/>
        </Grid>
    </StackPanel>
</UserControl>

using System.Windows;
using System.Windows.Controls;
using OrderApprovalSystem.ViewModels;

namespace OrderApprovalSystem.Views.RoleSpecificPanels
{
    public partial class TechnologistCentralPanel : UserControl
    {
        public static readonly DependencyProperty ViewModelProperty =
            DependencyProperty.Register(
                "ViewModel",
                typeof(vmSubTechnologist),
                typeof(TechnologistCentralPanel),
                new PropertyMetadata(null));

        public vmSubTechnologist ViewModel
        {
            get => (vmSubTechnologist)GetValue(ViewModelProperty);
            set => SetValue(ViewModelProperty, value);
        }

        public TechnologistCentralPanel()
        {
            InitializeComponent();
        }
    }
}

<UserControl x:Class="OrderApprovalSystem.Views.BaseApprovalView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
             xmlns:behaviors="clr-namespace:OrderApprovalSystem.Behaviors"
             Background="{DynamicResource PrimaryBackgroundBrush}"
             Foreground="{DynamicResource TextBrush}">

    <i:Interaction.Triggers>
        <i:EventTrigger EventName="Loaded">
            <i:CallMethodAction TargetObject="{Binding}" MethodName="viewLoaded"/>
        </i:EventTrigger>
    </i:Interaction.Triggers>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="{Binding LeftColumnWidth}"/>
            <ColumnDefinition Width="{Binding CenterColumnWidth}"/>
            <ColumnDefinition Width="{Binding RightColumnWidth}"/>
        </Grid.ColumnDefinitions>

        <!-- Левая панель - Список заказов -->
        <Border Grid.Column="0" 
                Margin="5" 
                BorderThickness="2" 
                BorderBrush="{DynamicResource AccentBrush}" 
                Background="{DynamicResource SecondaryBackgroundBrush}"
                CornerRadius="4">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Заголовок таблицы -->
                <Border Grid.Row="0"
                        Background="{DynamicResource AccentBrush}"
                        CornerRadius="2,2,0,0"
                        Padding="10">
                    <TextBlock Text="{Binding OrdersTitle}"
                               Foreground="White"
                               FontSize="14"
                               FontWeight="Bold"
                               HorizontalAlignment="Center"/>
                </Border>

                <!-- DataGrid с группами заказов -->
                <DataGrid Grid.Row="1"
                          IsReadOnly="True"
                          AutoGenerateColumns="False"
                          SelectionMode="Single"
                          HeadersVisibility="Column"
                          HorizontalScrollBarVisibility="Disabled"
                          CanUserAddRows="False"
                          x:Name="dgReport" 
                          ItemsSource="{Binding model.GroupedData}" 
                          SelectedItem="{Binding model.CurrentGroup, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">

                    <i:Interaction.Behaviors>
                        <behaviors:ScrollIntoViewBehavior SelectedItem="{Binding model.CurrentGroup, Mode=OneWay}"/>
                    </i:Interaction.Behaviors>

                    <DataGrid.Columns>
                        <!-- Базовые колонки -->
                        <DataGridTextColumn Header="Тех. заказ" 
                                            Binding="{Binding Zak1}" 
                                            Width="80"/>
                        <!-- Динамические колонки добавляются через ViewModel -->
                    </DataGrid.Columns>
                </DataGrid>
            </Grid>
        </Border>

        <!-- Центральная панель - Детали заказа -->
        <Border Grid.Column="1" 
                Margin="0,5,0,5" 
                BorderThickness="2" 
                BorderBrush="{DynamicResource GreenAccentBrush}" 
                Background="{DynamicResource SecondaryBackgroundBrush}"
                CornerRadius="4"
                Padding="5">
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <Grid IsSharedSizeScope="True">
                    <StackPanel>
                        <TextBlock Text="{Binding OrderDetailsTitle}"
                                   FontSize="16"
                                   FontWeight="Bold"
                                   HorizontalAlignment="Center"
                                   Foreground="{DynamicResource TextBrush}"
                                   Margin="0"/>

                        <!-- Статические атрибуты (общие для всех) -->
                        <Grid Style="{StaticResource AttributeRowStyle}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>
                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Изделие:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>
                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.CoreDraft}" 
                                       Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

                        <Grid Style="{StaticResource AttributeRowStyle}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>
                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Наименование изделия:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>
                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.CoreDraftName}" 
                                       Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <!-- Динамический контент для ролей -->
                        <ContentControl Content="{Binding RoleSpecificCentralContent}"/>
                    </StackPanel>
                </Grid>
            </ScrollViewer>
        </Border>

        <!-- Правая панель - Подзаказы -->
        <Border Grid.Column="2" 
                Margin="5,5,5,5" 
                BorderThickness="2" 
                BorderBrush="{DynamicResource GreenAccentBrush}" 
                Background="{DynamicResource SecondaryBackgroundBrush}"
                CornerRadius="4"
                Padding="5">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <TextBlock Grid.Row="0"
                           Text="{Binding model.CurrentGroup.Zak1, StringFormat='Тех. заказ: {0}'}"
                           FontSize="16"
                           FontWeight="Bold"
                           HorizontalAlignment="Center"
                           Foreground="{DynamicResource TextBrush}"
                           Margin="0,0,0,10"/>

                <!-- DataGrid подзаказов -->
                <DataGrid Grid.Row="1"
                          ItemsSource="{Binding model.CurrentGroup.Items}"
                          SelectedItem="{Binding model.CurrentItem, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                          AutoGenerateColumns="False"
                          IsReadOnly="{Binding IsSubOrdersReadOnly}"
                          CanUserAddRows="False"
                          HeadersVisibility="Column"
                          SelectionMode="Single"
                          Margin="0,0,0,5">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Чертеж" Binding="{Binding EquipmentDraft}" Width="Auto"/>
                        <DataGridTextColumn Header="Наименование" Binding="{Binding EquipmentNameFromTechologist}" 
                                           Width="Auto" CellStyle="{DynamicResource LeftAlignedDataGridCell}"/>
                        <!-- Динамические колонки добавляются через ViewModel -->
                    </DataGrid.Columns>
                </DataGrid>

                <!-- Детальная информация -->
                <Border Grid.Row="2"
                        BorderThickness="2" 
                        BorderBrush="Red" 
                        Background="{DynamicResource SecondaryBackgroundBrush}"
                        CornerRadius="4"
                        Padding="5">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <Grid IsSharedSizeScope="True">
                            <StackPanel>
                                <TextBlock Text="Данные чертежа"
                                           FontSize="16"
                                           FontWeight="Bold"
                                           HorizontalAlignment="Center"
                                           Foreground="{DynamicResource TextBrush}"
                                           Margin="0"/>

                                <Grid Style="{StaticResource AttributeRowStyle}">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                        <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                                    </Grid.ColumnDefinitions>
                                    <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                        <TextBlock Text="Доп. сведения для проектирования:" Style="{StaticResource AttributeLabelTextStyle}"/>
                                    </Border>
                                    <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.DesignComment}" 
                                               TextWrapping="Wrap" Style="{StaticResource AttributeValueStyle}"/>
                                </Grid>

                                <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

                                <Grid Style="{StaticResource AttributeRowStyle}">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                        <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                                    </Grid.ColumnDefinitions>
                                    <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                        <TextBlock Text="Доп. сведения для производства:" Style="{StaticResource AttributeLabelTextStyle}"/>
                                    </Border>
                                    <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.ManufacturingComment}" 
                                               TextWrapping="Wrap" Style="{StaticResource AttributeValueStyle}"/>
                                </Grid>
                            </StackPanel>
                        </Grid>
                    </ScrollViewer>
                </Border>
            </Grid>
        </Border>
    </Grid>
</UserControl>

<local:BaseCustomWindow x:Class="OrderApprovalSystem.Views.Main"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:ribbon="clr-namespace:System.Windows.Controls.Ribbon;assembly=System.Windows.Controls.Ribbon"
        xmlns:local="clr-namespace:OrderApprovalSystem.Views"
        xmlns:vm="clr-namespace:OrderApprovalSystem.ViewModels"
        xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
        xmlns:converters="clr-namespace:OrderApprovalSystem.Converters"
        Title="OrderApprovalSystem" 
        Height="700" Width="1500"
        Background="{DynamicResource PrimaryBackgroundBrush}"
        Foreground="{DynamicResource TextBrush}">

    <Window.Resources>
        <converters:IsByMemoToTextConverter x:Key="IsByMemoToTextConverter"/>
        <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <converters:MaskedDateConverter x:Key="MaskedDateConverter"/>

        <!-- Шаблоны данных для ViewModel -->
        <DataTemplate DataType="{x:Type vm:vmDev}">
            <local:Dev />
        </DataTemplate>

        <DataTemplate DataType="{x:Type vm:vmSubTechnologist}">
            <local:SubTechnologist />
        </DataTemplate>
        <DataTemplate DataType="{x:Type vm:vmOrderManager}">
            <local:OrderManager />
        </DataTemplate>
        <DataTemplate DataType="{x:Type vm:vmHeadOrderDepartment}">
            <local:HeadOrderDepartment />
        </DataTemplate>
        
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Общий Ribbon для всех режимов -->
        <ribbon:Ribbon x:Name="MainRibbon" Style="{StaticResource ModernRibbonStyle}" Grid.Row="1">

            <i:Interaction.Behaviors>
                <local:RibbonTabBehavior CurrentViewModel="{Binding CurrentViewModel}"/>
            </i:Interaction.Behaviors>

            <!-- Скрываем/показываем ApplicationMenu в зависимости от роли -->
            <ribbon:Ribbon.ApplicationMenu>
                <ribbon:RibbonApplicationMenu 
                    SmallImageSource="https://cdn-icons-png.flaticon.com/512/2311/2311523.png"
                    Visibility="{Binding IsBurgerMenuVisible, Converter={StaticResource BooleanToVisibilityConverter}}">

                    <ribbon:RibbonApplicationMenuItem Header="Режим разработчика" 
                                           Command="{Binding pSwitchToDevCommand}"
                                           Visibility="{Binding IsDevMenuVisible, Converter={StaticResource BooleanToVisibilityConverter}}"/>

                    <ribbon:RibbonApplicationMenuItem Header="Режим технолога" 
                                           Command="{Binding pSwitchToSubTechnologistCommand}"
                                           Visibility="{Binding IsSubTechnologistMenuVisible, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                    <ribbon:RibbonApplicationMenuItem Header="Режим менеджера заказов" 
                       Command="{Binding pSwitchToOrderManagerCommand}"
                       Visibility="{Binding IsOrderManagerMenuVisible, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                </ribbon:RibbonApplicationMenu>
            </ribbon:Ribbon.ApplicationMenu>

            <!-- Статические вкладки -->
            <ribbon:RibbonTab Header="ВИД">
                <ribbon:RibbonGroup Header="Оформление">
                    <ribbon:RibbonToggleButton Label="Темная тема"
                                                IsChecked="{Binding IsDarkTheme}"/>
                </ribbon:RibbonGroup>
            </ribbon:RibbonTab>

        </ribbon:Ribbon>

        <!-- Основной контент -->
        <ContentControl Grid.Row="2" Content="{Binding CurrentViewModel, Mode=OneWay}"/>

    </Grid>
</local:BaseCustomWindow>

в OrderManager не отображаются данные, при тои что они загрузились