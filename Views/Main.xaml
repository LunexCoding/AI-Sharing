<UserControl x:Class="OrderApprovalSystem.Views.BaseApprovalView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
             xmlns:behaviors="clr-namespace:OrderApprovalSystem.Behaviors"
             Background="{DynamicResource PrimaryBackgroundBrush}"
             Foreground="{DynamicResource TextBrush}">

    <i:Interaction.Triggers>
        <i:EventTrigger EventName="Loaded">
            <i:CallMethodAction TargetObject="{Binding}" MethodName="viewLoaded"/>
        </i:EventTrigger>
    </i:Interaction.Triggers>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="{Binding LeftColumnWidth}"/>
            <ColumnDefinition Width="{Binding CenterColumnWidth}"/>
            <ColumnDefinition Width="{Binding RightColumnWidth}"/>
        </Grid.ColumnDefinitions>

        <!-- Левая панель - Список заказов -->
        <Border Grid.Column="0" 
                Margin="5" 
                BorderThickness="2" 
                BorderBrush="{DynamicResource AccentBrush}" 
                Background="{DynamicResource SecondaryBackgroundBrush}"
                CornerRadius="4">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Заголовок таблицы -->
                <Border Grid.Row="0"
                        Background="{DynamicResource AccentBrush}"
                        CornerRadius="2,2,0,0"
                        Padding="10">
                    <TextBlock Text="{Binding OrdersTitle}"
                               Foreground="White"
                               FontSize="14"
                               FontWeight="Bold"
                               HorizontalAlignment="Center"/>
                </Border>

                <!-- DataGrid с группами заказов -->
                <DataGrid Grid.Row="1"
                          IsReadOnly="True"
                          AutoGenerateColumns="False"
                          SelectionMode="Single"
                          HeadersVisibility="Column"
                          HorizontalScrollBarVisibility="Disabled"
                          CanUserAddRows="False"
                          x:Name="dgReport" 
                          ItemsSource="{Binding model.GroupedData}" 
                          SelectedItem="{Binding model.CurrentGroup, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">

                    <i:Interaction.Behaviors>
                        <behaviors:ScrollIntoViewBehavior SelectedItem="{Binding model.CurrentGroup, Mode=OneWay}"/>
                    </i:Interaction.Behaviors>

                    <DataGrid.Columns>
                        <!-- Базовые колонки -->
                        <DataGridTextColumn Header="Тех. заказ" 
                                            Binding="{Binding Zak1}" 
                                            Width="80"/>
                        <!-- Динамические колонки добавляются через ViewModel -->
                    </DataGrid.Columns>
                </DataGrid>
            </Grid>
        </Border>

        <!-- Центральная панель - Детали заказа -->
        <Border Grid.Column="1" 
                Margin="0,5,0,5" 
                BorderThickness="2" 
                BorderBrush="{DynamicResource GreenAccentBrush}" 
                Background="{DynamicResource SecondaryBackgroundBrush}"
                CornerRadius="4"
                Padding="5">
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <Grid IsSharedSizeScope="True">
                    <StackPanel>
                        <TextBlock Text="{Binding OrderDetailsTitle}"
                                   FontSize="16"
                                   FontWeight="Bold"
                                   HorizontalAlignment="Center"
                                   Foreground="{DynamicResource TextBrush}"
                                   Margin="0"/>

                        <!-- Статические атрибуты (общие для всех) -->
                        <Grid Style="{StaticResource AttributeRowStyle}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>
                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Изделие:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>
                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.CoreDraft}" 
                                       Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

                        <Grid Style="{StaticResource AttributeRowStyle}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                            </Grid.ColumnDefinitions>
                            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                <TextBlock Text="Наименование изделия:" Style="{StaticResource AttributeLabelTextStyle}"/>
                            </Border>
                            <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.CoreDraftName}" 
                                       Style="{StaticResource AttributeValueStyle}"/>
                        </Grid>

                        <!-- Динамический контент для ролей -->
                        <ContentControl Content="{Binding RoleSpecificCentralContent}"/>
                    </StackPanel>
                </Grid>
            </ScrollViewer>
        </Border>

        <!-- Правая панель - Подзаказы -->
        <Border Grid.Column="2" 
                Margin="5,5,5,5" 
                BorderThickness="2" 
                BorderBrush="{DynamicResource GreenAccentBrush}" 
                Background="{DynamicResource SecondaryBackgroundBrush}"
                CornerRadius="4"
                Padding="5">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <TextBlock Grid.Row="0"
                           Text="{Binding model.CurrentGroup.Zak1, StringFormat='Тех. заказ: {0}'}"
                           FontSize="16"
                           FontWeight="Bold"
                           HorizontalAlignment="Center"
                           Foreground="{DynamicResource TextBrush}"
                           Margin="0,0,0,10"/>

                <!-- DataGrid подзаказов -->
                <DataGrid Grid.Row="1"
                          ItemsSource="{Binding model.CurrentGroup.Items}"
                          SelectedItem="{Binding model.CurrentItem, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                          AutoGenerateColumns="False"
                          IsReadOnly="{Binding IsSubOrdersReadOnly}"
                          CanUserAddRows="False"
                          HeadersVisibility="Column"
                          SelectionMode="Single"
                          Margin="0,0,0,5">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Чертеж" Binding="{Binding EquipmentDraft}" Width="Auto"/>
                        <DataGridTextColumn Header="Наименование" Binding="{Binding EquipmentNameFromTechologist}" 
                                           Width="Auto" CellStyle="{DynamicResource LeftAlignedDataGridCell}"/>
                        <!-- Динамические колонки добавляются через ViewModel -->
                    </DataGrid.Columns>
                </DataGrid>

                <!-- Детальная информация -->
                <Border Grid.Row="2"
                        BorderThickness="2" 
                        BorderBrush="Red" 
                        Background="{DynamicResource SecondaryBackgroundBrush}"
                        CornerRadius="4"
                        Padding="5">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <Grid IsSharedSizeScope="True">
                            <StackPanel>
                                <TextBlock Text="Данные чертежа"
                                           FontSize="16"
                                           FontWeight="Bold"
                                           HorizontalAlignment="Center"
                                           Foreground="{DynamicResource TextBrush}"
                                           Margin="0"/>

                                <Grid Style="{StaticResource AttributeRowStyle}">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                        <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                                    </Grid.ColumnDefinitions>
                                    <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                        <TextBlock Text="Доп. сведения для проектирования:" Style="{StaticResource AttributeLabelTextStyle}"/>
                                    </Border>
                                    <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.DesignComment}" 
                                               TextWrapping="Wrap" Style="{StaticResource AttributeValueStyle}"/>
                                </Grid>

                                <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

                                <Grid Style="{StaticResource AttributeRowStyle}">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                                        <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
                                    </Grid.ColumnDefinitions>
                                    <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                                        <TextBlock Text="Доп. сведения для производства:" Style="{StaticResource AttributeLabelTextStyle}"/>
                                    </Border>
                                    <TextBlock Grid.Column="1" Text="{Binding model.CurrentItem.ManufacturingComment}" 
                                               TextWrapping="Wrap" Style="{StaticResource AttributeValueStyle}"/>
                                </Grid>
                            </StackPanel>
                        </Grid>
                    </ScrollViewer>
                </Border>
            </Grid>
        </Border>
    </Grid>
</UserControl>

<local:BaseCustomWindow x:Class="OrderApprovalSystem.Views.Main"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:ribbon="clr-namespace:System.Windows.Controls.Ribbon;assembly=System.Windows.Controls.Ribbon"
        xmlns:local="clr-namespace:OrderApprovalSystem.Views"
        xmlns:vm="clr-namespace:OrderApprovalSystem.ViewModels"
        xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
        xmlns:converters="clr-namespace:OrderApprovalSystem.Converters"
        Title="OrderApprovalSystem" 
        Height="700" Width="1500"
        Background="{DynamicResource PrimaryBackgroundBrush}"
        Foreground="{DynamicResource TextBrush}">

    <Window.Resources>
        <converters:IsByMemoToTextConverter x:Key="IsByMemoToTextConverter"/>
        <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <converters:MaskedDateConverter x:Key="MaskedDateConverter"/>

        <!-- Шаблоны данных для ViewModel -->
        <DataTemplate DataType="{x:Type vm:vmDev}">
            <local:Dev />
        </DataTemplate>

        <DataTemplate DataType="{x:Type vm:vmSubTechnologist}">
            <local:SubTechnologist />
        </DataTemplate>
        <DataTemplate DataType="{x:Type vm:vmOrderManager}">
            <local:OrderManager />
        </DataTemplate>
        <DataTemplate DataType="{x:Type vm:vmHeadOrderDepartment}">
            <local:HeadOrderDepartment />
        </DataTemplate>
        
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Общий Ribbon для всех режимов -->
        <ribbon:Ribbon x:Name="MainRibbon" Style="{StaticResource ModernRibbonStyle}" Grid.Row="1">

            <i:Interaction.Behaviors>
                <local:RibbonTabBehavior CurrentViewModel="{Binding CurrentViewModel}"/>
            </i:Interaction.Behaviors>

            <!-- Скрываем/показываем ApplicationMenu в зависимости от роли -->
            <ribbon:Ribbon.ApplicationMenu>
                <ribbon:RibbonApplicationMenu 
                    SmallImageSource="https://cdn-icons-png.flaticon.com/512/2311/2311523.png"
                    Visibility="{Binding IsBurgerMenuVisible, Converter={StaticResource BooleanToVisibilityConverter}}">

                    <ribbon:RibbonApplicationMenuItem Header="Режим разработчика" 
                                           Command="{Binding pSwitchToDevCommand}"
                                           Visibility="{Binding IsDevMenuVisible, Converter={StaticResource BooleanToVisibilityConverter}}"/>

                    <ribbon:RibbonApplicationMenuItem Header="Режим технолога" 
                                           Command="{Binding pSwitchToSubTechnologistCommand}"
                                           Visibility="{Binding IsSubTechnologistMenuVisible, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                    <ribbon:RibbonApplicationMenuItem Header="Режим менеджера заказов" 
                       Command="{Binding pSwitchToOrderManagerCommand}"
                       Visibility="{Binding IsOrderManagerMenuVisible, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                </ribbon:RibbonApplicationMenu>
            </ribbon:Ribbon.ApplicationMenu>

            <!-- Статические вкладки -->
            <ribbon:RibbonTab Header="ВИД">
                <ribbon:RibbonGroup Header="Оформление">
                    <ribbon:RibbonToggleButton Label="Темная тема"
                                                IsChecked="{Binding IsDarkTheme}"/>
                </ribbon:RibbonGroup>
            </ribbon:RibbonTab>

        </ribbon:Ribbon>

        <!-- Основной контент -->
        <ContentControl Grid.Row="2" Content="{Binding CurrentViewModel, Mode=OneWay}"/>

    </Grid>
</local:BaseCustomWindow>

