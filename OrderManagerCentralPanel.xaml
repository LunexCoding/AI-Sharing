<UserControl x:Class="OrderApprovalSystem.Views.RoleSpecificPanels.OrderManagerCentralPanel"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:local="clr-namespace:OrderApprovalSystem.ViewModels"
             xmlns:converters="clr-namespace:OrderApprovalSystem.Converters"
             DataContext="{Binding RelativeSource={RelativeSource Self}, Path=ViewModel}">

    <UserControl.Resources>
        <converters:MaskedDateConverter x:Key="MaskedDateConverter"/>

        <!-- Стили для условного отображения -->
        <Style x:Key="MemoConditionalRowStyle" TargetType="Grid" BasedOn="{StaticResource AttributeRowStyle}">
            <Setter Property="Visibility" Value="Visible"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding Model.CurrentGroup.IsByMemo}" Value="False">
                    <Setter Property="Visibility" Value="Collapsed"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="TechnologistConditionalRowStyle" TargetType="Grid" BasedOn="{StaticResource AttributeRowStyle}">
            <Setter Property="Visibility" Value="Visible"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding Model.CurrentGroup.IsByMemo}" Value="True">
                    <Setter Property="Visibility" Value="Collapsed"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>
    </UserControl.Resources>

    <StackPanel>
        <!-- Заголовок раздела СЗ -->
        <TextBlock Text="Данные служебной записки"
                   FontSize="14"
                   FontWeight="Bold"
                   HorizontalAlignment="Center"
                   Foreground="{DynamicResource TextBrush}"
                   Margin="0,10,0,5">
            <TextBlock.Style>
                <Style TargetType="TextBlock">
                    <Setter Property="Visibility" Value="Collapsed"/>
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding Model.CurrentGroup.IsByMemo}" Value="True">
                            <Setter Property="Visibility" Value="Visible"/>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </TextBlock.Style>
        </TextBlock>

        <!-- Номер служебной записки -->
        <Grid Style="{StaticResource MemoConditionalRowStyle}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
            </Grid.ColumnDefinitions>
            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                <TextBlock Text="Номер СЗ:" Style="{StaticResource AttributeLabelTextStyle}"/>
            </Border>
            <TextBox Grid.Column="1" 
                     Text="{Binding Model.CurrentItem.MemoNumber, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                     Style="{StaticResource AttributeTextBoxStyle}"/>
        </Grid>

        <Separator>
            <Separator.Style>
                <Style TargetType="Separator" BasedOn="{StaticResource AttributeSeparatorStyle}">
                    <Setter Property="Visibility" Value="Visible"/>
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding Model.CurrentGroup.IsByMemo}" Value="False">
                            <Setter Property="Visibility" Value="Collapsed"/>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </Separator.Style>
        </Separator>

        <!-- Автор служебной записки -->
        <Grid Style="{StaticResource MemoConditionalRowStyle}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
            </Grid.ColumnDefinitions>
            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                <TextBlock Text="Автор СЗ:" Style="{StaticResource AttributeLabelTextStyle}"/>
            </Border>
            <TextBox Grid.Column="1" 
                     Text="{Binding Model.CurrentItem.MemoAuthor, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                     Style="{StaticResource AttributeTextBoxStyle}"/>
        </Grid>

        <Separator>
            <Separator.Style>
                <Style TargetType="Separator" BasedOn="{StaticResource AttributeSeparatorStyle}">
                    <Setter Property="Visibility" Value="Visible"/>
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding Model.CurrentGroup.IsByMemo}" Value="False">
                            <Setter Property="Visibility" Value="Collapsed"/>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </Separator.Style>
        </Separator>

        <!-- Технолог (только для тех. заказов) -->
        <Grid Style="{StaticResource TechnologistConditionalRowStyle}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
            </Grid.ColumnDefinitions>
            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                <TextBlock Text="Технолог:" Style="{StaticResource AttributeLabelTextStyle}"/>
            </Border>
            <TextBlock Grid.Column="1" 
                       Text="{Binding Model.CurrentItem.Technologist}" 
                       Style="{StaticResource AttributeValueStyle}"/>
        </Grid>

        <Separator>
            <Separator.Style>
                <Style TargetType="Separator" BasedOn="{StaticResource AttributeSeparatorStyle}">
                    <Setter Property="Visibility" Value="Visible"/>
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding Model.CurrentGroup.IsByMemo}" Value="True">
                            <Setter Property="Visibility" Value="Collapsed"/>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </Separator.Style>
        </Separator>

        <!-- Общие поля (всегда видны) -->

        <!-- Заказ -->
        <Grid Style="{StaticResource AttributeRowStyle}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
            </Grid.ColumnDefinitions>
            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                <TextBlock Text="Заказ:" Style="{StaticResource AttributeLabelTextStyle}"/>
            </Border>
            <TextBox Grid.Column="1" 
                     Text="{Binding Model.CurrentItem.OrderByMemo, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                     Style="{StaticResource AttributeTextBoxStyle}"/>
        </Grid>

        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

        <!-- Номер -->
        <Grid Style="{StaticResource AttributeRowStyle}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
            </Grid.ColumnDefinitions>
            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                <TextBlock Text="Номер:" Style="{StaticResource AttributeLabelTextStyle}"/>
            </Border>
            <TextBox Grid.Column="1" 
                     Text="{Binding Model.CurrentItem.NumberByMemo, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                     Style="{StaticResource AttributeTextBoxStyle}"/>
        </Grid>

        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

        <!-- Наименование заказа -->
        <Grid Style="{StaticResource AttributeRowStyle}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
            </Grid.ColumnDefinitions>
            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                <TextBlock Text="Наименование:" Style="{StaticResource AttributeLabelTextStyle}"/>
            </Border>
            <TextBox Grid.Column="1" 
                     Text="{Binding Model.CurrentItem.OrderName, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                     Style="{StaticResource AttributeTextBoxStyle}"/>
        </Grid>

        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

        <!-- Дата открытия -->
        <Grid Style="{StaticResource AttributeRowStyle}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
            </Grid.ColumnDefinitions>
            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                <TextBlock Text="Дата открытия:" Style="{StaticResource AttributeLabelTextStyle}"/>
            </Border>
            <TextBox Grid.Column="1" 
                     Text="{Binding Model.CurrentItem.OpenAtByMemo, Mode=TwoWay, UpdateSourceTrigger=LostFocus,
                            Converter={StaticResource MaskedDateConverter},
                            StringFormat='{}{0:dd.MM.yyyy}'}"
                     Style="{StaticResource AttributeTextBoxStyle}"/>
        </Grid>

        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

        <!-- Тип оснастки -->
        <Grid Style="{StaticResource AttributeRowStyle}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
            </Grid.ColumnDefinitions>
            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                <TextBlock Text="Тип оснастки:" Style="{StaticResource AttributeLabelTextStyle}"/>
            </Border>
            <!-- Исправленная привязка - напрямую к свойству ViewModel -->
            <ComboBox Grid.Column="1"
                      ItemsSource="{Binding EquipmentTypes}"
                      SelectedItem="{Binding Model.CurrentItem.EquipmentType, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                      Style="{StaticResource AttributeComboBoxStyle}">
                <ComboBox.ItemTemplate>
                    <DataTemplate>
                        <TextBlock Text="{Binding TypeName}"/>
                    </DataTemplate>
                </ComboBox.ItemTemplate>
            </ComboBox>
        </Grid>

        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

        <!-- Балансовый счет -->
        <Grid Style="{StaticResource AttributeRowStyle}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
            </Grid.ColumnDefinitions>
            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                <TextBlock Text="Балансовый счет:" Style="{StaticResource AttributeLabelTextStyle}"/>
            </Border>
            <TextBox Grid.Column="1" 
                     Text="{Binding Model.CurrentItem.Balance, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                     Style="{StaticResource AttributeTextBoxStyle}"/>
        </Grid>

        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

        <!-- Номенклатурная группа -->
        <Grid Style="{StaticResource AttributeRowStyle}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
            </Grid.ColumnDefinitions>
            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                <TextBlock Text="Номенклатурная группа:" Style="{StaticResource AttributeLabelTextStyle}"/>
            </Border>
            <ComboBox Grid.Column="1"
                      ItemsSource="{Binding NomenclatureGroups}"
                      SelectedItem="{Binding Model.CurrentItem.NomenclatureGroup, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                      Style="{StaticResource AttributeComboBoxStyle}">
            </ComboBox>
        </Grid>

        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

        <!-- Чертеж по служебной -->
        <Grid Style="{StaticResource AttributeRowStyle}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
            </Grid.ColumnDefinitions>
            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                <TextBlock Text="Чертеж:" Style="{StaticResource AttributeLabelTextStyle}"/>
            </Border>
            <TextBox Grid.Column="1" 
                     Text="{Binding Model.CurrentItem.DraftByMemo, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                     Style="{StaticResource AttributeTextBoxStyle}"/>
        </Grid>

        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

        <!-- Наименование чертежа по служебной -->
        <Grid Style="{StaticResource AttributeRowStyle}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
            </Grid.ColumnDefinitions>
            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                <TextBlock Text="Чертежное обозначение:" Style="{StaticResource AttributeLabelTextStyle}"/>
            </Border>
            <TextBox Grid.Column="1" 
                     Text="{Binding Model.CurrentItem.DraftNameByMemo, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                     Style="{StaticResource AttributeTextBoxStyle}"/>
        </Grid>

        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

        <!-- Склад по служебной -->
        <Grid Style="{StaticResource AttributeRowStyle}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
            </Grid.ColumnDefinitions>
            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                <TextBlock Text="Склад:" Style="{StaticResource AttributeLabelTextStyle}"/>
            </Border>
            <TextBox Grid.Column="1" 
                     Text="{Binding Model.CurrentItem.WorkshopByMemo, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                     Style="{StaticResource AttributeTextBoxStyle}"/>
        </Grid>

        <Separator Style="{StaticResource AttributeSeparatorStyle}"/>

        <!-- Количество по служебной -->
        <Grid Style="{StaticResource AttributeRowStyle}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Style="{StaticResource AttributeLabelColumnStyle}"/>
                <ColumnDefinition Style="{StaticResource AttributeValueColumnStyle}"/>
            </Grid.ColumnDefinitions>
            <Border Grid.Column="0" Style="{StaticResource AttributeLabelBorderStyle}">
                <TextBlock Text="Количество:" Style="{StaticResource AttributeLabelTextStyle}"/>
            </Border>
            <TextBox Grid.Column="1" 
                     Text="{Binding Model.CurrentItem.EquipmentRequiredQuantityByMemo, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                     Style="{StaticResource AttributeTextBoxStyle}"/>
        </Grid>
    </StackPanel>
</UserControl>